"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _react = _interopRequireWildcard(require("react"));

var _reactTinyVirtualList = _interopRequireDefault(require("@segment/react-tiny-virtual-list"));

var _downshift = _interopRequireDefault(require("downshift"));

var _fuzzaldrinPlus = _interopRequireDefault(require("fuzzaldrin-plus"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _constants = require("../../constants");

var _layers = require("../../layers");

var _popover = require("../../popover");

var _typography = require("../../typography");

var _AutocompleteItem = _interopRequireDefault(require("./AutocompleteItem"));

var _excluded = ["children", "itemSize", "position", "renderItem", "isFilterDisabled", "itemsFilter", "itemToString", "popoverMaxHeight", "popoverMinWidth", "allowOtherValues"],
    _excluded2 = ["getItemProps", "getMenuProps", "getRootProps", "highlightedIndex", "inputValue", "isOpen", "selectedItem"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var fuzzyFilter = function fuzzyFilter(itemToString) {
  if (itemToString) {
    return function (items, input) {
      var wrappedItems = items.map(function (item) {
        return {
          key: itemToString(item),
          item: item
        };
      });
      return _fuzzaldrinPlus["default"].filter(wrappedItems, input, {
        key: 'key'
      }).map(function (_ref) {
        var item = _ref.item;
        return item;
      });
    };
  }

  return function (items, input) {
    return _fuzzaldrinPlus["default"].filter(items, input);
  };
};

var noop = function noop() {};

var autocompleteItemRenderer = function autocompleteItemRenderer(props) {
  return /*#__PURE__*/_react["default"].createElement(_AutocompleteItem["default"], props);
};

autocompleteItemRenderer.displayName = "autocompleteItemRenderer";

/* eslint-disable react/prop-types */
var AutocompleteItems = function AutocompleteItems(_ref2) {
  var getItemProps = _ref2.getItemProps,
      getMenuProps = _ref2.getMenuProps,
      highlightedIndex = _ref2.highlightedIndex,
      inputValue = _ref2.inputValue,
      isFilterDisabled = _ref2.isFilterDisabled,
      itemSize = _ref2.itemSize,
      itemToString = _ref2.itemToString,
      itemsFilter = _ref2.itemsFilter,
      originalItems = _ref2.originalItems,
      popoverMaxHeight = _ref2.popoverMaxHeight,
      _renderItem = _ref2.renderItem,
      selectedItem = _ref2.selectedItem,
      title = _ref2.title,
      width = _ref2.width;
  itemsFilter = itemsFilter || fuzzyFilter(itemToString);
  var items = isFilterDisabled || inputValue.trim() === '' ? originalItems : itemsFilter(originalItems, inputValue);
  if (items.length === 0) return null; // Pass the actual DOM ref to downshift, this fixes touch support

  var menuProps = getMenuProps();
  return /*#__PURE__*/_react["default"].createElement(_layers.Pane, (0, _extends2["default"])({
    width: width
  }, menuProps), title && /*#__PURE__*/_react["default"].createElement(_layers.Pane, {
    padding: 8,
    borderBottom: "muted"
  }, /*#__PURE__*/_react["default"].createElement(_typography.Text, {
    size: 300,
    textTransform: "uppercase"
  }, title)), items.length > 0 && /*#__PURE__*/_react["default"].createElement(_reactTinyVirtualList["default"], {
    width: "100%",
    height: Math.min(items.length * itemSize, popoverMaxHeight),
    itemSize: itemSize,
    itemCount: items.length,
    scrollToIndex: highlightedIndex || 0,
    overscanCount: 3,
    scrollToAlignment: "auto",
    renderItem: function renderItem(_ref3) {
      var index = _ref3.index,
          style = _ref3.style;
      var item = items[index];
      var itemString = itemToString(item);
      return _renderItem(getItemProps({
        item: item,
        key: itemString,
        index: index,
        style: style,
        children: itemString,
        isSelected: itemToString(selectedItem) === itemString,
        isHighlighted: highlightedIndex === index
      }));
    }
  }));
};

AutocompleteItems.displayName = "AutocompleteItems";

/* eslint-enable react/prop-types */
var containerStyle = {
  width: '100%'
};
var Autocomplete = /*#__PURE__*/(0, _react.memo)( /*#__PURE__*/(0, _react.forwardRef)(function Autocomplete(props, ref) {
  var children = props.children,
      _props$itemSize = props.itemSize,
      itemSize = _props$itemSize === void 0 ? 32 : _props$itemSize,
      position = props.position,
      _props$renderItem = props.renderItem,
      renderItem = _props$renderItem === void 0 ? autocompleteItemRenderer : _props$renderItem,
      _props$isFilterDisabl = props.isFilterDisabled,
      isFilterDisabled = _props$isFilterDisabl === void 0 ? false : _props$isFilterDisabl,
      itemsFilter = props.itemsFilter,
      _props$itemToString = props.itemToString,
      itemToString = _props$itemToString === void 0 ? function (i) {
    return i ? String(i) : '';
  } : _props$itemToString,
      _props$popoverMaxHeig = props.popoverMaxHeight,
      popoverMaxHeight = _props$popoverMaxHeig === void 0 ? 240 : _props$popoverMaxHeig,
      _props$popoverMinWidt = props.popoverMinWidth,
      popoverMinWidth = _props$popoverMinWidt === void 0 ? 240 : _props$popoverMinWidt,
      allowOtherValues = props.allowOtherValues,
      restProps = (0, _objectWithoutProperties2["default"])(props, _excluded);

  var _useState = (0, _react.useState)(0),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      targetWidth = _useState2[0],
      setTargetWidth = _useState2[1];

  var _useState3 = (0, _react.useState)(),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      targetRef = _useState4[0],
      setTargetRef = _useState4[1];

  (0, _react.useEffect)(function () {
    if (targetRef) {
      setTargetWidth(targetRef.getBoundingClientRect().width);
    }
  }, [targetRef]);
  var stateReducer = (0, _react.useCallback)(function (state, changes) {
    if (Object.prototype.hasOwnProperty.call(changes, 'isOpen') && changes.isOpen) {
      return _objectSpread(_objectSpread({}, changes), {}, {
        highlightedIndex: props.items.indexOf(state.selectedItem)
      });
    }

    if (props.allowOtherValues && state.isOpen && !changes.isOpen) {
      return _objectSpread(_objectSpread({}, changes), {}, {
        selectedItem: changes.selectedItem || state.inputValue,
        inputValue: state.inputValue
      });
    }

    return changes;
  }, [props.items, props.allowOtherValues]);
  return /*#__PURE__*/_react["default"].createElement(_downshift["default"], (0, _extends2["default"])({
    stateReducer: stateReducer,
    scrollIntoView: noop,
    itemToString: itemToString,
    ref: ref
  }, restProps), function (_ref4) {
    var getItemProps = _ref4.getItemProps,
        getMenuProps = _ref4.getMenuProps,
        getRootProps = _ref4.getRootProps,
        highlightedIndex = _ref4.highlightedIndex,
        inputValue = _ref4.inputValue,
        isShown = _ref4.isOpen,
        selectedItem = _ref4.selectedItem,
        restDownshiftProps = (0, _objectWithoutProperties2["default"])(_ref4, _excluded2);
    return /*#__PURE__*/_react["default"].createElement("div", {
      style: containerStyle
    }, /*#__PURE__*/_react["default"].createElement(_popover.Popover, {
      bringFocusInside: false,
      isShown: isShown,
      minWidth: popoverMinWidth,
      position: position || (targetWidth < popoverMinWidth ? _constants.Position.BOTTOM_LEFT : _constants.Position.BOTTOM),
      content: /*#__PURE__*/_react["default"].createElement(AutocompleteItems, {
        getItemProps: getItemProps,
        getMenuProps: getMenuProps,
        highlightedIndex: highlightedIndex,
        inputValue: inputValue,
        isFilterDisabled: isFilterDisabled,
        itemsFilter: itemsFilter,
        itemSize: itemSize,
        itemToString: itemToString,
        originalItems: props.items,
        popoverMaxHeight: popoverMaxHeight,
        renderItem: renderItem,
        selectedItem: selectedItem,
        title: props.title,
        width: Math.max(targetWidth, popoverMinWidth)
      }),
      minHeight: 0,
      animationDuration: 0
    }, function (_ref5) {
      var _getRef = _ref5.getRef,
          isShownPopover = _ref5.isShown,
          toggle = _ref5.toggle;
      return children(_objectSpread({
        isShown: isShownPopover,
        toggle: toggle,
        getRef: function getRef(ref) {
          // Use the ref internally to determine the width
          setTargetRef(ref);

          _getRef(ref);
        },
        inputValue: inputValue,
        selectedItem: selectedItem,
        highlightedIndex: highlightedIndex
      }, restDownshiftProps));
    }));
  });
}));
Autocomplete.propTypes = _objectSpread({
  /**
   * This prop can be either a string or a Node.
   * It will provide a title for the items
   */
  title: _propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].node]),

  /**
   * An array of items to be used as options for the select
   */
  items: _propTypes["default"].array.isRequired,

  /**
   * The selected Item to be shown on the autocomplete
   */
  selectedItem: _propTypes["default"].any,

  /**
   * In case the array of items is not an array of strings,
   * this function is used on each item to return the string that will be shown on the filter
   */
  itemToString: _propTypes["default"].func,

  /**
   * Function that will render the 'filter' component.
   */
  children: _propTypes["default"].func.isRequired,

  /**
   * The height of each item in the list
   * Because the list is virtualized this is required beforehand.
   */
  itemSize: _propTypes["default"].number,

  /**
   * Function that returns a component to render the item
   */
  renderItem: _propTypes["default"].func,

  /**
   * The position of the Popover the Autocomplete is rendered in.
   */
  position: _propTypes["default"].oneOf([_constants.Position.TOP, _constants.Position.TOP_LEFT, _constants.Position.TOP_RIGHT, _constants.Position.BOTTOM, _constants.Position.BOTTOM_LEFT, _constants.Position.BOTTOM_RIGHT, _constants.Position.LEFT, _constants.Position.RIGHT]),

  /**
   * A function that is used to filter the items.
   * It should return a subset of the initial items.
   * By default the "fuzzaldrin-plus" package is used.
   */
  itemsFilter: _propTypes["default"].func,

  /**
   * Prop that enables and disables filtering
   * True: Enables Filtering
   * False: Disables Filtering
   */
  isFilterDisabled: _propTypes["default"].bool,

  /**
   * Defines the minimum height the results container will be
   */
  popoverMinWidth: _propTypes["default"].number,

  /**
   * Defines the maximum height the results container will be
   */
  popoverMaxHeight: _propTypes["default"].number,

  /**
   * Whether or not the input accepts arbitrary user input beyond the provided items
   */
  allowOtherValues: _propTypes["default"].bool
}, _downshift["default"].propTypes);
var _default = Autocomplete;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hdXRvY29tcGxldGUvc3JjL0F1dG9jb21wbGV0ZS5qcyJdLCJuYW1lcyI6WyJmdXp6eUZpbHRlciIsIml0ZW1Ub1N0cmluZyIsIml0ZW1zIiwiaW5wdXQiLCJ3cmFwcGVkSXRlbXMiLCJtYXAiLCJpdGVtIiwia2V5IiwiZnV6emFsZHJpbiIsImZpbHRlciIsIm5vb3AiLCJhdXRvY29tcGxldGVJdGVtUmVuZGVyZXIiLCJwcm9wcyIsIkF1dG9jb21wbGV0ZUl0ZW1zIiwiZ2V0SXRlbVByb3BzIiwiZ2V0TWVudVByb3BzIiwiaGlnaGxpZ2h0ZWRJbmRleCIsImlucHV0VmFsdWUiLCJpc0ZpbHRlckRpc2FibGVkIiwiaXRlbVNpemUiLCJpdGVtc0ZpbHRlciIsIm9yaWdpbmFsSXRlbXMiLCJwb3BvdmVyTWF4SGVpZ2h0IiwicmVuZGVySXRlbSIsInNlbGVjdGVkSXRlbSIsInRpdGxlIiwid2lkdGgiLCJ0cmltIiwibGVuZ3RoIiwibWVudVByb3BzIiwiTWF0aCIsIm1pbiIsImluZGV4Iiwic3R5bGUiLCJpdGVtU3RyaW5nIiwiY2hpbGRyZW4iLCJpc1NlbGVjdGVkIiwiaXNIaWdobGlnaHRlZCIsImNvbnRhaW5lclN0eWxlIiwiQXV0b2NvbXBsZXRlIiwicmVmIiwicG9zaXRpb24iLCJpIiwiU3RyaW5nIiwicG9wb3Zlck1pbldpZHRoIiwiYWxsb3dPdGhlclZhbHVlcyIsInJlc3RQcm9wcyIsInRhcmdldFdpZHRoIiwic2V0VGFyZ2V0V2lkdGgiLCJ0YXJnZXRSZWYiLCJzZXRUYXJnZXRSZWYiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJzdGF0ZVJlZHVjZXIiLCJzdGF0ZSIsImNoYW5nZXMiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJpc09wZW4iLCJpbmRleE9mIiwiZ2V0Um9vdFByb3BzIiwiaXNTaG93biIsInJlc3REb3duc2hpZnRQcm9wcyIsIlBvc2l0aW9uIiwiQk9UVE9NX0xFRlQiLCJCT1RUT00iLCJtYXgiLCJnZXRSZWYiLCJpc1Nob3duUG9wb3ZlciIsInRvZ2dsZSIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsIm9uZU9mVHlwZSIsInN0cmluZyIsIm5vZGUiLCJhcnJheSIsImlzUmVxdWlyZWQiLCJhbnkiLCJmdW5jIiwibnVtYmVyIiwib25lT2YiLCJUT1AiLCJUT1BfTEVGVCIsIlRPUF9SSUdIVCIsIkJPVFRPTV9SSUdIVCIsIkxFRlQiLCJSSUdIVCIsImJvb2wiLCJEb3duc2hpZnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7OztBQUVBLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUFDLFlBQVksRUFBSTtBQUNsQyxNQUFJQSxZQUFKLEVBQWtCO0FBQ2hCLFdBQU8sVUFBQ0MsS0FBRCxFQUFRQyxLQUFSLEVBQWtCO0FBQ3ZCLFVBQU1DLFlBQVksR0FBR0YsS0FBSyxDQUFDRyxHQUFOLENBQVUsVUFBQUMsSUFBSTtBQUFBLGVBQUs7QUFDdENDLFVBQUFBLEdBQUcsRUFBRU4sWUFBWSxDQUFDSyxJQUFELENBRHFCO0FBRXRDQSxVQUFBQSxJQUFJLEVBQUpBO0FBRnNDLFNBQUw7QUFBQSxPQUFkLENBQXJCO0FBS0EsYUFBT0UsMkJBQVdDLE1BQVgsQ0FBa0JMLFlBQWxCLEVBQWdDRCxLQUFoQyxFQUF1QztBQUFFSSxRQUFBQSxHQUFHLEVBQUU7QUFBUCxPQUF2QyxFQUF1REYsR0FBdkQsQ0FBMkQ7QUFBQSxZQUFHQyxJQUFILFFBQUdBLElBQUg7QUFBQSxlQUFjQSxJQUFkO0FBQUEsT0FBM0QsQ0FBUDtBQUNELEtBUEQ7QUFRRDs7QUFFRCxTQUFPLFVBQUNKLEtBQUQsRUFBUUMsS0FBUjtBQUFBLFdBQWtCSywyQkFBV0MsTUFBWCxDQUFrQlAsS0FBbEIsRUFBeUJDLEtBQXpCLENBQWxCO0FBQUEsR0FBUDtBQUNELENBYkQ7O0FB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ZmVjdCwgdXNlQ2FsbGJhY2sgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBWaXJ0dWFsTGlzdCBmcm9tICdAc2VnbWVudC9yZWFjdC10aW55LXZpcnR1YWwtbGlzdCdcbmltcG9ydCBEb3duc2hpZnQgZnJvbSAnZG93bnNoaWZ0J1xuaW1wb3J0IGZ1enphbGRyaW4gZnJvbSAnZnV6emFsZHJpbi1wbHVzJ1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IHsgUG9zaXRpb24gfSBmcm9tICcuLi8uLi9jb25zdGFudHMnXG5pbXBvcnQgeyBQYW5lIH0gZnJvbSAnLi4vLi4vbGF5ZXJzJ1xuaW1wb3J0IHsgUG9wb3ZlciB9IGZyb20gJy4uLy4uL3BvcG92ZXInXG5pbXBvcnQgeyBUZXh0IH0gZnJvbSAnLi4vLi4vdHlwb2dyYXBoeSdcbmltcG9ydCBBdXRvY29tcGxldGVJdGVtIGZyb20gJy4vQXV0b2NvbXBsZXRlSXRlbSdcblxuY29uc3QgZnV6enlGaWx0ZXIgPSBpdGVtVG9TdHJpbmcgPT4ge1xuICBpZiAoaXRlbVRvU3RyaW5nKSB7XG4gICAgcmV0dXJuIChpdGVtcywgaW5wdXQpID0+IHtcbiAgICAgIGNvbnN0IHdyYXBwZWRJdGVtcyA9IGl0ZW1zLm1hcChpdGVtID0+ICh7XG4gICAgICAgIGtleTogaXRlbVRvU3RyaW5nKGl0ZW0pLFxuICAgICAgICBpdGVtXG4gICAgICB9KSlcblxuICAgICAgcmV0dXJuIGZ1enphbGRyaW4uZmlsdGVyKHdyYXBwZWRJdGVtcywgaW5wdXQsIHsga2V5OiAna2V5JyB9KS5tYXAoKHsgaXRlbSB9KSA9PiBpdGVtKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiAoaXRlbXMsIGlucHV0KSA9PiBmdXp6YWxkcmluLmZpbHRlcihpdGVtcywgaW5wdXQpXG59XG5cbmNvbnN0IG5vb3AgPSAoKSA9PiB7fVxuXG5jb25zdCBhdXRvY29tcGxldGVJdGVtUmVuZGVyZXIgPSBwcm9wcyA9PiA8QXV0b2NvbXBsZXRlSXRlbSB7Li4ucHJvcHN9IC8+XG5cbi8qIGVzbGludC1kaXNhYmxlIHJlYWN0L3Byb3AtdHlwZXMgKi9cbmNvbnN0IEF1dG9jb21wbGV0ZUl0ZW1zID0gKHtcbiAgZ2V0SXRlbVByb3BzLFxuICBnZXRNZW51UHJvcHMsXG4gIGhpZ2hsaWdodGVkSW5kZXgsXG4gIGlucHV0VmFsdWUsXG4gIGlzRmlsdGVyRGlzYWJsZWQsXG4gIGl0ZW1TaXplLFxuICBpdGVtVG9TdHJpbmcsXG4gIGl0ZW1zRmlsdGVyLFxuICBvcmlnaW5hbEl0ZW1zLFxuICBwb3BvdmVyTWF4SGVpZ2h0LFxuICByZW5kZXJJdGVtLFxuICBzZWxlY3RlZEl0ZW0sXG4gIHRpdGxlLFxuICB3aWR0aFxufSkgPT4ge1xuICBpdGVtc0ZpbHRlciA9IGl0ZW1zRmlsdGVyIHx8IGZ1enp5RmlsdGVyKGl0ZW1Ub1N0cmluZylcbiAgY29uc3QgaXRlbXMgPSBpc0ZpbHRlckRpc2FibGVkIHx8IGlucHV0VmFsdWUudHJpbSgpID09PSAnJyA/IG9yaWdpbmFsSXRlbXMgOiBpdGVtc0ZpbHRlcihvcmlnaW5hbEl0ZW1zLCBpbnB1dFZhbHVlKVxuXG4gIGlmIChpdGVtcy5sZW5ndGggPT09IDApIHJldHVybiBudWxsXG5cbiAgLy8gUGFzcyB0aGUgYWN0dWFsIERPTSByZWYgdG8gZG93bnNoaWZ0LCB0aGlzIGZpeGVzIHRvdWNoIHN1cHBvcnRcbiAgY29uc3QgbWVudVByb3BzID0gZ2V0TWVudVByb3BzKClcblxuICByZXR1cm4gKFxuICAgIDxQYW5lIHdpZHRoPXt3aWR0aH0gey4uLm1lbnVQcm9wc30+XG4gICAgICB7dGl0bGUgJiYgKFxuICAgICAgICA8UGFuZSBwYWRkaW5nPXs4fSBib3JkZXJCb3R0b209XCJtdXRlZFwiPlxuICAgICAgICAgIDxUZXh0IHNpemU9ezMwMH0gdGV4dFRyYW5zZm9ybT1cInVwcGVyY2FzZVwiPlxuICAgICAgICAgICAge3RpdGxlfVxuICAgICAgICAgIDwvVGV4dD5cbiAgICAgICAgPC9QYW5lPlxuICAgICAgKX1cbiAgICAgIHtpdGVtcy5sZW5ndGggPiAwICYmIChcbiAgICAgICAgPFZpcnR1YWxMaXN0XG4gICAgICAgICAgd2lkdGg9XCIxMDAlXCJcbiAgICAgICAgICBoZWlnaHQ9e01hdGgubWluKGl0ZW1zLmxlbmd0aCAqIGl0ZW1TaXplLCBwb3BvdmVyTWF4SGVpZ2h0KX1cbiAgICAgICAgICBpdGVtU2l6ZT17aXRlbVNpemV9XG4gICAgICAgICAgaXRlbUNvdW50PXtpdGVtcy5sZW5ndGh9XG4gICAgICAgICAgc2Nyb2xsVG9JbmRleD17aGlnaGxpZ2h0ZWRJbmRleCB8fCAwfVxuICAgICAgICAgIG92ZXJzY2FuQ291bnQ9ezN9XG4gICAgICAgICAgc2Nyb2xsVG9BbGlnbm1lbnQ9XCJhdXRvXCJcbiAgICAgICAgICByZW5kZXJJdGVtPXsoeyBpbmRleCwgc3R5bGUgfSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaXRlbSA9IGl0ZW1zW2luZGV4XVxuICAgICAgICAgICAgY29uc3QgaXRlbVN0cmluZyA9IGl0ZW1Ub1N0cmluZyhpdGVtKVxuXG4gICAgICAgICAgICByZXR1cm4gcmVuZGVySXRlbShcbiAgICAgICAgICAgICAgZ2V0SXRlbVByb3BzKHtcbiAgICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICAgIGtleTogaXRlbVN0cmluZyxcbiAgICAgICAgICAgICAgICBpbmRleCxcbiAgICAgICAgICAgICAgICBzdHlsZSxcbiAgICAgICAgICAgICAgICBjaGlsZHJlbjogaXRlbVN0cmluZyxcbiAgICAgICAgICAgICAgICBpc1NlbGVjdGVkOiBpdGVtVG9TdHJpbmcoc2VsZWN0ZWRJdGVtKSA9PT0gaXRlbVN0cmluZyxcbiAgICAgICAgICAgICAgICBpc0hpZ2hsaWdodGVkOiBoaWdobGlnaHRlZEluZGV4ID09PSBpbmRleFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIH19XG4gICAgICAgIC8+XG4gICAgICApfVxuICAgIDwvUGFuZT5cbiAgKVxufVxuLyogZXNsaW50LWVuYWJsZSByZWFjdC9wcm9wLXR5cGVzICovXG5cbmNvbnN0IGNvbnRhaW5lclN0eWxlID0geyB3aWR0aDogJzEwMCUnIH1cblxuY29uc3QgQXV0b2NvbXBsZXRlID0gbWVtbyhcbiAgZm9yd2FyZFJlZihmdW5jdGlvbiBBdXRvY29tcGxldGUocHJvcHMsIHJlZikge1xuICAgIGNvbnN0IHtcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgaXRlbVNpemUgPSAzMixcbiAgICAgIHBvc2l0aW9uLFxuICAgICAgcmVuZGVySXRlbSA9IGF1dG9jb21wbGV0ZUl0ZW1SZW5kZXJlcixcbiAgICAgIGlzRmlsdGVyRGlzYWJsZWQgPSBmYWxzZSxcbiAgICAgIGl0ZW1zRmlsdGVyLFxuICAgICAgaXRlbVRvU3RyaW5nID0gaSA9PiAoaSA/IFN0cmluZyhpKSA6ICcnKSxcbiAgICAgIHBvcG92ZXJNYXhIZWlnaHQgPSAyNDAsXG4gICAgICBwb3BvdmVyTWluV2lkdGggPSAyNDAsXG4gICAgICBhbGxvd090aGVyVmFsdWVzLFxuICAgICAgLi4ucmVzdFByb3BzXG4gICAgfSA9IHByb3BzXG5cbiAgICBjb25zdCBbdGFyZ2V0V2lkdGgsIHNldFRhcmdldFdpZHRoXSA9IHVzZVN0YXRlKDApXG4gICAgY29uc3QgW3RhcmdldFJlZiwgc2V0VGFyZ2V0UmVmXSA9IHVzZVN0YXRlKClcblxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgICBpZiAodGFyZ2V0UmVmKSB7XG4gICAgICAgIHNldFRhcmdldFdpZHRoKHRhcmdldFJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS53aWR0aClcbiAgICAgIH1cbiAgICB9LCBbdGFyZ2V0UmVmXSlcblxuICAgIGNvbnN0IHN0YXRlUmVkdWNlciA9IHVzZUNhbGxiYWNrKFxuICAgICAgKHN0YXRlLCBjaGFuZ2VzKSA9PiB7XG4gICAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoY2hhbmdlcywgJ2lzT3BlbicpICYmIGNoYW5nZXMuaXNPcGVuKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmNoYW5nZXMsXG4gICAgICAgICAgICBoaWdobGlnaHRlZEluZGV4OiBwcm9wcy5pdGVtcy5pbmRleE9mKHN0YXRlLnNlbGVjdGVkSXRlbSlcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocHJvcHMuYWxsb3dPdGhlclZhbHVlcyAmJiBzdGF0ZS5pc09wZW4gJiYgIWNoYW5nZXMuaXNPcGVuKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLmNoYW5nZXMsXG4gICAgICAgICAgICBzZWxlY3RlZEl0ZW06IGNoYW5nZXMuc2VsZWN0ZWRJdGVtIHx8IHN0YXRlLmlucHV0VmFsdWUsXG4gICAgICAgICAgICBpbnB1dFZhbHVlOiBzdGF0ZS5pbnB1dFZhbHVlXG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNoYW5nZXNcbiAgICAgIH0sXG4gICAgICBbcHJvcHMuaXRlbXMsIHByb3BzLmFsbG93T3RoZXJWYWx1ZXNdXG4gICAgKVxuXG4gICAgcmV0dXJuIChcbiAgICAgIDxEb3duc2hpZnQgc3RhdGVSZWR1Y2VyPXtzdGF0ZVJlZHVjZXJ9IHNjcm9sbEludG9WaWV3PXtub29wfSBpdGVtVG9TdHJpbmc9e2l0ZW1Ub1N0cmluZ30gcmVmPXtyZWZ9IHsuLi5yZXN0UHJvcHN9PlxuICAgICAgICB7KHtcbiAgICAgICAgICBnZXRJdGVtUHJvcHMsXG4gICAgICAgICAgZ2V0TWVudVByb3BzLFxuICAgICAgICAgIGdldFJvb3RQcm9wcyxcbiAgICAgICAgICBoaWdobGlnaHRlZEluZGV4LFxuICAgICAgICAgIGlucHV0VmFsdWUsXG4gICAgICAgICAgaXNPcGVuOiBpc1Nob3duLFxuICAgICAgICAgIHNlbGVjdGVkSXRlbSxcbiAgICAgICAgICAuLi5yZXN0RG93bnNoaWZ0UHJvcHNcbiAgICAgICAgfSkgPT4gKFxuICAgICAgICAgIDxkaXYgc3R5bGU9e2NvbnRhaW5lclN0eWxlfT5cbiAgICAgICAgICAgIDxQb3BvdmVyXG4gICAgICAgICAgICAgIGJyaW5nRm9jdXNJbnNpZGU9e2ZhbHNlfVxuICAgICAgICAgICAgICBpc1Nob3duPXtpc1Nob3dufVxuICAgICAgICAgICAgICBtaW5XaWR0aD17cG9wb3Zlck1pbldpZHRofVxuICAgICAgICAgICAgICBwb3NpdGlvbj17cG9zaXRpb24gfHwgKHRhcmdldFdpZHRoIDwgcG9wb3Zlck1pbldpZHRoID8gUG9zaXRpb24uQk9UVE9NX0xFRlQgOiBQb3NpdGlvbi5CT1RUT00pfVxuICAgICAgICAgICAgICBjb250ZW50PXtcbiAgICAgICAgICAgICAgICA8QXV0b2NvbXBsZXRlSXRlbXNcbiAgICAgICAgICAgICAgICAgIGdldEl0ZW1Qcm9wcz17Z2V0SXRlbVByb3BzfVxuICAgICAgICAgICAgICAgICAgZ2V0TWVudVByb3BzPXtnZXRNZW51UHJvcHN9XG4gICAgICAgICAgICAgICAgICBoaWdobGlnaHRlZEluZGV4PXtoaWdobGlnaHRlZEluZGV4fVxuICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZT17aW5wdXRWYWx1ZX1cbiAgICAgICAgICAgICAgICAgIGlzRmlsdGVyRGlzYWJsZWQ9e2lzRmlsdGVyRGlzYWJsZWR9XG4gICAgICAgICAgICAgICAgICBpdGVtc0ZpbHRlcj17aXRlbXNGaWx0ZXJ9XG4gICAgICAgICAgICAgICAgICBpdGVtU2l6ZT17aXRlbVNpemV9XG4gICAgICAgICAgICAgICAgICBpdGVtVG9TdHJpbmc9e2l0ZW1Ub1N0cmluZ31cbiAgICAgICAgICAgICAgICAgIG9yaWdpbmFsSXRlbXM9e3Byb3BzLml0ZW1zfVxuICAgICAgICAgICAgICAgICAgcG9wb3Zlck1heEhlaWdodD17cG9wb3Zlck1heEhlaWdodH1cbiAgICAgICAgICAgICAgICAgIHJlbmRlckl0ZW09e3JlbmRlckl0ZW19XG4gICAgICAgICAgICAgICAgICBzZWxlY3RlZEl0ZW09e3NlbGVjdGVkSXRlbX1cbiAgICAgICAgICAgICAgICAgIHRpdGxlPXtwcm9wcy50aXRsZX1cbiAgICAgICAgICAgICAgICAgIHdpZHRoPXtNYXRoLm1heCh0YXJnZXRXaWR0aCwgcG9wb3Zlck1pbldpZHRoKX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIG1pbkhlaWdodD17MH1cbiAgICAgICAgICAgICAgYW5pbWF0aW9uRHVyYXRpb249ezB9XG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIHsoeyBnZXRSZWYsIGlzU2hvd246IGlzU2hvd25Qb3BvdmVyLCB0b2dnbGUgfSkgPT5cbiAgICAgICAgICAgICAgICBjaGlsZHJlbih7XG4gICAgICAgICAgICAgICAgICBpc1Nob3duOiBpc1Nob3duUG9wb3ZlcixcbiAgICAgICAgICAgICAgICAgIHRvZ2dsZSxcbiAgICAgICAgICAgICAgICAgIGdldFJlZjogcmVmID0+IHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVXNlIHRoZSByZWYgaW50ZXJuYWxseSB0byBkZXRlcm1pbmUgdGhlIHdpZHRoXG4gICAgICAgICAgICAgICAgICAgIHNldFRhcmdldFJlZihyZWYpXG4gICAgICAgICAgICAgICAgICAgIGdldFJlZihyZWYpXG4gICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbSxcbiAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkSW5kZXgsXG4gICAgICAgICAgICAgICAgICAuLi5yZXN0RG93bnNoaWZ0UHJvcHNcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICA8L1BvcG92ZXI+XG4gICAgICAgICAgPC9kaXY+XG4gICAgICAgICl9XG4gICAgICA8L0Rvd25zaGlmdD5cbiAgICApXG4gIH0pXG4pXG5cbkF1dG9jb21wbGV0ZS5wcm9wVHlwZXMgPSB7XG4gIC8qKlxuICAgKiBUaGlzIHByb3AgY2FuIGJlIGVpdGhlciBhIHN0cmluZyBvciBhIE5vZGUuXG4gICAqIEl0IHdpbGwgcHJvdmlkZSBhIHRpdGxlIGZvciB0aGUgaXRlbXNcbiAgICovXG4gIHRpdGxlOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMubm9kZV0pLFxuXG4gIC8qKlxuICAgKiBBbiBhcnJheSBvZiBpdGVtcyB0byBiZSB1c2VkIGFzIG9wdGlvbnMgZm9yIHRoZSBzZWxlY3RcbiAgICovXG4gIGl0ZW1zOiBQcm9wVHlwZXMuYXJyYXkuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogVGhlIHNlbGVjdGVkIEl0ZW0gdG8gYmUgc2hvd24gb24gdGhlIGF1dG9jb21wbGV0ZVxuICAgKi9cbiAgc2VsZWN0ZWRJdGVtOiBQcm9wVHlwZXMuYW55LFxuXG4gIC8qKlxuICAgKiBJbiBjYXNlIHRoZSBhcnJheSBvZiBpdGVtcyBpcyBub3QgYW4gYXJyYXkgb2Ygc3RyaW5ncyxcbiAgICogdGhpcyBmdW5jdGlvbiBpcyB1c2VkIG9uIGVhY2ggaXRlbSB0byByZXR1cm4gdGhlIHN0cmluZyB0aGF0IHdpbGwgYmUgc2hvd24gb24gdGhlIGZpbHRlclxuICAgKi9cbiAgaXRlbVRvU3RyaW5nOiBQcm9wVHlwZXMuZnVuYyxcblxuICAvKipcbiAgICogRnVuY3Rpb24gdGhhdCB3aWxsIHJlbmRlciB0aGUgJ2ZpbHRlcicgY29tcG9uZW50LlxuICAgKi9cbiAgY2hpbGRyZW46IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIFRoZSBoZWlnaHQgb2YgZWFjaCBpdGVtIGluIHRoZSBsaXN0XG4gICAqIEJlY2F1c2UgdGhlIGxpc3QgaXMgdmlydHVhbGl6ZWQgdGhpcyBpcyByZXF1aXJlZCBiZWZvcmVoYW5kLlxuICAgKi9cbiAgaXRlbVNpemU6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHRoYXQgcmV0dXJucyBhIGNvbXBvbmVudCB0byByZW5kZXIgdGhlIGl0ZW1cbiAgICovXG4gIHJlbmRlckl0ZW06IFByb3BUeXBlcy5mdW5jLFxuXG4gIC8qKlxuICAgKiBUaGUgcG9zaXRpb24gb2YgdGhlIFBvcG92ZXIgdGhlIEF1dG9jb21wbGV0ZSBpcyByZW5kZXJlZCBpbi5cbiAgICovXG4gIHBvc2l0aW9uOiBQcm9wVHlwZXMub25lT2YoW1xuICAgIFBvc2l0aW9uLlRPUCxcbiAgICBQb3NpdGlvbi5UT1BfTEVGVCxcbiAgICBQb3NpdGlvbi5UT1BfUklHSFQsXG4gICAgUG9zaXRpb24uQk9UVE9NLFxuICAgIFBvc2l0aW9uLkJPVFRPTV9MRUZULFxuICAgIFBvc2l0aW9uLkJPVFRPTV9SSUdIVCxcbiAgICBQb3NpdGlvbi5MRUZULFxuICAgIFBvc2l0aW9uLlJJR0hUXG4gIF0pLFxuXG4gIC8qKlxuICAgKiBBIGZ1bmN0aW9uIHRoYXQgaXMgdXNlZCB0byBmaWx0ZXIgdGhlIGl0ZW1zLlxuICAgKiBJdCBzaG91bGQgcmV0dXJuIGEgc3Vic2V0IG9mIHRoZSBpbml0aWFsIGl0ZW1zLlxuICAgKiBCeSBkZWZhdWx0IHRoZSBcImZ1enphbGRyaW4tcGx1c1wiIHBhY2thZ2UgaXMgdXNlZC5cbiAgICovXG4gIGl0ZW1zRmlsdGVyOiBQcm9wVHlwZXMuZnVuYyxcblxuICAvKipcbiAgICogUHJvcCB0aGF0IGVuYWJsZXMgYW5kIGRpc2FibGVzIGZpbHRlcmluZ1xuICAgKiBUcnVlOiBFbmFibGVzIEZpbHRlcmluZ1xuICAgKiBGYWxzZTogRGlzYWJsZXMgRmlsdGVyaW5nXG4gICAqL1xuICBpc0ZpbHRlckRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCxcblxuICAvKipcbiAgICogRGVmaW5lcyB0aGUgbWluaW11bSBoZWlnaHQgdGhlIHJlc3VsdHMgY29udGFpbmVyIHdpbGwgYmVcbiAgICovXG4gIHBvcG92ZXJNaW5XaWR0aDogUHJvcFR5cGVzLm51bWJlcixcblxuICAvKipcbiAgICogRGVmaW5lcyB0aGUgbWF4aW11bSBoZWlnaHQgdGhlIHJlc3VsdHMgY29udGFpbmVyIHdpbGwgYmVcbiAgICovXG4gIHBvcG92ZXJNYXhIZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRoZSBpbnB1dCBhY2NlcHRzIGFyYml0cmFyeSB1c2VyIGlucHV0IGJleW9uZCB0aGUgcHJvdmlkZWQgaXRlbXNcbiAgICovXG4gIGFsbG93T3RoZXJWYWx1ZXM6IFByb3BUeXBlcy5ib29sLFxuXG4gIC4uLkRvd25zaGlmdC5wcm9wVHlwZXNcbn1cblxuZXhwb3J0IGRlZmF1bHQgQXV0b2NvbXBsZXRlXG4iXX0=