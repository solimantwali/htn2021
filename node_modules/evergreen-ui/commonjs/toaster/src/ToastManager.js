"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _glamor = require("glamor");

var _propTypes = _interopRequireDefault(require("prop-types"));

var _constants = require("../../constants");

var _Toast = _interopRequireDefault(require("./Toast"));

var _excluded = ["description", "id"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2["default"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

var wrapperClass = (0, _glamor.css)({
  maxWidth: 560,
  margin: '0 auto',
  top: 0,
  left: 0,
  right: 0,
  position: 'fixed',
  zIndex: _constants.StackingOrder.TOASTER,
  pointerEvents: 'none'
});

var hasCustomId = function hasCustomId(settings) {
  return Object.hasOwnProperty.call(settings, 'id');
};

var ToastManager = /*#__PURE__*/(0, _react.memo)(function ToastManager(props) {
  var bindCloseAll = props.bindCloseAll,
      bindGetToasts = props.bindGetToasts,
      bindNotify = props.bindNotify,
      bindRemove = props.bindRemove;

  var _useState = (0, _react.useState)([]),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      toasts = _useState2[0],
      setToasts = _useState2[1];

  var _useState3 = (0, _react.useState)(0),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      idCounter = _useState4[0],
      setIdCounter = _useState4[1];

  var getToasts = function getToasts() {
    return toasts;
  };

  var closeAll = function closeAll() {
    setToasts(toasts.map(function (toast) {
      return _objectSpread(_objectSpread({}, toast), {}, {
        isShown: false
      });
    }));
  };
  /**
   * This will set isShown on the Toast which will close the toast.
   * It won't remove the toast until onExited triggers onRemove.
   */


  var closeToast = function closeToast(id) {
    setToasts(toasts.map(function (toast) {
      if (toast.id === id) {
        return _objectSpread(_objectSpread({}, toast), {}, {
          isShown: false
        });
      }

      return toast;
    }));
  };

  var safeCloseToast = function safeCloseToast(id) {
    var toastToRemove = toasts.find(function (toast) {
      return String(toast.id).startsWith(id);
    });

    if (toastToRemove) {
      closeToast(toastToRemove.id);
    }
  };

  var removeToast = function removeToast(id) {
    var updatedToasts = toasts.filter(function (toast) {
      return !String(toast.id).startsWith(id);
    });
    setToasts(updatedToasts);
    return updatedToasts;
  };

  var createToastInstance = function createToastInstance(title, settings) {
    var uniqueId = idCounter;
    setIdCounter(idCounter + 1);
    var id = hasCustomId(settings) ? "".concat(settings.id, "-").concat(uniqueId) : uniqueId;
    return {
      id: id,
      title: title,
      description: settings.description,
      hasCloseButton: settings.hasCloseButton || true,
      duration: settings.duration || 5,
      close: function close() {
        return safeCloseToast(id);
      },
      intent: settings.intent
    };
  };

  var notify = function notify(title, settings) {
    var tempToasts = toasts;

    if (hasCustomId(settings)) {
      tempToasts = removeToast(settings.id);
    }

    var instance = createToastInstance(title, settings);
    setToasts([instance].concat((0, _toConsumableArray2["default"])(tempToasts)));
  };

  bindNotify(notify);
  bindRemove(safeCloseToast);
  bindGetToasts(getToasts);
  bindCloseAll(closeAll);
  return /*#__PURE__*/_react["default"].createElement("span", {
    className: wrapperClass
  }, toasts.map(function (_ref) {
    var description = _ref.description,
        id = _ref.id,
        rest = (0, _objectWithoutProperties2["default"])(_ref, _excluded);
    return /*#__PURE__*/_react["default"].createElement(_Toast["default"], (0, _extends2["default"])({
      key: id,
      onRemove: function onRemove() {
        return removeToast(id);
      }
    }, rest), description);
  }));
});
ToastManager.propTypes = {
  /**
   * Function called with the `this.notify` function.
   */
  bindNotify: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.remove` function.
   */
  bindRemove: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.getToasts` function.
   */
  bindGetToasts: _propTypes["default"].func.isRequired,

  /**
   * Function called with the `this.closeAll` function.
   */
  bindCloseAll: _propTypes["default"].func.isRequired
};
var _default = ToastManager;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90b2FzdGVyL3NyYy9Ub2FzdE1hbmFnZXIuanMiXSwibmFtZXMiOlsid3JhcHBlckNsYXNzIiwibWF4V2lkdGgiLCJtYXJnaW4iLCJ0b3AiLCJsZWZ0IiwicmlnaHQiLCJwb3NpdGlvbiIsInpJbmRleCIsIlN0YWNraW5nT3JkZXIiLCJUT0FTVEVSIiwicG9pbnRlckV2ZW50cyIsImhhc0N1c3RvbUlkIiwic2V0dGluZ3MiLCJPYmplY3QiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJUb2FzdE1hbmFnZXIiLCJwcm9wcyIsImJpbmRDbG9zZUFsbCIsImJpbmRHZXRUb2FzdHMiLCJiaW5kTm90aWZ5IiwiYmluZFJlbW92ZSIsInRvYXN0cyIsInNldFRvYXN0cyIsImlkQ291bnRlciIsInNldElkQ291bnRlciIsImdldFRvYXN0cyIsImNsb3NlQWxsIiwibWFwIiwidG9hc3QiLCJpc1Nob3duIiwiY2xvc2VUb2FzdCIsImlkIiwic2FmZUNsb3NlVG9hc3QiLCJ0b2FzdFRvUmVtb3ZlIiwiZmluZCIsIlN0cmluZyIsInN0YXJ0c1dpdGgiLCJyZW1vdmVUb2FzdCIsInVwZGF0ZWRUb2FzdHMiLCJmaWx0ZXIiLCJjcmVhdGVUb2FzdEluc3RhbmNlIiwidGl0bGUiLCJ1bmlxdWVJZCIsImRlc2NyaXB0aW9uIiwiaGFzQ2xvc2VCdXR0b24iLCJkdXJhdGlvbiIsImNsb3NlIiwiaW50ZW50Iiwibm90aWZ5IiwidGVtcFRvYXN0cyIsImluc3RhbmNlIiwicmVzdCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImZ1bmMiLCJpc1JlcXVpcmVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsWUFBWSxHQUFHLGlCQUFJO0FBQ3ZCQyxFQUFBQSxRQUFRLEVBQUUsR0FEYTtBQUV2QkMsRUFBQUEsTUFBTSxFQUFFLFFBRmU7QUFHdkJDLEVBQUFBLEdBQUcsRUFBRSxDQUhrQjtBQUl2QkMsRUFBQUEsSUFBSSxFQUFFLENBSmlCO0FBS3ZCQyxFQUFBQSxLQUFLLEVBQUUsQ0FMZ0I7QUFNdkJDLEVBQUFBLFFBQVEsRUFBRSxPQU5hO0FBT3ZCQyxFQUFBQSxNQUFNLEVBQUVDLHlCQUFjQyxPQVBDO0FBUXZCQyxFQUFBQSxhQUFhLEVBQUU7QUFSUSxDQUFKLENBQXJCOztBQVdBLElBQU1DLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUFDLFFBQVE7QUFBQSxTQUFJQyxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLElBQXRCLENBQTJCSCxRQUEzQixFQUFxQyxJQUFyQyxDQUFKO0FBQUEsQ0FBNUI7O0FBRUEsSUFBTUksWUFBWSxnQkFBRyxpQkFBSyxTQUFTQSxZQUFULENBQXNCQyxLQUF0QixFQUE2QjtBQUNyRCxNQUFRQyxZQUFSLEdBQWdFRCxLQUFoRSxDQUFRQyxZQUFSO0FBQUEsTUFBc0JDLGFBQXRCLEdBQWdFRixLQUFoRSxDQUFzQkUsYUFBdEI7QUFBQSxNQUFxQ0MsVUFBckMsR0FBZ0VILEtBQWhFLENBQXFDRyxVQUFyQztBQUFBLE1BQWlEQyxVQUFqRCxHQUFnRUosS0FBaEUsQ0FBaURJLFVBQWpEOztBQUVBLGtCQUE0QixxQkFBUyxFQUFULENBQTVCO0FBQUE7QUFBQSxNQUFPQyxNQUFQO0FBQUEsTUFBZUMsU0FBZjs7QUFDQSxtQkFBa0MscUJBQVMsQ0FBVCxDQUFsQztBQUFBO0FBQUEsTUFBT0MsU0FBUDtBQUFBLE1BQWtCQyxZQUFsQjs7QUFFQSxNQUFNQyxTQUFTLEdBQUcsU0FBWkEsU0FBWTtBQUFBLFdBQU1KLE1BQU47QUFBQSxHQUFsQjs7QUFFQSxNQUFNSyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxHQUFNO0FBQ3JCSixJQUFBQSxTQUFTLENBQUNELE1BQU0sQ0FBQ00sR0FBUCxDQUFXLFVBQUFDLEtBQUs7QUFBQSw2Q0FBVUEsS0FBVjtBQUFpQkMsUUFBQUEsT0FBTyxFQUFFO0FBQTFCO0FBQUEsS0FBaEIsQ0FBRCxDQUFUO0FBQ0QsR0FGRDtBQUlBO0FBQ0Y7QUFDQTtBQUNBOzs7QUFDRSxNQUFNQyxVQUFVLEdBQUcsU0FBYkEsVUFBYSxDQUFBQyxFQUFFLEVBQUk7QUFDdkJULElBQUFBLFNBQVMsQ0FDUEQsTUFBTSxDQUFDTSxHQUFQLENBQVcsVUFBQUMsS0FBSyxFQUFJO0FBQ2xCLFVBQUlBLEtBQUssQ0FBQ0csRUFBTixLQUFhQSxFQUFqQixFQUFxQjtBQUNuQiwrQ0FDS0gsS0FETDtBQUVFQyxVQUFBQSxPQUFPLEVBQUU7QUFGWDtBQUlEOztBQUVELGFBQU9ELEtBQVA7QUFDRCxLQVRELENBRE8sQ0FBVDtBQVlELEdBYkQ7O0FBZUEsTUFBTUksY0FBYyxHQUFHLFNBQWpCQSxjQUFpQixDQUFBRCxFQUFFLEVBQUk7QUFDM0IsUUFBTUUsYUFBYSxHQUFHWixNQUFNLENBQUNhLElBQVAsQ0FBWSxVQUFBTixLQUFLO0FBQUEsYUFBSU8sTUFBTSxDQUFDUCxLQUFLLENBQUNHLEVBQVAsQ0FBTixDQUFpQkssVUFBakIsQ0FBNEJMLEVBQTVCLENBQUo7QUFBQSxLQUFqQixDQUF0Qjs7QUFFQSxRQUFJRSxhQUFKLEVBQW1CO0FBQ2pCSCxNQUFBQSxVQUFVLENBQUNHLGFBQWEsQ0FBQ0YsRUFBZixDQUFWO0FBQ0Q7QUFDRixHQU5EOztBQVFBLE1BQU1NLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUFOLEVBQUUsRUFBSTtBQUN4QixRQUFNTyxhQUFhLEdBQUdqQixNQUFNLENBQUNrQixNQUFQLENBQWMsVUFBQVgsS0FBSztBQUFBLGFBQUksQ0FBQ08sTUFBTSxDQUFDUCxLQUFLLENBQUNHLEVBQVAsQ0FBTixDQUFpQkssVUFBakIsQ0FBNEJMLEVBQTVCLENBQUw7QUFBQSxLQUFuQixDQUF0QjtBQUNBVCxJQUFBQSxTQUFTLENBQUNnQixhQUFELENBQVQ7QUFDQSxXQUFPQSxhQUFQO0FBQ0QsR0FKRDs7QUFNQSxNQUFNRSxtQkFBbUIsR0FBRyxTQUF0QkEsbUJBQXNCLENBQUNDLEtBQUQsRUFBUTlCLFFBQVIsRUFBcUI7QUFDL0MsUUFBTStCLFFBQVEsR0FBR25CLFNBQWpCO0FBQ0FDLElBQUFBLFlBQVksQ0FBQ0QsU0FBUyxHQUFHLENBQWIsQ0FBWjtBQUNBLFFBQU1RLEVBQUUsR0FBR3JCLFdBQVcsQ0FBQ0MsUUFBRCxDQUFYLGFBQTJCQSxRQUFRLENBQUNvQixFQUFwQyxjQUEwQ1csUUFBMUMsSUFBdURBLFFBQWxFO0FBRUEsV0FBTztBQUNMWCxNQUFBQSxFQUFFLEVBQUZBLEVBREs7QUFFTFUsTUFBQUEsS0FBSyxFQUFMQSxLQUZLO0FBR0xFLE1BQUFBLFdBQVcsRUFBRWhDLFFBQVEsQ0FBQ2dDLFdBSGpCO0FBSUxDLE1BQUFBLGNBQWMsRUFBRWpDLFFBQVEsQ0FBQ2lDLGNBQVQsSUFBMkIsSUFKdEM7QUFLTEMsTUFBQUEsUUFBUSxFQUFFbEMsUUFBUSxDQUFDa0MsUUFBVCxJQUFxQixDQUwxQjtBQU1MQyxNQUFBQSxLQUFLLEVBQUU7QUFBQSxlQUFNZCxjQUFjLENBQUNELEVBQUQsQ0FBcEI7QUFBQSxPQU5GO0FBT0xnQixNQUFBQSxNQUFNLEVBQUVwQyxRQUFRLENBQUNvQztBQVBaLEtBQVA7QUFTRCxHQWREOztBQWdCQSxNQUFNQyxNQUFNLEdBQUcsU0FBVEEsTUFBUyxDQUFDUCxLQUFELEVBQVE5QixRQUFSLEVBQXFCO0FBQ2xDLFFBQUlzQyxVQUFVLEdBQUc1QixNQUFqQjs7QUFDQSxRQUFJWCxXQUFXLENBQUNDLFFBQUQsQ0FBZixFQUEyQjtBQUN6QnNDLE1BQUFBLFVBQVUsR0FBR1osV0FBVyxDQUFDMUIsUUFBUSxDQUFDb0IsRUFBVixDQUF4QjtBQUNEOztBQUVELFFBQU1tQixRQUFRLEdBQUdWLG1CQUFtQixDQUFDQyxLQUFELEVBQVE5QixRQUFSLENBQXBDO0FBQ0FXLElBQUFBLFNBQVMsRUFBRTRCLFFBQUYsNkNBQWVELFVBQWYsR0FBVDtBQUNELEdBUkQ7O0FBVUE5QixFQUFBQSxVQUFVLENBQUM2QixNQUFELENBQVY7QUFDQTVCLEVBQUFBLFVBQVUsQ0FBQ1ksY0FBRCxDQUFWO0FBQ0FkLEVBQUFBLGFBQWEsQ0FBQ08sU0FBRCxDQUFiO0FBQ0FSLEVBQUFBLFlBQVksQ0FBQ1MsUUFBRCxDQUFaO0FBRUEsc0JBQ0U7QUFBTSxJQUFBLFNBQVMsRUFBRTNCO0FBQWpCLEtBQ0dzQixNQUFNLENBQUNNLEdBQVAsQ0FBVyxnQkFBa0M7QUFBQSxRQUEvQmdCLFdBQStCLFFBQS9CQSxXQUErQjtBQUFBLFFBQWxCWixFQUFrQixRQUFsQkEsRUFBa0I7QUFBQSxRQUFYb0IsSUFBVztBQUM1Qyx3QkFDRSxnQ0FBQyxpQkFBRDtBQUFPLE1BQUEsR0FBRyxFQUFFcEIsRUFBWjtBQUFnQixNQUFBLFFBQVEsRUFBRTtBQUFBLGVBQU1NLFdBQVcsQ0FBQ04sRUFBRCxDQUFqQjtBQUFBO0FBQTFCLE9BQXFEb0IsSUFBckQsR0FDR1IsV0FESCxDQURGO0FBS0QsR0FOQSxDQURILENBREY7QUFXRCxDQXZGb0IsQ0FBckI7QUF5RkE1QixZQUFZLENBQUNxQyxTQUFiLEdBQXlCO0FBQ3ZCO0FBQ0Y7QUFDQTtBQUNFakMsRUFBQUEsVUFBVSxFQUFFa0Msc0JBQVVDLElBQVYsQ0FBZUMsVUFKSjs7QUFNdkI7QUFDRjtBQUNBO0FBQ0VuQyxFQUFBQSxVQUFVLEVBQUVpQyxzQkFBVUMsSUFBVixDQUFlQyxVQVRKOztBQVd2QjtBQUNGO0FBQ0E7QUFDRXJDLEVBQUFBLGFBQWEsRUFBRW1DLHNCQUFVQyxJQUFWLENBQWVDLFVBZFA7O0FBZ0J2QjtBQUNGO0FBQ0E7QUFDRXRDLEVBQUFBLFlBQVksRUFBRW9DLHNCQUFVQyxJQUFWLENBQWVDO0FBbkJOLENBQXpCO2VBc0JleEMsWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBtZW1vLCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IHsgY3NzIH0gZnJvbSAnZ2xhbW9yJ1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IHsgU3RhY2tpbmdPcmRlciB9IGZyb20gJy4uLy4uL2NvbnN0YW50cydcbmltcG9ydCBUb2FzdCBmcm9tICcuL1RvYXN0J1xuXG5jb25zdCB3cmFwcGVyQ2xhc3MgPSBjc3Moe1xuICBtYXhXaWR0aDogNTYwLFxuICBtYXJnaW46ICcwIGF1dG8nLFxuICB0b3A6IDAsXG4gIGxlZnQ6IDAsXG4gIHJpZ2h0OiAwLFxuICBwb3NpdGlvbjogJ2ZpeGVkJyxcbiAgekluZGV4OiBTdGFja2luZ09yZGVyLlRPQVNURVIsXG4gIHBvaW50ZXJFdmVudHM6ICdub25lJ1xufSlcblxuY29uc3QgaGFzQ3VzdG9tSWQgPSBzZXR0aW5ncyA9PiBPYmplY3QuaGFzT3duUHJvcGVydHkuY2FsbChzZXR0aW5ncywgJ2lkJylcblxuY29uc3QgVG9hc3RNYW5hZ2VyID0gbWVtbyhmdW5jdGlvbiBUb2FzdE1hbmFnZXIocHJvcHMpIHtcbiAgY29uc3QgeyBiaW5kQ2xvc2VBbGwsIGJpbmRHZXRUb2FzdHMsIGJpbmROb3RpZnksIGJpbmRSZW1vdmUgfSA9IHByb3BzXG5cbiAgY29uc3QgW3RvYXN0cywgc2V0VG9hc3RzXSA9IHVzZVN0YXRlKFtdKVxuICBjb25zdCBbaWRDb3VudGVyLCBzZXRJZENvdW50ZXJdID0gdXNlU3RhdGUoMClcblxuICBjb25zdCBnZXRUb2FzdHMgPSAoKSA9PiB0b2FzdHNcblxuICBjb25zdCBjbG9zZUFsbCA9ICgpID0+IHtcbiAgICBzZXRUb2FzdHModG9hc3RzLm1hcCh0b2FzdCA9PiAoeyAuLi50b2FzdCwgaXNTaG93bjogZmFsc2UgfSkpKVxuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgd2lsbCBzZXQgaXNTaG93biBvbiB0aGUgVG9hc3Qgd2hpY2ggd2lsbCBjbG9zZSB0aGUgdG9hc3QuXG4gICAqIEl0IHdvbid0IHJlbW92ZSB0aGUgdG9hc3QgdW50aWwgb25FeGl0ZWQgdHJpZ2dlcnMgb25SZW1vdmUuXG4gICAqL1xuICBjb25zdCBjbG9zZVRvYXN0ID0gaWQgPT4ge1xuICAgIHNldFRvYXN0cyhcbiAgICAgIHRvYXN0cy5tYXAodG9hc3QgPT4ge1xuICAgICAgICBpZiAodG9hc3QuaWQgPT09IGlkKSB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIC4uLnRvYXN0LFxuICAgICAgICAgICAgaXNTaG93bjogZmFsc2VcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdG9hc3RcbiAgICAgIH0pXG4gICAgKVxuICB9XG5cbiAgY29uc3Qgc2FmZUNsb3NlVG9hc3QgPSBpZCA9PiB7XG4gICAgY29uc3QgdG9hc3RUb1JlbW92ZSA9IHRvYXN0cy5maW5kKHRvYXN0ID0+IFN0cmluZyh0b2FzdC5pZCkuc3RhcnRzV2l0aChpZCkpXG5cbiAgICBpZiAodG9hc3RUb1JlbW92ZSkge1xuICAgICAgY2xvc2VUb2FzdCh0b2FzdFRvUmVtb3ZlLmlkKVxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IHJlbW92ZVRvYXN0ID0gaWQgPT4ge1xuICAgIGNvbnN0IHVwZGF0ZWRUb2FzdHMgPSB0b2FzdHMuZmlsdGVyKHRvYXN0ID0+ICFTdHJpbmcodG9hc3QuaWQpLnN0YXJ0c1dpdGgoaWQpKVxuICAgIHNldFRvYXN0cyh1cGRhdGVkVG9hc3RzKVxuICAgIHJldHVybiB1cGRhdGVkVG9hc3RzXG4gIH1cblxuICBjb25zdCBjcmVhdGVUb2FzdEluc3RhbmNlID0gKHRpdGxlLCBzZXR0aW5ncykgPT4ge1xuICAgIGNvbnN0IHVuaXF1ZUlkID0gaWRDb3VudGVyXG4gICAgc2V0SWRDb3VudGVyKGlkQ291bnRlciArIDEpXG4gICAgY29uc3QgaWQgPSBoYXNDdXN0b21JZChzZXR0aW5ncykgPyBgJHtzZXR0aW5ncy5pZH0tJHt1bmlxdWVJZH1gIDogdW5pcXVlSWRcblxuICAgIHJldHVybiB7XG4gICAgICBpZCxcbiAgICAgIHRpdGxlLFxuICAgICAgZGVzY3JpcHRpb246IHNldHRpbmdzLmRlc2NyaXB0aW9uLFxuICAgICAgaGFzQ2xvc2VCdXR0b246IHNldHRpbmdzLmhhc0Nsb3NlQnV0dG9uIHx8IHRydWUsXG4gICAgICBkdXJhdGlvbjogc2V0dGluZ3MuZHVyYXRpb24gfHwgNSxcbiAgICAgIGNsb3NlOiAoKSA9PiBzYWZlQ2xvc2VUb2FzdChpZCksXG4gICAgICBpbnRlbnQ6IHNldHRpbmdzLmludGVudFxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG5vdGlmeSA9ICh0aXRsZSwgc2V0dGluZ3MpID0+IHtcbiAgICBsZXQgdGVtcFRvYXN0cyA9IHRvYXN0c1xuICAgIGlmIChoYXNDdXN0b21JZChzZXR0aW5ncykpIHtcbiAgICAgIHRlbXBUb2FzdHMgPSByZW1vdmVUb2FzdChzZXR0aW5ncy5pZClcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IGNyZWF0ZVRvYXN0SW5zdGFuY2UodGl0bGUsIHNldHRpbmdzKVxuICAgIHNldFRvYXN0cyhbaW5zdGFuY2UsIC4uLnRlbXBUb2FzdHNdKVxuICB9XG5cbiAgYmluZE5vdGlmeShub3RpZnkpXG4gIGJpbmRSZW1vdmUoc2FmZUNsb3NlVG9hc3QpXG4gIGJpbmRHZXRUb2FzdHMoZ2V0VG9hc3RzKVxuICBiaW5kQ2xvc2VBbGwoY2xvc2VBbGwpXG5cbiAgcmV0dXJuIChcbiAgICA8c3BhbiBjbGFzc05hbWU9e3dyYXBwZXJDbGFzc30+XG4gICAgICB7dG9hc3RzLm1hcCgoeyBkZXNjcmlwdGlvbiwgaWQsIC4uLnJlc3QgfSkgPT4ge1xuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIDxUb2FzdCBrZXk9e2lkfSBvblJlbW92ZT17KCkgPT4gcmVtb3ZlVG9hc3QoaWQpfSB7Li4ucmVzdH0+XG4gICAgICAgICAgICB7ZGVzY3JpcHRpb259XG4gICAgICAgICAgPC9Ub2FzdD5cbiAgICAgICAgKVxuICAgICAgfSl9XG4gICAgPC9zcGFuPlxuICApXG59KVxuXG5Ub2FzdE1hbmFnZXIucHJvcFR5cGVzID0ge1xuICAvKipcbiAgICogRnVuY3Rpb24gY2FsbGVkIHdpdGggdGhlIGB0aGlzLm5vdGlmeWAgZnVuY3Rpb24uXG4gICAqL1xuICBiaW5kTm90aWZ5OiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiBjYWxsZWQgd2l0aCB0aGUgYHRoaXMucmVtb3ZlYCBmdW5jdGlvbi5cbiAgICovXG4gIGJpbmRSZW1vdmU6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIGNhbGxlZCB3aXRoIHRoZSBgdGhpcy5nZXRUb2FzdHNgIGZ1bmN0aW9uLlxuICAgKi9cbiAgYmluZEdldFRvYXN0czogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogRnVuY3Rpb24gY2FsbGVkIHdpdGggdGhlIGB0aGlzLmNsb3NlQWxsYCBmdW5jdGlvbi5cbiAgICovXG4gIGJpbmRDbG9zZUFsbDogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZFxufVxuXG5leHBvcnQgZGVmYXVsdCBUb2FzdE1hbmFnZXJcbiJdfQ==