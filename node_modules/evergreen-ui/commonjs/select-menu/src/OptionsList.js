"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _reactTinyVirtualList = _interopRequireDefault(require("@segment/react-tiny-virtual-list"));

var _fuzzaldrinPlus = _interopRequireDefault(require("fuzzaldrin-plus"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _icons = require("../../icons");

var _image = require("../../image");

var _layers = require("../../layers");

var _SearchTableHeaderCell = _interopRequireDefault(require("../../table/src/SearchTableHeaderCell"));

var _TableHead = _interopRequireDefault(require("../../table/src/TableHead"));

var _theme = require("../../theme");

var _Option = _interopRequireDefault(require("./Option"));

var _OptionShapePropType = _interopRequireDefault(require("./OptionShapePropType"));

var _excluded = ["options", "optionSize", "close", "closeOnSelect", "onSelect", "onDeselect", "onFilterChange", "hasFilter", "selected", "optionsFilter", "isMultiSelect", "height", "width", "renderItem", "filterPlaceholder", "filterIcon", "defaultSearchValue"];

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

/**
 * Fuzzaldrin-plus is the default filter, but you can use your own
 * as long as they follow the following signature:
 * @param options <Array[String]> - ['label', 'label2', ...]
 * @param input <String>
 */
var fuzzyFilter = function fuzzyFilter(options, input, _ref) {
  var key = _ref.key;
  return _fuzzaldrinPlus["default"].filter(options, input, {
    key: key
  });
};

var noop = function noop() {};

var defaultRenderItem = function defaultRenderItem(props) {
  return /*#__PURE__*/_react["default"].createElement(_Option["default"], props, props.icon && /*#__PURE__*/_react["default"].createElement(_image.Image, {
    src: props.icon,
    width: 24,
    marginRight: 8
  }), props.label);
};

defaultRenderItem.displayName = "defaultRenderItem";
var OptionsList = /*#__PURE__*/(0, _react.memo)(function OptionsList(props) {
  var _props$options = props.options,
      originalOptions = _props$options === void 0 ? [] : _props$options,
      _props$optionSize = props.optionSize,
      optionSize = _props$optionSize === void 0 ? 33 : _props$optionSize,
      close = props.close,
      closeOnSelect = props.closeOnSelect,
      _props$onSelect = props.onSelect,
      onSelect = _props$onSelect === void 0 ? noop : _props$onSelect,
      _props$onDeselect = props.onDeselect,
      onDeselect = _props$onDeselect === void 0 ? noop : _props$onDeselect,
      _props$onFilterChange = props.onFilterChange,
      onFilterChange = _props$onFilterChange === void 0 ? noop : _props$onFilterChange,
      hasFilter = props.hasFilter,
      _props$selected = props.selected,
      selected = _props$selected === void 0 ? [] : _props$selected,
      optionsFilter = props.optionsFilter,
      isMultiSelect = props.isMultiSelect,
      height = props.height,
      width = props.width,
      _props$renderItem = props.renderItem,
      _renderItem = _props$renderItem === void 0 ? defaultRenderItem : _props$renderItem,
      _props$filterPlacehol = props.filterPlaceholder,
      filterPlaceholder = _props$filterPlacehol === void 0 ? 'Filter...' : _props$filterPlacehol,
      _props$filterIcon = props.filterIcon,
      filterIcon = _props$filterIcon === void 0 ? _icons.SearchIcon : _props$filterIcon,
      _props$defaultSearchV = props.defaultSearchValue,
      defaultSearchValue = _props$defaultSearchV === void 0 ? '' : _props$defaultSearchV,
      rest = (0, _objectWithoutProperties2["default"])(props, _excluded);

  var _useState = (0, _react.useState)(defaultSearchValue),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      searchValue = _useState2[0],
      setSearchValue = _useState2[1];

  var _useState3 = (0, _react.useState)(null),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      searchRef = _useState4[0],
      setSearchRef = _useState4[1];

  var requestId = (0, _react.useRef)();
  var theme = (0, _theme.useTheme)();
  var tokens = theme.tokens;
  var isSelected = (0, _react.useCallback)(function (item) {
    return Boolean(selected.find(function (selectedItem) {
      return selectedItem === item.value;
    }));
  }, [selected]);
  var optionLabels = (0, _react.useMemo)(function () {
    return originalOptions.map(function (item) {
      return item.label;
    });
  }, [originalOptions]); // Gets filtered options any time the filter fn, value, or options change

  var options = (0, _react.useMemo)(function () {
    if (searchValue.trim() === '') {
      return originalOptions;
    } // Preserve backwards compatibility with allowing custom filters, which accept array of strings


    if (typeof optionsFilter === 'function') {
      return optionsFilter(optionLabels, searchValue).map(function (name) {
        return originalOptions.find(function (item) {
          return item.label === name;
        });
      });
    }

    return fuzzyFilter(originalOptions, searchValue, {
      key: 'label'
    });
  }, [originalOptions, optionLabels, optionsFilter, searchValue]);
  var getCurrentIndex = (0, _react.useCallback)(function () {
    return options.findIndex(function (option) {
      return option.value === selected[selected.length - 1];
    });
  }, [selected, options]);
  var handleArrowUp = (0, _react.useCallback)(function () {
    var nextIndex = getCurrentIndex() - 1;

    if (nextIndex < 0) {
      nextIndex = options.length - 1;
    }

    if (isSelected(options[nextIndex])) {
      return;
    }

    onSelect(options[nextIndex]);
  }, [onSelect, options, getCurrentIndex, isSelected]);
  var handleArrowDown = (0, _react.useCallback)(function () {
    var nextIndex = getCurrentIndex() + 1;

    if (nextIndex === options.length) {
      nextIndex = 0;
    }

    if (!isSelected(options[nextIndex])) {
      onSelect(options[nextIndex]);
    }
  }, [onSelect, options, getCurrentIndex, isSelected]);
  var handleChange = (0, _react.useCallback)(function (searchValue) {
    setSearchValue(searchValue);
    onFilterChange(searchValue);
  }, [onFilterChange]);
  var handleSelect = (0, _react.useCallback)(function (item) {
    if (isSelected(item) && isMultiSelect) {
      onDeselect(item);
    } else {
      onSelect(item);
    }

    if (!isMultiSelect && closeOnSelect) {
      close();
    }
  }, [onDeselect, isMultiSelect, closeOnSelect, onSelect, isSelected, close]);
  var handleEnter = (0, _react.useCallback)(function () {
    var isSelected = getCurrentIndex() !== -1;

    if (isSelected) {
      if (!isMultiSelect && closeOnSelect) {
        close();
      }
    }
  }, [isMultiSelect, close, closeOnSelect, getCurrentIndex]);
  var handleDeselect = (0, _react.useCallback)(function (item) {
    onDeselect(item);
  }, [onDeselect]);
  var handleKeyDown = (0, _react.useCallback)(function (e) {
    if (e.key === 'ArrowUp') {
      handleArrowUp();
    }

    if (e.key === 'ArrowDown') {
      handleArrowDown();
    }

    if (e.key === 'Enter') {
      handleEnter();
    }

    if (e.key === 'Escape') {
      close();
    }
  }, [close, handleArrowUp, handleArrowDown, handleEnter]);
  (0, _react.useEffect)(function () {
    if (hasFilter) {
      requestId.current = requestAnimationFrame(function () {
        if (searchRef) {
          searchRef.focus();
        }
      });
      window.addEventListener('keydown', handleKeyDown);
      return function () {
        cancelAnimationFrame(requestId.current);
        window.removeEventListener('keydown', handleKeyDown);
      };
    }
  }, [hasFilter, searchRef, handleKeyDown]);
  var listHeight = height - (hasFilter ? 32 : 0);
  var currentIndex = getCurrentIndex();
  var scrollToIndex = currentIndex === -1 ? 0 : currentIndex;
  return /*#__PURE__*/_react["default"].createElement(_layers.Pane, (0, _extends2["default"])({
    height: height,
    width: width,
    display: "flex",
    flexDirection: "column"
  }, rest), hasFilter && /*#__PURE__*/_react["default"].createElement(_TableHead["default"], {
    height: 32,
    backgroundColor: tokens.colors.gray50
  }, /*#__PURE__*/_react["default"].createElement(_SearchTableHeaderCell["default"], {
    onChange: handleChange,
    ref: setSearchRef,
    borderRight: null,
    placeholder: filterPlaceholder,
    icon: filterIcon
  })), /*#__PURE__*/_react["default"].createElement(_layers.Pane, {
    flex: 1
  }, options.length > 0 && /*#__PURE__*/_react["default"].createElement(_reactTinyVirtualList["default"], {
    height: listHeight,
    width: "100%",
    itemSize: optionSize,
    itemCount: options.length,
    overscanCount: 20,
    scrollToAlignment: "auto",
    scrollToIndex: scrollToIndex || undefined,
    renderItem: function renderItem(_ref2) {
      var index = _ref2.index,
          style = _ref2.style;
      var item = options[index];
      var isItemSelected = isSelected(item);
      var itemProps = {
        key: item.value,
        label: item.label,
        icon: item.icon,
        item: item,
        style: style,
        height: optionSize,
        onSelect: function onSelect() {
          return handleSelect(item);
        },
        onDeselect: function onDeselect() {
          return handleDeselect(item);
        },
        isSelectable: !isItemSelected || isMultiSelect,
        isSelected: isItemSelected,
        disabled: item.disabled,
        tabIndex: 0
      };
      return _renderItem(itemProps);
    }
  })));
});
OptionsList.propTypes = {
  options: _propTypes["default"].arrayOf(_OptionShapePropType["default"]),
  close: _propTypes["default"].func,
  height: _propTypes["default"].number,
  width: _propTypes["default"].number,

  /**
   * When true, multi select is accounted for.
   */
  isMultiSelect: _propTypes["default"].bool,

  /**
   * When true, menu closes on option selection.
   */
  closeOnSelect: _propTypes["default"].bool,

  /**
   * This holds the values of the options
   */
  selected: _propTypes["default"].arrayOf(_propTypes["default"].oneOfType([_propTypes["default"].string, _propTypes["default"].number])),
  onSelect: _propTypes["default"].func,
  onDeselect: _propTypes["default"].func,
  onFilterChange: _propTypes["default"].func,
  hasFilter: _propTypes["default"].bool,
  optionSize: _propTypes["default"].number,
  renderItem: _propTypes["default"].func,
  filterPlaceholder: _propTypes["default"].string,
  filterIcon: _propTypes["default"].oneOfType([_propTypes["default"].elementType, _propTypes["default"].element]),
  optionsFilter: _propTypes["default"].func,
  defaultSearchValue: _propTypes["default"].string
};
var _default = OptionsList;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZWxlY3QtbWVudS9zcmMvT3B0aW9uc0xpc3QuanMiXSwibmFtZXMiOlsiZnV6enlGaWx0ZXIiLCJvcHRpb25zIiwiaW5wdXQiLCJrZXkiLCJmdXp6YWxkcmluIiwiZmlsdGVyIiwibm9vcCIsImRlZmF1bHRSZW5kZXJJdGVtIiwicHJvcHMiLCJpY29uIiwibGFiZWwiLCJPcHRpb25zTGlzdCIsIm9yaWdpbmFsT3B0aW9ucyIsIm9wdGlvblNpemUiLCJjbG9zZSIsImNsb3NlT25TZWxlY3QiLCJvblNlbGVjdCIsIm9uRGVzZWxlY3QiLCJvbkZpbHRlckNoYW5nZSIsImhhc0ZpbHRlciIsInNlbGVjdGVkIiwib3B0aW9uc0ZpbHRlciIsImlzTXVsdGlTZWxlY3QiLCJoZWlnaHQiLCJ3aWR0aCIsInJlbmRlckl0ZW0iLCJmaWx0ZXJQbGFjZWhvbGRlciIsImZpbHRlckljb24iLCJTZWFyY2hJY29uIiwiZGVmYXVsdFNlYXJjaFZhbHVlIiwicmVzdCIsInNlYXJjaFZhbHVlIiwic2V0U2VhcmNoVmFsdWUiLCJzZWFyY2hSZWYiLCJzZXRTZWFyY2hSZWYiLCJyZXF1ZXN0SWQiLCJ0aGVtZSIsInRva2VucyIsImlzU2VsZWN0ZWQiLCJpdGVtIiwiQm9vbGVhbiIsImZpbmQiLCJzZWxlY3RlZEl0ZW0iLCJ2YWx1ZSIsIm9wdGlvbkxhYmVscyIsIm1hcCIsInRyaW0iLCJuYW1lIiwiZ2V0Q3VycmVudEluZGV4IiwiZmluZEluZGV4Iiwib3B0aW9uIiwibGVuZ3RoIiwiaGFuZGxlQXJyb3dVcCIsIm5leHRJbmRleCIsImhhbmRsZUFycm93RG93biIsImhhbmRsZUNoYW5nZSIsImhhbmRsZVNlbGVjdCIsImhhbmRsZUVudGVyIiwiaGFuZGxlRGVzZWxlY3QiLCJoYW5kbGVLZXlEb3duIiwiZSIsImN1cnJlbnQiLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJmb2N1cyIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJjYW5jZWxBbmltYXRpb25GcmFtZSIsInJlbW92ZUV2ZW50TGlzdGVuZXIiLCJsaXN0SGVpZ2h0IiwiY3VycmVudEluZGV4Iiwic2Nyb2xsVG9JbmRleCIsImNvbG9ycyIsImdyYXk1MCIsInVuZGVmaW5lZCIsImluZGV4Iiwic3R5bGUiLCJpc0l0ZW1TZWxlY3RlZCIsIml0ZW1Qcm9wcyIsImlzU2VsZWN0YWJsZSIsImRpc2FibGVkIiwidGFiSW5kZXgiLCJwcm9wVHlwZXMiLCJQcm9wVHlwZXMiLCJhcnJheU9mIiwiT3B0aW9uU2hhcGVQcm9wVHlwZSIsImZ1bmMiLCJudW1iZXIiLCJib29sIiwib25lT2ZUeXBlIiwic3RyaW5nIiwiZWxlbWVudFR5cGUiLCJlbGVtZW50Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7OztBQUVBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLElBQU1BLFdBQVcsR0FBRyxTQUFkQSxXQUFjLENBQUNDLE9BQUQsRUFBVUMsS0FBVixRQUE2QjtBQUFBLE1BQVZDLEdBQVUsUUFBVkEsR0FBVTtBQUMvQyxTQUFPQywyQkFBV0MsTUFBWCxDQUFrQkosT0FBbEIsRUFBMkJDLEtBQTNCLEVBQWtDO0FBQUVDLElBQUFBLEdBQUcsRUFBSEE7QUFBRixHQUFsQyxDQUFQO0FBQ0QsQ0FGRDs7QUFJQSxJQUFNRyxJQUFJLEdBQUcsU0FBUEEsSUFBTyxHQUFNLENBQUUsQ0FBckI7O0FBRUEsSUFBTUMsaUJBQWlCLEdBQUcsU0FBcEJBLGlCQUFvQixDQUFBQyxLQUFLLEVBQUk7QUFDakMsc0JBQ0UsZ0NBQUMsa0JBQUQsRUFBWUEsS0FBWixFQUNHQSxLQUFLLENBQUNDLElBQU4saUJBQWMsZ0NBQUMsWUFBRDtBQUFPLElBQUEsR0FBRyxFQUFFRCxLQUFLLENBQUNDLElBQWxCO0FBQXdCLElBQUEsS0FBSyxFQUFFLEVBQS9CO0FBQW1DLElBQUEsV0FBVyxF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QTBCdEIzRCxFQUFBQSxpQkFBaUIsRUFBRXdELHNCQUFVTyxNQTFCUDtBQTJCdEI5RCxFQUFBQSxVQUFVLEVBQUV1RCxzQkFBVU0sU0FBVixDQUFvQixDQUFDTixzQkFBVVEsV0FBWCxFQUF3QlIsc0JBQVVTLE9BQWxDLENBQXBCLENBM0JVO0FBNEJ0QnRFLEVBQUFBLGFBQWEsRUFBRTZELHNCQUFVRyxJQTVCSDtBQTZCdEJ4RCxFQUFBQSxrQkFBa0IsRUFBRXFELHNCQUFVTztBQTdCUixDQUF4QjtlQWdDZTlFLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgbWVtbywgdXNlQ2FsbGJhY2ssIHVzZUVmZmVjdCwgdXNlTWVtbywgdXNlUmVmLCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFZpcnR1YWxMaXN0IGZyb20gJ0BzZWdtZW50L3JlYWN0LXRpbnktdmlydHVhbC1saXN0J1xuaW1wb3J0IGZ1enphbGRyaW4gZnJvbSAnZnV6emFsZHJpbi1wbHVzJ1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IHsgU2VhcmNoSWNvbiB9IGZyb20gJy4uLy4uL2ljb25zJ1xuaW1wb3J0IHsgSW1hZ2UgfSBmcm9tICcuLi8uLi9pbWFnZSdcbmltcG9ydCB7IFBhbmUgfSBmcm9tICcuLi8uLi9sYXllcnMnXG5pbXBvcnQgU2VhcmNoVGFibGVIZWFkZXJDZWxsIGZyb20gJy4uLy4uL3RhYmxlL3NyYy9TZWFyY2hUYWJsZUhlYWRlckNlbGwnXG5pbXBvcnQgVGFibGVIZWFkIGZyb20gJy4uLy4uL3RhYmxlL3NyYy9UYWJsZUhlYWQnXG5pbXBvcnQgeyB1c2VUaGVtZSB9IGZyb20gJy4uLy4uL3RoZW1lJ1xuaW1wb3J0IE9wdGlvbiBmcm9tICcuL09wdGlvbidcbmltcG9ydCBPcHRpb25TaGFwZVByb3BUeXBlIGZyb20gJy4vT3B0aW9uU2hhcGVQcm9wVHlwZSdcblxuLyoqXG4gKiBGdXp6YWxkcmluLXBsdXMgaXMgdGhlIGRlZmF1bHQgZmlsdGVyLCBidXQgeW91IGNhbiB1c2UgeW91ciBvd25cbiAqIGFzIGxvbmcgYXMgdGhleSBmb2xsb3cgdGhlIGZvbGxvd2luZyBzaWduYXR1cmU6XG4gKiBAcGFyYW0gb3B0aW9ucyA8QXJyYXlbU3RyaW5nXT4gLSBbJ2xhYmVsJywgJ2xhYmVsMicsIC4uLl1cbiAqIEBwYXJhbSBpbnB1dCA8U3RyaW5nPlxuICovXG5jb25zdCBmdXp6eUZpbHRlciA9IChvcHRpb25zLCBpbnB1dCwgeyBrZXkgfSkgPT4ge1xuICByZXR1cm4gZnV6emFsZHJpbi5maWx0ZXIob3B0aW9ucywgaW5wdXQsIHsga2V5IH0pXG59XG5cbmNvbnN0IG5vb3AgPSAoKSA9PiB7fVxuXG5jb25zdCBkZWZhdWx0UmVuZGVySXRlbSA9IHByb3BzID0+IHtcbiAgcmV0dXJuIChcbiAgICA8T3B0aW9uIHsuLi5wcm9wc30+XG4gICAgICB7cHJvcHMuaWNvbiAmJiA8SW1hZ2Ugc3JjPXtwcm9wcy5pY29ufSB3aWR0aD17MjR9IG1hcmdpblJpZ2h0PXs4fSAvPn1cbiAgICAgIHtwcm9wcy5sYWJlbH1cbiAgICA8L09wdGlvbj5cbiAgKVxufVxuXG5jb25zdCBPcHRpb25zTGlzdCA9IG1lbW8oZnVuY3Rpb24gT3B0aW9uc0xpc3QocHJvcHMpIHtcbiAgY29uc3Qge1xuICAgIG9wdGlvbnM6IG9yaWdpbmFsT3B0aW9ucyA9IFtdLFxuICAgIG9wdGlvblNpemUgPSAzMyxcbiAgICBjbG9zZSxcbiAgICBjbG9zZU9uU2VsZWN0LFxuICAgIG9uU2VsZWN0ID0gbm9vcCxcbiAgICBvbkRlc2VsZWN0ID0gbm9vcCxcbiAgICBvbkZpbHRlckNoYW5nZSA9IG5vb3AsXG4gICAgaGFzRmlsdGVyLFxuICAgIHNlbGVjdGVkID0gW10sXG4gICAgb3B0aW9uc0ZpbHRlcixcbiAgICBpc011bHRpU2VsZWN0LFxuICAgIGhlaWdodCxcbiAgICB3aWR0aCxcbiAgICByZW5kZXJJdGVtID0gZGVmYXVsdFJlbmRlckl0ZW0sXG4gICAgZmlsdGVyUGxhY2Vob2xkZXIgPSAnRmlsdGVyLi4uJyxcbiAgICBmaWx0ZXJJY29uID0gU2VhcmNoSWNvbixcbiAgICBkZWZhdWx0U2VhcmNoVmFsdWUgPSAnJyxcbiAgICAuLi5yZXN0XG4gIH0gPSBwcm9wc1xuXG4gIGNvbnN0IFtzZWFyY2hWYWx1ZSwgc2V0U2VhcmNoVmFsdWVdID0gdXNlU3RhdGUoZGVmYXVsdFNlYXJjaFZhbHVlKVxuICBjb25zdCBbc2VhcmNoUmVmLCBzZXRTZWFyY2hSZWZdID0gdXNlU3RhdGUobnVsbClcbiAgY29uc3QgcmVxdWVzdElkID0gdXNlUmVmKClcbiAgY29uc3QgdGhlbWUgPSB1c2VUaGVtZSgpXG4gIGNvbnN0IHsgdG9rZW5zIH0gPSB0aGVtZVxuXG4gIGNvbnN0IGlzU2VsZWN0ZWQgPSB1c2VDYWxsYmFjayhcbiAgICBpdGVtID0+IHtcbiAgICAgIHJldHVybiBCb29sZWFuKHNlbGVjdGVkLmZpbmQoc2VsZWN0ZWRJdGVtID0+IHNlbGVjdGVkSXRlbSA9PT0gaXRlbS52YWx1ZSkpXG4gICAgfSxcbiAgICBbc2VsZWN0ZWRdXG4gIClcblxuICBjb25zdCBvcHRpb25MYWJlbHMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICByZXR1cm4gb3JpZ2luYWxPcHRpb25zLm1hcChpdGVtID0+IGl0ZW0ubGFiZWwpXG4gIH0sIFtvcmlnaW5hbE9wdGlvbnNdKVxuXG4gIC8vIEdldHMgZmlsdGVyZWQgb3B0aW9ucyBhbnkgdGltZSB0aGUgZmlsdGVyIGZuLCB2YWx1ZSwgb3Igb3B0aW9ucyBjaGFuZ2VcbiAgY29uc3Qgb3B0aW9ucyA9IHVzZU1lbW8oKCkgPT4ge1xuICAgIGlmIChzZWFyY2hWYWx1ZS50cmltKCkgPT09ICcnKSB7XG4gICAgICByZXR1cm4gb3JpZ2luYWxPcHRpb25zXG4gICAgfVxuXG4gICAgLy8gUHJlc2VydmUgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkgd2l0aCBhbGxvd2luZyBjdXN0b20gZmlsdGVycywgd2hpY2ggYWNjZXB0IGFycmF5IG9mIHN0cmluZ3NcbiAgICBpZiAodHlwZW9mIG9wdGlvbnNGaWx0ZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHJldHVybiBvcHRpb25zRmlsdGVyKG9wdGlvbkxhYmVscywgc2VhcmNoVmFsdWUpLm1hcChuYW1lID0+IHtcbiAgICAgICAgcmV0dXJuIG9yaWdpbmFsT3B0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5sYWJlbCA9PT0gbmFtZSlcbiAgICAgIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIGZ1enp5RmlsdGVyKG9yaWdpbmFsT3B0aW9ucywgc2VhcmNoVmFsdWUsIHsga2V5OiAnbGFiZWwnIH0pXG4gIH0sIFtvcmlnaW5hbE9wdGlvbnMsIG9wdGlvbkxhYmVscywgb3B0aW9uc0ZpbHRlciwgc2VhcmNoVmFsdWVdKVxuXG4gIGNvbnN0IGdldEN1cnJlbnRJbmRleCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICByZXR1cm4gb3B0aW9ucy5maW5kSW5kZXgob3B0aW9uID0+IG9wdGlvbi52YWx1ZSA9PT0gc2VsZWN0ZWRbc2VsZWN0ZWQubGVuZ3RoIC0gMV0pXG4gIH0sIFtzZWxlY3RlZCwgb3B0aW9uc10pXG5cbiAgY29uc3QgaGFuZGxlQXJyb3dVcCA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBsZXQgbmV4dEluZGV4ID0gZ2V0Q3VycmVudEluZGV4KCkgLSAxXG5cbiAgICBpZiAobmV4dEluZGV4IDwgMCkge1xuICAgICAgbmV4dEluZGV4ID0gb3B0aW9ucy5sZW5ndGggLSAxXG4gICAgfVxuXG4gICAgaWYgKGlzU2VsZWN0ZWQob3B0aW9uc1tuZXh0SW5kZXhdKSkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgb25TZWxlY3Qob3B0aW9uc1tuZXh0SW5kZXhdKVxuICB9LCBbb25TZWxlY3QsIG9wdGlvbnMsIGdldEN1cnJlbnRJbmRleCwgaXNTZWxlY3RlZF0pXG5cbiAgY29uc3QgaGFuZGxlQXJyb3dEb3duID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGxldCBuZXh0SW5kZXggPSBnZXRDdXJyZW50SW5kZXgoKSArIDFcblxuICAgIGlmIChuZXh0SW5kZXggPT09IG9wdGlvbnMubGVuZ3RoKSB7XG4gICAgICBuZXh0SW5kZXggPSAwXG4gICAgfVxuXG4gICAgaWYgKCFpc1NlbGVjdGVkKG9wdGlvbnNbbmV4dEluZGV4XSkpIHtcbiAgICAgIG9uU2VsZWN0KG9wdGlvbnNbbmV4dEluZGV4XSlcbiAgICB9XG4gIH0sIFtvblNlbGVjdCwgb3B0aW9ucywgZ2V0Q3VycmVudEluZGV4LCBpc1NlbGVjdGVkXSlcblxuICBjb25zdCBoYW5kbGVDaGFuZ2UgPSB1c2VDYWxsYmFjayhcbiAgICBzZWFyY2hWYWx1ZSA9PiB7XG4gICAgICBzZXRTZWFyY2hWYWx1ZShzZWFyY2hWYWx1ZSlcbiAgICAgIG9uRmlsdGVyQ2hhbmdlKHNlYXJjaFZhbHVlKVxuICAgIH0sXG4gICAgW29uRmlsdGVyQ2hhbmdlXVxuICApXG5cbiAgY29uc3QgaGFuZGxlU2VsZWN0ID0gdXNlQ2FsbGJhY2soXG4gICAgaXRlbSA9PiB7XG4gICAgICBpZiAoaXNTZWxlY3RlZChpdGVtKSAmJiBpc011bHRpU2VsZWN0KSB7XG4gICAgICAgIG9uRGVzZWxlY3QoaXRlbSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9uU2VsZWN0KGl0ZW0pXG4gICAgICB9XG5cbiAgICAgIGlmICghaXNNdWx0aVNlbGVjdCAmJiBjbG9zZU9uU2VsZWN0KSB7XG4gICAgICAgIGNsb3NlKClcbiAgICAgIH1cbiAgICB9LFxuICAgIFtvbkRlc2VsZWN0LCBpc011bHRpU2VsZWN0LCBjbG9zZU9uU2VsZWN0LCBvblNlbGVjdCwgaXNTZWxlY3RlZCwgY2xvc2VdXG4gIClcblxuICBjb25zdCBoYW5kbGVFbnRlciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBjb25zdCBpc1NlbGVjdGVkID0gZ2V0Q3VycmVudEluZGV4KCkgIT09IC0xXG5cbiAgICBpZiAoaXNTZWxlY3RlZCkge1xuICAgICAgaWYgKCFpc011bHRpU2VsZWN0ICYmIGNsb3NlT25TZWxlY3QpIHtcbiAgICAgICAgY2xvc2UoKVxuICAgICAgfVxuICAgIH1cbiAgfSwgW2lzTXVsdGlTZWxlY3QsIGNsb3NlLCBjbG9zZU9uU2VsZWN0LCBnZXRDdXJyZW50SW5kZXhdKVxuXG4gIGNvbnN0IGhhbmRsZURlc2VsZWN0ID0gdXNlQ2FsbGJhY2soXG4gICAgaXRlbSA9PiB7XG4gICAgICBvbkRlc2VsZWN0KGl0ZW0pXG4gICAgfSxcbiAgICBbb25EZXNlbGVjdF1cbiAgKVxuXG4gIGNvbnN0IGhhbmRsZUtleURvd24gPSB1c2VDYWxsYmFjayhcbiAgICBlID0+IHtcbiAgICAgIGlmIChlLmtleSA9PT0gJ0Fycm93VXAnKSB7XG4gICAgICAgIGhhbmRsZUFycm93VXAoKVxuICAgICAgfVxuXG4gICAgICBpZiAoZS5rZXkgPT09ICdBcnJvd0Rvd24nKSB7XG4gICAgICAgIGhhbmRsZUFycm93RG93bigpXG4gICAgICB9XG5cbiAgICAgIGlmIChlLmtleSA9PT0gJ0VudGVyJykge1xuICAgICAgICBoYW5kbGVFbnRlcigpXG4gICAgICB9XG5cbiAgICAgIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHtcbiAgICAgICAgY2xvc2UoKVxuICAgICAgfVxuICAgIH0sXG4gICAgW2Nsb3NlLCBoYW5kbGVBcnJvd1VwLCBoYW5kbGVBcnJvd0Rvd24sIGhhbmRsZUVudGVyXVxuICApXG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoaGFzRmlsdGVyKSB7XG4gICAgICByZXF1ZXN0SWQuY3VycmVudCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICAgIGlmIChzZWFyY2hSZWYpIHtcbiAgICAgICAgICBzZWFyY2hSZWYuZm9jdXMoKVxuICAgICAgICB9XG4gICAgICB9KVxuXG4gICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIGhhbmRsZUtleURvd24pXG4gICAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShyZXF1ZXN0SWQuY3VycmVudClcbiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVLZXlEb3duKVxuICAgICAgfVxuICAgIH1cbiAgfSwgW2hhc0ZpbHRlciwgc2VhcmNoUmVmLCBoYW5kbGVLZXlEb3duXSlcblxuICBjb25zdCBsaXN0SGVpZ2h0ID0gaGVpZ2h0IC0gKGhhc0ZpbHRlciA/IDMyIDogMClcbiAgY29uc3QgY3VycmVudEluZGV4ID0gZ2V0Q3VycmVudEluZGV4KClcbiAgY29uc3Qgc2Nyb2xsVG9JbmRleCA9IGN1cnJlbnRJbmRleCA9PT0gLTEgPyAwIDogY3VycmVudEluZGV4XG5cbiAgcmV0dXJuIChcbiAgICA8UGFuZSBoZWlnaHQ9e2hlaWdodH0gd2lkdGg9e3dpZHRofSBkaXNwbGF5PVwiZmxleFwiIGZsZXhEaXJlY3Rpb249XCJjb2x1bW5cIiB7Li4ucmVzdH0+XG4gICAgICB7aGFzRmlsdGVyICYmIChcbiAgICAgICAgPFRhYmxlSGVhZCBoZWlnaHQ9ezMyfSBiYWNrZ3JvdW5kQ29sb3I9e3Rva2Vucy5jb2xvcnMuZ3JheTUwfT5cbiAgICAgICAgICA8U2VhcmNoVGFibGVIZWFkZXJDZWxsXG4gICAgICAgICAgICBvbkNoYW5nZT17aGFuZGxlQ2hhbmdlfVxuICAgICAgICAgICAgcmVmPXtzZXRTZWFyY2hSZWZ9XG4gICAgICAgICAgICBib3JkZXJSaWdodD17bnVsbH1cbiAgICAgICAgICAgIHBsYWNlaG9sZGVyPXtmaWx0ZXJQbGFjZWhvbGRlcn1cbiAgICAgICAgICAgIGljb249e2ZpbHRlckljb259XG4gICAgICAgICAgLz5cbiAgICAgICAgPC9UYWJsZUhlYWQ+XG4gICAgICApfVxuICAgICAgPFBhbmUgZmxleD17MX0+XG4gICAgICAgIHtvcHRpb25zLmxlbmd0aCA+IDAgJiYgKFxuICAgICAgICAgIDxWaXJ0dWFsTGlzdFxuICAgICAgICAgICAgaGVpZ2h0PXtsaXN0SGVpZ2h0fVxuICAgICAgICAgICAgd2lkdGg9XCIxMDAlXCJcbiAgICAgICAgICAgIGl0ZW1TaXplPXtvcHRpb25TaXplfVxuICAgICAgICAgICAgaXRlbUNvdW50PXtvcHRpb25zLmxlbmd0aH1cbiAgICAgICAgICAgIG92ZXJzY2FuQ291bnQ9ezIwfVxuICAgICAgICAgICAgc2Nyb2xsVG9BbGlnbm1lbnQ9XCJhdXRvXCJcbiAgICAgICAgICAgIHNjcm9sbFRvSW5kZXg9e3Njcm9sbFRvSW5kZXggfHwgdW5kZWZpbmVkfVxuICAgICAgICAgICAgcmVuZGVySXRlbT17KHsgaW5kZXgsIHN0eWxlIH0pID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IG9wdGlvbnNbaW5kZXhdXG4gICAgICAgICAgICAgIGNvbnN0IGlzSXRlbVNlbGVjdGVkID0gaXNTZWxlY3RlZChpdGVtKVxuXG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW1Qcm9wcyA9IHtcbiAgICAgICAgICAgICAgICBrZXk6IGl0ZW0udmFsdWUsXG4gICAgICAgICAgICAgICAgbGFiZWw6IGl0ZW0ubGFiZWwsXG4gICAgICAgICAgICAgICAgaWNvbjogaXRlbS5pY29uLFxuICAgICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBvcHRpb25TaXplLFxuICAgICAgICAgICAgICAgIG9uU2VsZWN0OiAoKSA9PiBoYW5kbGVTZWxlY3QoaXRlbSksXG4gICAgICAgICAgICAgICAgb25EZXNlbGVjdDogKCkgPT4gaGFuZGxlRGVzZWxlY3QoaXRlbSksXG4gICAgICAgICAgICAgICAgaXNTZWxlY3RhYmxlOiAhaXNJdGVtU2VsZWN0ZWQgfHwgaXNNdWx0aVNlbGVjdCxcbiAgICAgICAgICAgICAgICBpc1NlbGVjdGVkOiBpc0l0ZW1TZWxlY3RlZCxcbiAgICAgICAgICAgICAgICBkaXNhYmxlZDogaXRlbS5kaXNhYmxlZCxcbiAgICAgICAgICAgICAgICB0YWJJbmRleDogMFxuICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgcmV0dXJuIHJlbmRlckl0ZW0oaXRlbVByb3BzKVxuICAgICAgICAgICAgfX1cbiAgICAgICAgICAvPlxuICAgICAgICApfVxuICAgICAgPC9QYW5lPlxuICAgIDwvUGFuZT5cbiAgKVxufSlcblxuT3B0aW9uc0xpc3QucHJvcFR5cGVzID0ge1xuICBvcHRpb25zOiBQcm9wVHlwZXMuYXJyYXlPZihPcHRpb25TaGFwZVByb3BUeXBlKSxcbiAgY2xvc2U6IFByb3BUeXBlcy5mdW5jLFxuICBoZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG4gIHdpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gIC8qKlxuICAgKiBXaGVuIHRydWUsIG11bHRpIHNlbGVjdCBpcyBhY2NvdW50ZWQgZm9yLlxuICAgKi9cbiAgaXNNdWx0aVNlbGVjdDogUHJvcFR5cGVzLmJvb2wsXG5cbiAgLyoqXG4gICAqIFdoZW4gdHJ1ZSwgbWVudSBjbG9zZXMgb24gb3B0aW9uIHNlbGVjdGlvbi5cbiAgICovXG4gIGNsb3NlT25TZWxlY3Q6IFByb3BUeXBlcy5ib29sLFxuXG4gIC8qKlxuICAgKiBUaGlzIGhvbGRzIHRoZSB2YWx1ZXMgb2YgdGhlIG9wdGlvbnNcbiAgICovXG4gIHNlbGVjdGVkOiBQcm9wVHlwZXMuYXJyYXlPZihQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuc3RyaW5nLCBQcm9wVHlwZXMubnVtYmVyXSkpLFxuICBvblNlbGVjdDogUHJvcFR5cGVzLmZ1bmMsXG4gIG9uRGVzZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxuICBvbkZpbHRlckNoYW5nZTogUHJvcFR5cGVzLmZ1bmMsXG4gIGhhc0ZpbHRlcjogUHJvcFR5cGVzLmJvb2wsXG4gIG9wdGlvblNpemU6IFByb3BUeXBlcy5udW1iZXIsXG4gIHJlbmRlckl0ZW06IFByb3BUeXBlcy5mdW5jLFxuICBmaWx0ZXJQbGFjZWhvbGRlcjogUHJvcFR5cGVzLnN0cmluZyxcbiAgZmlsdGVySWNvbjogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLmVsZW1lbnRUeXBlLCBQcm9wVHlwZXMuZWxlbWVudF0pLFxuICBvcHRpb25zRmlsdGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgZGVmYXVsdFNlYXJjaFZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nXG59XG5cbmV4cG9ydCBkZWZhdWx0IE9wdGlvbnNMaXN0XG4iXX0=