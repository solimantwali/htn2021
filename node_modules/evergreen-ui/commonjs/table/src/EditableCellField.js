"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _typeof = require("@babel/runtime/helpers/typeof");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _hooks = require("../../hooks");

var _textarea = require("../../textarea");

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") { return { "default": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function getTableBodyRef(currentRef) {
  var ref = currentRef;
  if (!ref) return;

  while (ref) {
    var isTableBody = ref.hasAttribute('data-evergreen-table-body');

    if (isTableBody) {
      return ref;
    }

    if (ref.parentElement) {
      ref = ref.parentElement;
    } else {
      return null;
    }
  }

  return ref;
}

var EditableCellField = /*#__PURE__*/(0, _react.memo)(function EditableCellField(props) {
  var _props$minHeight = props.minHeight,
      minHeight = _props$minHeight === void 0 ? 40 : _props$minHeight,
      _props$minWidth = props.minWidth,
      minWidth = _props$minWidth === void 0 ? 80 : _props$minWidth,
      size = props.size,
      value = props.value,
      zIndex = props.zIndex;
  var latestAnimationFrame = (0, _react.useRef)();
  var textareaRef = (0, _react.useRef)();
  var tableBodyRef = (0, _react.useRef)();
  var onCancelRef = (0, _hooks.useLatest)(props.onCancel);
  var onChangeCompleteRef = (0, _hooks.useLatest)(props.onChangeComplete);
  var getTargetRef = (0, _hooks.useLatest)(props.getTargetRef);

  var _useState = (0, _react.useState)(0),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      height = _useState2[0],
      setHeight = _useState2[1];

  var _useState3 = (0, _react.useState)(0),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      width = _useState4[0],
      setWidth = _useState4[1];

  var _useState5 = (0, _react.useState)(0),
      _useState6 = (0, _slicedToArray2["default"])(_useState5, 2),
      left = _useState6[0],
      setLeft = _useState6[1];

  var _useState7 = (0, _react.useState)(0),
      _useState8 = (0, _slicedToArray2["default"])(_useState7, 2),
      top = _useState8[0],
      setTop = _useState8[1];

  var update = (0, _react.useCallback)(function () {
    function updater() {
      var targetRef = getTargetRef.current();
      if (!targetRef) return;
      tableBodyRef.current = getTableBodyRef(targetRef);

      var _targetRef$getBoundin = targetRef.getBoundingClientRect(),
          targetHeight = _targetRef$getBoundin.height,
          targetLeft = _targetRef$getBoundin.left,
          targetTop = _targetRef$getBoundin.top,
          targetWidth = _targetRef$getBoundin.width;

      var calculatedTop;

      if (tableBodyRef.current) {
        var bounds = tableBodyRef.current.getBoundingClientRect();
        calculatedTop = Math.min(Math.max(targetTop, bounds.top), bounds.bottom - targetHeight);
      } else {
        calculatedTop = targetTop;
      }

      setHeight(targetHeight);
      setWidth(targetWidth);
      setLeft(targetLeft);
      setTop(calculatedTop); // recursively run the updater

      latestAnimationFrame.current = requestAnimationFrame(function () {
        return updater();
      });
    } // kick off the updater


    updater(); // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Mirrors functionality of componentDidMount and componentWillUnmount.
  // Focus on mount

  (0, _react.useLayoutEffect)(function () {
    update();
    var requestId = requestAnimationFrame(function () {
      if (textareaRef.current) {
        textareaRef.current.focus();
      }
    });
    return function () {
      cancelAnimationFrame(requestId);

      if (latestAnimationFrame.current) {
        cancelAnimationFrame(latestAnimationFrame.current);
      } // eslint-disable-next-line react-hooks/exhaustive-deps


      onCancelRef.current();
    }; // we only want `update` to run once, and `onCancelRef` is a ref
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);
  var handleFocus = (0, _react.useCallback)(function (e) {
    e.target.selectionStart = e.target.value.length;
  }, []);
  var handleBlur = (0, _react.useCallback)(function () {
    if (textareaRef.current) {
      onChangeCompleteRef.current(textareaRef.current.value);
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var handleKeyDown = (0, _react.useCallback)(function (e) {
    switch (e.key) {
      case 'Escape':
        onCancelRef.current();
        if (textareaRef.current) textareaRef.current.blur();
        break;

      case 'Enter':
        if (textareaRef.current) textareaRef.current.blur();
        e.preventDefault();
        break;

      case 'Tab':
        if (textareaRef.current) textareaRef.current.blur();
        break;

      default:
        break;
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var style = (0, _react.useMemo)(function () {
    return {
      left: left,
      top: top,
      height: height,
      minHeight: Math.max(height, minHeight),
      width: width,
      minWidth: Math.max(width, minWidth),
      zIndex: zIndex
    };
  }, [left, top, height, width, minHeight, minWidth, zIndex]);
  return /*#__PURE__*/_react["default"].createElement(_textarea.Textarea, {
    ref: textareaRef,
    onKeyDown: handleKeyDown,
    onBlur: handleBlur,
    onFocus: handleFocus,
    appearance: "editable-cell",
    size: size,
    style: style,
    height: null,
    width: null,
    minHeight: null,
    position: "fixed",
    defaultValue: value
  });
});
EditableCellField.propTypes = {
  /**
   * Used as the defaultValue of the textarea.
   */
  value: _propTypes["default"].string.isRequired,

  /**
   * The z-index placed on the element.
   */
  zIndex: _propTypes["default"].number.isRequired,

  /**
   * Function to get the target ref of the parent.
   * Used to mirror the position.
   */
  getTargetRef: _propTypes["default"].func.isRequired,

  /**
   * Min width of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minWidth: _propTypes["default"].number,

  /**
   * Min height of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minHeight: _propTypes["default"].number,

  /**
   * Called when the textarea is blurred, pass the value back to the cell.
   */
  onChangeComplete: _propTypes["default"].func.isRequired,

  /**
   * Called when Escape is hit or componentWillUnmount.
   */
  onCancel: _propTypes["default"].func.isRequired,

  /**
   * Text size of the textarea.
   */
  size: _propTypes["default"].number
};
var _default = EditableCellField;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvRWRpdGFibGVDZWxsRmllbGQuanMiXSwibmFtZXMiOlsiZ2V0VGFibGVCb2R5UmVmIiwiY3VycmVudFJlZiIsInJlZiIsImlzVGFibGVCb2R5IiwiaGFzQXR0cmlidXRlIiwicGFyZW50RWxlbWVudCIsIkVkaXRhYmxlQ2VsbEZpZWxkIiwicHJvcHMiLCJtaW5IZWlnaHQiLCJtaW5XaWR0aCIsInNpemUiLCJ2YWx1ZSIsInpJbmRleCIsImxhdGVzdEFuaW1hdGlvbkZyYW1lIiwidGV4dGFyZWFSZWYiLCJ0YWJsZUJvZHlSZWYiLCJvbkNhbmNlbFJlZiIsIm9uQ2FuY2VsIiwib25DaGFuZ2VDb21wbGV0ZVJlZiIsIm9uQ2hhbmdlQ29tcGxldGUiLCJnZXRUYXJnZXRSZWYiLCJoZWlnaHQiLCJzZXRIZWlnaHQiLCJ3aWR0aCIsInNldFdpZHRoIiwibGVmdCIsInNldExlZnQiLCJ0b3AiLCJzZXRUb3AiLCJ1cGRhdGUiLCJ1cGRhdGVyIiwidGFyZ2V0UmVmIiwiY3VycmVudCIsImdldEJvdW5kaW5nQ2xpZW50UmVjdCIsInRhcmdldEhlaWdodCIsInRhcmdldExlZnQiLCJ0YXJnZXRUb3AiLCJ0YXJnZXRXaWR0aCIsImNhbGN1bGF0ZWRUb3AiLCJib3VuZHMiLCJNYXRoIiwibWluIiwibWF4IiwiYm90dG9tIiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwicmVxdWVzdElkIiwiZm9jdXMiLCJjYW5jZWxBbmltYXRpb25GcmFtZSIsImhhbmRsZUZvY3VzIiwiZSIsInRhcmdldCIsInNlbGVjdGlvblN0YXJ0IiwibGVuZ3RoIiwiaGFuZGxlQmx1ciIsImhhbmRsZUtleURvd24iLCJrZXkiLCJibHVyIiwicHJldmVudERlZmF1bHQiLCJzdHlsZSIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsInN0cmluZyIsImlzUmVxdWlyZWQiLCJudW1iZXIiLCJmdW5jIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7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QUNGO0FBQ0E7QUFDQTtBQUNFdkQsRUFBQUEsU0FBUyxFQUFFb0Qsc0JBQVVHLE1BM0JPOztBQTZCNUI7QUFDRjtBQUNBO0FBQ0U1QyxFQUFBQSxnQkFBZ0IsRUFBRXlDLHNCQUFVSSxJQUFWLENBQWVGLFVBaENMOztBQWtDNUI7QUFDRjtBQUNBO0FBQ0U3QyxFQUFBQSxRQUFRLEVBQUUyQyxzQkFBVUksSUFBVixDQUFlRixVQXJDRzs7QUF1QzVCO0FBQ0Y7QUFDQTtBQUNFcEQsRUFBQUEsSUFBSSxFQUFFa0Qsc0JBQVVHO0FBMUNZLENBQTlCO2VBNkNlekQsaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgbWVtbywgdXNlUmVmLCB1c2VTdGF0ZSwgdXNlTWVtbywgdXNlQ2FsbGJhY2ssIHVzZUxheW91dEVmZmVjdCB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFByb3BUeXBlcyBmcm9tICdwcm9wLXR5cGVzJ1xuaW1wb3J0IHsgdXNlTGF0ZXN0IH0gZnJvbSAnLi4vLi4vaG9va3MnXG5pbXBvcnQgeyBUZXh0YXJlYSB9IGZyb20gJy4uLy4uL3RleHRhcmVhJ1xuXG5mdW5jdGlvbiBnZXRUYWJsZUJvZHlSZWYoY3VycmVudFJlZikge1xuICBsZXQgcmVmID0gY3VycmVudFJlZlxuXG4gIGlmICghcmVmKSByZXR1cm5cblxuICB3aGlsZSAocmVmKSB7XG4gICAgY29uc3QgaXNUYWJsZUJvZHkgPSByZWYuaGFzQXR0cmlidXRlKCdkYXRhLWV2ZXJncmVlbi10YWJsZS1ib2R5JylcbiAgICBpZiAoaXNUYWJsZUJvZHkpIHtcbiAgICAgIHJldHVybiByZWZcbiAgICB9XG5cbiAgICBpZiAocmVmLnBhcmVudEVsZW1lbnQpIHtcbiAgICAgIHJlZiA9IHJlZi5wYXJlbnRFbGVtZW50XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlZlxufVxuXG5jb25zdCBFZGl0YWJsZUNlbGxGaWVsZCA9IG1lbW8oZnVuY3Rpb24gRWRpdGFibGVDZWxsRmllbGQocHJvcHMpIHtcbiAgY29uc3QgeyBtaW5IZWlnaHQgPSA0MCwgbWluV2lkdGggPSA4MCwgc2l6ZSwgdmFsdWUsIHpJbmRleCB9ID0gcHJvcHNcblxuICBjb25zdCBsYXRlc3RBbmltYXRpb25GcmFtZSA9IHVzZVJlZigpXG4gIGNvbnN0IHRleHRhcmVhUmVmID0gdXNlUmVmKClcbiAgY29uc3QgdGFibGVCb2R5UmVmID0gdXNlUmVmKClcbiAgY29uc3Qgb25DYW5jZWxSZWYgPSB1c2VMYXRlc3QocHJvcHMub25DYW5jZWwpXG4gIGNvbnN0IG9uQ2hhbmdlQ29tcGxldGVSZWYgPSB1c2VMYXRlc3QocHJvcHMub25DaGFuZ2VDb21wbGV0ZSlcbiAgY29uc3QgZ2V0VGFyZ2V0UmVmID0gdXNlTGF0ZXN0KHByb3BzLmdldFRhcmdldFJlZilcbiAgY29uc3QgW2hlaWdodCwgc2V0SGVpZ2h0XSA9IHVzZVN0YXRlKDApXG4gIGNvbnN0IFt3aWR0aCwgc2V0V2lkdGhdID0gdXNlU3RhdGUoMClcbiAgY29uc3QgW2xlZnQsIHNldExlZnRdID0gdXNlU3RhdGUoMClcbiAgY29uc3QgW3RvcCwgc2V0VG9wXSA9IHVzZVN0YXRlKDApXG5cbiAgY29uc3QgdXBkYXRlID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGZ1bmN0aW9uIHVwZGF0ZXIoKSB7XG4gICAgICBjb25zdCB0YXJnZXRSZWYgPSBnZXRUYXJnZXRSZWYuY3VycmVudCgpXG4gICAgICBpZiAoIXRhcmdldFJlZikgcmV0dXJuXG4gICAgICB0YWJsZUJvZHlSZWYuY3VycmVudCA9IGdldFRhYmxlQm9keVJlZih0YXJnZXRSZWYpXG5cbiAgICAgIGNvbnN0IHtcbiAgICAgICAgaGVpZ2h0OiB0YXJnZXRIZWlnaHQsXG4gICAgICAgIGxlZnQ6IHRhcmdldExlZnQsXG4gICAgICAgIHRvcDogdGFyZ2V0VG9wLFxuICAgICAgICB3aWR0aDogdGFyZ2V0V2lkdGhcbiAgICAgIH0gPSB0YXJnZXRSZWYuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KClcblxuICAgICAgbGV0IGNhbGN1bGF0ZWRUb3BcbiAgICAgIGlmICh0YWJsZUJvZHlSZWYuY3VycmVudCkge1xuICAgICAgICBjb25zdCBib3VuZHMgPSB0YWJsZUJvZHlSZWYuY3VycmVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICAgICBjYWxjdWxhdGVkVG9wID0gTWF0aC5taW4oTWF0aC5tYXgodGFyZ2V0VG9wLCBib3VuZHMudG9wKSwgYm91bmRzLmJvdHRvbSAtIHRhcmdldEhlaWdodClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNhbGN1bGF0ZWRUb3AgPSB0YXJnZXRUb3BcbiAgICAgIH1cblxuICAgICAgc2V0SGVpZ2h0KHRhcmdldEhlaWdodClcbiAgICAgIHNldFdpZHRoKHRhcmdldFdpZHRoKVxuICAgICAgc2V0TGVmdCh0YXJnZXRMZWZ0KVxuICAgICAgc2V0VG9wKGNhbGN1bGF0ZWRUb3ApXG5cbiAgICAgIC8vIHJlY3Vyc2l2ZWx5IHJ1biB0aGUgdXBkYXRlclxuICAgICAgbGF0ZXN0QW5pbWF0aW9uRnJhbWUuY3VycmVudCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB1cGRhdGVyKCkpXG4gICAgfVxuXG4gICAgLy8ga2ljayBvZmYgdGhlIHVwZGF0ZXJcbiAgICB1cGRhdGVyKClcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIH0sIFtdKVxuXG4gIC8vIE1pcnJvcnMgZnVuY3Rpb25hbGl0eSBvZiBjb21wb25lbnREaWRNb3VudCBhbmQgY29tcG9uZW50V2lsbFVubW91bnQuXG4gIC8vIEZvY3VzIG9uIG1vdW50XG4gIHVzZUxheW91dEVmZmVjdCgoKSA9PiB7XG4gICAgdXBkYXRlKClcblxuICAgIGNvbnN0IHJlcXVlc3RJZCA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkge1xuICAgICAgICB0ZXh0YXJlYVJlZi5jdXJyZW50LmZvY3VzKClcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKHJlcXVlc3RJZClcblxuICAgICAgaWYgKGxhdGVzdEFuaW1hdGlvbkZyYW1lLmN1cnJlbnQpIHtcbiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUobGF0ZXN0QW5pbWF0aW9uRnJhbWUuY3VycmVudClcbiAgICAgIH1cblxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICAgICAgb25DYW5jZWxSZWYuY3VycmVudCgpXG4gICAgfVxuICAgIC8vIHdlIG9ubHkgd2FudCBgdXBkYXRlYCB0byBydW4gb25jZSwgYW5kIGBvbkNhbmNlbFJlZmAgaXMgYSByZWZcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIH0sIFtdKVxuXG4gIGNvbnN0IGhhbmRsZUZvY3VzID0gdXNlQ2FsbGJhY2soZSA9PiB7XG4gICAgZS50YXJnZXQuc2VsZWN0aW9uU3RhcnQgPSBlLnRhcmdldC52YWx1ZS5sZW5ndGhcbiAgfSwgW10pXG5cbiAgY29uc3QgaGFuZGxlQmx1ciA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkge1xuICAgICAgb25DaGFuZ2VDb21wbGV0ZVJlZi5jdXJyZW50KHRleHRhcmVhUmVmLmN1cnJlbnQudmFsdWUpXG4gICAgfVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgfSwgW10pXG5cbiAgY29uc3QgaGFuZGxlS2V5RG93biA9IHVzZUNhbGxiYWNrKGUgPT4ge1xuICAgIHN3aXRjaCAoZS5rZXkpIHtcbiAgICAgIGNhc2UgJ0VzY2FwZSc6XG4gICAgICAgIG9uQ2FuY2VsUmVmLmN1cnJlbnQoKVxuICAgICAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkgdGV4dGFyZWFSZWYuY3VycmVudC5ibHVyKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGNhc2UgJ0VudGVyJzpcbiAgICAgICAgaWYgKHRleHRhcmVhUmVmLmN1cnJlbnQpIHRleHRhcmVhUmVmLmN1cnJlbnQuYmx1cigpXG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnVGFiJzpcbiAgICAgICAgaWYgKHRleHRhcmVhUmVmLmN1cnJlbnQpIHRleHRhcmVhUmVmLmN1cnJlbnQuYmx1cigpXG4gICAgICAgIGJyZWFrXG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVha1xuICAgIH1cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gIH0sIFtdKVxuXG4gIGNvbnN0IHN0eWxlID0gdXNlTWVtbyhcbiAgICAoKSA9PiAoe1xuICAgICAgbGVmdCxcbiAgICAgIHRvcCxcbiAgICAgIGhlaWdodCxcbiAgICAgIG1pbkhlaWdodDogTWF0aC5tYXgoaGVpZ2h0LCBtaW5IZWlnaHQpLFxuICAgICAgd2lkdGgsXG4gICAgICBtaW5XaWR0aDogTWF0aC5tYXgod2lkdGgsIG1pbldpZHRoKSxcbiAgICAgIHpJbmRleFxuICAgIH0pLFxuICAgIFtsZWZ0LCB0b3AsIGhlaWdodCwgd2lkdGgsIG1pbkhlaWdodCwgbWluV2lkdGgsIHpJbmRleF1cbiAgKVxuXG4gIHJldHVybiAoXG4gICAgPFRleHRhcmVhXG4gICAgICByZWY9e3RleHRhcmVhUmVmfVxuICAgICAgb25LZXlEb3duPXtoYW5kbGVLZXlEb3dufVxuICAgICAgb25CbHVyPXtoYW5kbGVCbHVyfVxuICAgICAgb25Gb2N1cz17aGFuZGxlRm9jdXN9XG4gICAgICBhcHBlYXJhbmNlPVwiZWRpdGFibGUtY2VsbFwiXG4gICAgICBzaXplPXtzaXplfVxuICAgICAgc3R5bGU9e3N0eWxlfVxuICAgICAgaGVpZ2h0PXtudWxsfVxuICAgICAgd2lkdGg9e251bGx9XG4gICAgICBtaW5IZWlnaHQ9e251bGx9XG4gICAgICBwb3NpdGlvbj1cImZpeGVkXCJcbiAgICAgIGRlZmF1bHRWYWx1ZT17dmFsdWV9XG4gICAgLz5cbiAgKVxufSlcblxuRWRpdGFibGVDZWxsRmllbGQucHJvcFR5cGVzID0ge1xuICAvKipcbiAgICogVXNlZCBhcyB0aGUgZGVmYXVsdFZhbHVlIG9mIHRoZSB0ZXh0YXJlYS5cbiAgICovXG4gIHZhbHVlOiBQcm9wVHlwZXMuc3RyaW5nLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIFRoZSB6LWluZGV4IHBsYWNlZCBvbiB0aGUgZWxlbWVudC5cbiAgICovXG4gIHpJbmRleDogUHJvcFR5cGVzLm51bWJlci5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB0byBnZXQgdGhlIHRhcmdldCByZWYgb2YgdGhlIHBhcmVudC5cbiAgICogVXNlZCB0byBtaXJyb3IgdGhlIHBvc2l0aW9uLlxuICAgKi9cbiAgZ2V0VGFyZ2V0UmVmOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBNaW4gd2lkdGggb2YgdGhlIHRleHRhcmVhLlxuICAgKiBUaGUgdGV4dGFyZWEgY2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgY2VsbC5cbiAgICovXG4gIG1pbldpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gIC8qKlxuICAgKiBNaW4gaGVpZ2h0IG9mIHRoZSB0ZXh0YXJlYS5cbiAgICogVGhlIHRleHRhcmVhIGNhbiBuZXZlciBiZSBzbWFsbGVyIHRoYW4gdGhlIGNlbGwuXG4gICAqL1xuICBtaW5IZWlnaHQ6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgLyoqXG4gICAqIENhbGxlZCB3aGVuIHRoZSB0ZXh0YXJlYSBpcyBibHVycmVkLCBwYXNzIHRoZSB2YWx1ZSBiYWNrIHRvIHRoZSBjZWxsLlxuICAgKi9cbiAgb25DaGFuZ2VDb21wbGV0ZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogQ2FsbGVkIHdoZW4gRXNjYXBlIGlzIGhpdCBvciBjb21wb25lbnRXaWxsVW5tb3VudC5cbiAgICovXG4gIG9uQ2FuY2VsOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBUZXh0IHNpemUgb2YgdGhlIHRleHRhcmVhLlxuICAgKi9cbiAgc2l6ZTogUHJvcFR5cGVzLm51bWJlclxufVxuXG5leHBvcnQgZGVmYXVsdCBFZGl0YWJsZUNlbGxGaWVsZFxuIl19