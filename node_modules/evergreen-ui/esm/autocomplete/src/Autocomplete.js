import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import _extends from "@babel/runtime/helpers/esm/extends";
var _excluded = ["children", "itemSize", "position", "renderItem", "isFilterDisabled", "itemsFilter", "itemToString", "popoverMaxHeight", "popoverMinWidth", "allowOtherValues"],
    _excluded2 = ["getItemProps", "getMenuProps", "getRootProps", "highlightedIndex", "inputValue", "isOpen", "selectedItem"];

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

import React, { memo, forwardRef, useState, useEffect, useCallback } from 'react';
import VirtualList from '@segment/react-tiny-virtual-list';
import Downshift from 'downshift';
import fuzzaldrin from 'fuzzaldrin-plus';
import PropTypes from 'prop-types';
import { Position } from '../../constants';
import { Pane } from '../../layers';
import { Popover } from '../../popover';
import { Text } from '../../typography';
import AutocompleteItem from './AutocompleteItem';

var fuzzyFilter = function fuzzyFilter(itemToString) {
  if (itemToString) {
    return function (items, input) {
      var wrappedItems = items.map(function (item) {
        return {
          key: itemToString(item),
          item: item
        };
      });
      return fuzzaldrin.filter(wrappedItems, input, {
        key: 'key'
      }).map(function (_ref) {
        var item = _ref.item;
        return item;
      });
    };
  }

  return function (items, input) {
    return fuzzaldrin.filter(items, input);
  };
};

var noop = function noop() {};

var autocompleteItemRenderer = function autocompleteItemRenderer(props) {
  return /*#__PURE__*/React.createElement(AutocompleteItem, props);
};

autocompleteItemRenderer.displayName = "autocompleteItemRenderer";

/* eslint-disable react/prop-types */
var AutocompleteItems = function AutocompleteItems(_ref2) {
  var getItemProps = _ref2.getItemProps,
      getMenuProps = _ref2.getMenuProps,
      highlightedIndex = _ref2.highlightedIndex,
      inputValue = _ref2.inputValue,
      isFilterDisabled = _ref2.isFilterDisabled,
      itemSize = _ref2.itemSize,
      itemToString = _ref2.itemToString,
      itemsFilter = _ref2.itemsFilter,
      originalItems = _ref2.originalItems,
      popoverMaxHeight = _ref2.popoverMaxHeight,
      _renderItem = _ref2.renderItem,
      selectedItem = _ref2.selectedItem,
      title = _ref2.title,
      width = _ref2.width;
  itemsFilter = itemsFilter || fuzzyFilter(itemToString);
  var items = isFilterDisabled || inputValue.trim() === '' ? originalItems : itemsFilter(originalItems, inputValue);
  if (items.length === 0) return null; // Pass the actual DOM ref to downshift, this fixes touch support

  var menuProps = getMenuProps();
  return /*#__PURE__*/React.createElement(Pane, _extends({
    width: width
  }, menuProps), title && /*#__PURE__*/React.createElement(Pane, {
    padding: 8,
    borderBottom: "muted"
  }, /*#__PURE__*/React.createElement(Text, {
    size: 300,
    textTransform: "uppercase"
  }, title)), items.length > 0 && /*#__PURE__*/React.createElement(VirtualList, {
    width: "100%",
    height: Math.min(items.length * itemSize, popoverMaxHeight),
    itemSize: itemSize,
    itemCount: items.length,
    scrollToIndex: highlightedIndex || 0,
    overscanCount: 3,
    scrollToAlignment: "auto",
    renderItem: function renderItem(_ref3) {
      var index = _ref3.index,
          style = _ref3.style;
      var item = items[index];
      var itemString = itemToString(item);
      return _renderItem(getItemProps({
        item: item,
        key: itemString,
        index: index,
        style: style,
        children: itemString,
        isSelected: itemToString(selectedItem) === itemString,
        isHighlighted: highlightedIndex === index
      }));
    }
  }));
};

AutocompleteItems.displayName = "AutocompleteItems";

/* eslint-enable react/prop-types */
var containerStyle = {
  width: '100%'
};
var Autocomplete = /*#__PURE__*/memo( /*#__PURE__*/forwardRef(function Autocomplete(props, ref) {
  var children = props.children,
      _props$itemSize = props.itemSize,
      itemSize = _props$itemSize === void 0 ? 32 : _props$itemSize,
      position = props.position,
      _props$renderItem = props.renderItem,
      renderItem = _props$renderItem === void 0 ? autocompleteItemRenderer : _props$renderItem,
      _props$isFilterDisabl = props.isFilterDisabled,
      isFilterDisabled = _props$isFilterDisabl === void 0 ? false : _props$isFilterDisabl,
      itemsFilter = props.itemsFilter,
      _props$itemToString = props.itemToString,
      itemToString = _props$itemToString === void 0 ? function (i) {
    return i ? String(i) : '';
  } : _props$itemToString,
      _props$popoverMaxHeig = props.popoverMaxHeight,
      popoverMaxHeight = _props$popoverMaxHeig === void 0 ? 240 : _props$popoverMaxHeig,
      _props$popoverMinWidt = props.popoverMinWidth,
      popoverMinWidth = _props$popoverMinWidt === void 0 ? 240 : _props$popoverMinWidt,
      allowOtherValues = props.allowOtherValues,
      restProps = _objectWithoutProperties(props, _excluded);

  var _useState = useState(0),
      _useState2 = _slicedToArray(_useState, 2),
      targetWidth = _useState2[0],
      setTargetWidth = _useState2[1];

  var _useState3 = useState(),
      _useState4 = _slicedToArray(_useState3, 2),
      targetRef = _useState4[0],
      setTargetRef = _useState4[1];

  useEffect(function () {
    if (targetRef) {
      setTargetWidth(targetRef.getBoundingClientRect().width);
    }
  }, [targetRef]);
  var stateReducer = useCallback(function (state, changes) {
    if (Object.prototype.hasOwnProperty.call(changes, 'isOpen') && changes.isOpen) {
      return _objectSpread(_objectSpread({}, changes), {}, {
        highlightedIndex: props.items.indexOf(state.selectedItem)
      });
    }

    if (props.allowOtherValues && state.isOpen && !changes.isOpen) {
      return _objectSpread(_objectSpread({}, changes), {}, {
        selectedItem: changes.selectedItem || state.inputValue,
        inputValue: state.inputValue
      });
    }

    return changes;
  }, [props.items, props.allowOtherValues]);
  return /*#__PURE__*/React.createElement(Downshift, _extends({
    stateReducer: stateReducer,
    scrollIntoView: noop,
    itemToString: itemToString,
    ref: ref
  }, restProps), function (_ref4) {
    var getItemProps = _ref4.getItemProps,
        getMenuProps = _ref4.getMenuProps,
        getRootProps = _ref4.getRootProps,
        highlightedIndex = _ref4.highlightedIndex,
        inputValue = _ref4.inputValue,
        isShown = _ref4.isOpen,
        selectedItem = _ref4.selectedItem,
        restDownshiftProps = _objectWithoutProperties(_ref4, _excluded2);

    return /*#__PURE__*/React.createElement("div", {
      style: containerStyle
    }, /*#__PURE__*/React.createElement(Popover, {
      bringFocusInside: false,
      isShown: isShown,
      minWidth: popoverMinWidth,
      position: position || (targetWidth < popoverMinWidth ? Position.BOTTOM_LEFT : Position.BOTTOM),
      content: /*#__PURE__*/React.createElement(AutocompleteItems, {
        getItemProps: getItemProps,
        getMenuProps: getMenuProps,
        highlightedIndex: highlightedIndex,
        inputValue: inputValue,
        isFilterDisabled: isFilterDisabled,
        itemsFilter: itemsFilter,
        itemSize: itemSize,
        itemToString: itemToString,
        originalItems: props.items,
        popoverMaxHeight: popoverMaxHeight,
        renderItem: renderItem,
        selectedItem: selectedItem,
        title: props.title,
        width: Math.max(targetWidth, popoverMinWidth)
      }),
      minHeight: 0,
      animationDuration: 0
    }, function (_ref5) {
      var _getRef = _ref5.getRef,
          isShownPopover = _ref5.isShown,
          toggle = _ref5.toggle;
      return children(_objectSpread({
        isShown: isShownPopover,
        toggle: toggle,
        getRef: function getRef(ref) {
          // Use the ref internally to determine the width
          setTargetRef(ref);

          _getRef(ref);
        },
        inputValue: inputValue,
        selectedItem: selectedItem,
        highlightedIndex: highlightedIndex
      }, restDownshiftProps));
    }));
  });
}));
Autocomplete.propTypes = _objectSpread({
  /**
   * This prop can be either a string or a Node.
   * It will provide a title for the items
   */
  title: PropTypes.oneOfType([PropTypes.string, PropTypes.node]),

  /**
   * An array of items to be used as options for the select
   */
  items: PropTypes.array.isRequired,

  /**
   * The selected Item to be shown on the autocomplete
   */
  selectedItem: PropTypes.any,

  /**
   * In case the array of items is not an array of strings,
   * this function is used on each item to return the string that will be shown on the filter
   */
  itemToString: PropTypes.func,

  /**
   * Function that will render the 'filter' component.
   */
  children: PropTypes.func.isRequired,

  /**
   * The height of each item in the list
   * Because the list is virtualized this is required beforehand.
   */
  itemSize: PropTypes.number,

  /**
   * Function that returns a component to render the item
   */
  renderItem: PropTypes.func,

  /**
   * The position of the Popover the Autocomplete is rendered in.
   */
  position: PropTypes.oneOf([Position.TOP, Position.TOP_LEFT, Position.TOP_RIGHT, Position.BOTTOM, Position.BOTTOM_LEFT, Position.BOTTOM_RIGHT, Position.LEFT, Position.RIGHT]),

  /**
   * A function that is used to filter the items.
   * It should return a subset of the initial items.
   * By default the "fuzzaldrin-plus" package is used.
   */
  itemsFilter: PropTypes.func,

  /**
   * Prop that enables and disables filtering
   * True: Enables Filtering
   * False: Disables Filtering
   */
  isFilterDisabled: PropTypes.bool,

  /**
   * Defines the minimum height the results container will be
   */
  popoverMinWidth: PropTypes.number,

  /**
   * Defines the maximum height the results container will be
   */
  popoverMaxHeight: PropTypes.number,

  /**
   * Whether or not the input accepts arbitrary user input beyond the provided items
   */
  allowOtherValues: PropTypes.bool
}, Downshift.propTypes);
export default Autocomplete;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hdXRvY29tcGxldGUvc3JjL0F1dG9jb21wbGV0ZS5qcyJdLCJuYW1lcyI6WyJSZWFjdCIsIm1lbW8iLCJmb3J3YXJkUmVmIiwidXNlU3RhdGUiLCJ1c2VFZmZlY3QiLCJ1c2VDYWxsYmFjayIsIlZpcnR1YWxMaXN0IiwiRG93bnNoaWZ0IiwiZnV6emFsZHJpbiIsIlByb3BUeXBlcyIsIlBvc2l0aW9uIiwiUGFuZSIsIlBvcG92ZXIiLCJUZXh0IiwiQXV0b2NvbXBsZXRlSXRlbSIsImZ1enp5RmlsdGVyIiwiaXRlbVRvU3RyaW5nIiwiaXRlbXMiLCJpbnB1dCIsIndyYXBwZWRJdGVtcyIsIm1hcCIsIml0ZW0iLCJrZXkiLCJmaWx0ZXIiLCJub29wIiwiYXV0b2NvbXBsZXRlSXRlbVJlbmRlcmVyIiwicHJvcHMiLCJBdXRvY29tcGxldGVJdGVtcyIsImdldEl0ZW1Qcm9wcyIsImdldE1lbnVQcm9wcyIsImhpZ2hsaWdodGVkSW5kZXgiLCJpbnB1dFZhbHVlIiwiaXNGaWx0ZXJEaXNhYmxlZCIsIml0ZW1TaXplIiwiaXRlbXNGaWx0ZXIiLCJvcmlnaW5hbEl0ZW1zIiwicG9wb3Zlck1heEhlaWdodCIsInJlbmRlckl0ZW0iLCJzZWxlY3RlZEl0ZW0iLCJ0aXRsZSIsIndpZHRoIiwidHJpbSIsImxlbmd0aCIsIm1lbnVQcm9wcyIsIk1hdGgiLCJtaW4iLCJpbmRleCIsInN0eWxlIiwiaXRlbVN0cmluZyIsImNoaWxkcmVuIiwiaXNTZWxlY3RlZCIsImlzSGlnaGxpZ2h0ZWQiLCJjb250YWluZXJTdHlsZSIsIkF1dG9jb21wbGV0ZSIsInJlZiIsInBvc2l0aW9uIiwiaSIsIlN0cmluZyIsInBvcG92ZXJNaW5XaWR0aCIsImFsbG93T3RoZXJWYWx1ZXMiLCJyZXN0UHJvcHMiLCJ0YXJnZXRXaWR0aCIsInNldFRhcmdldFdpZHRoIiwidGFyZ2V0UmVmIiwic2V0VGFyZ2V0UmVmIiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0Iiwic3RhdGVSZWR1Y2VyIiwic3RhdGUiLCJjaGFuZ2VzIiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiaXNPcGVuIiwiaW5kZXhPZiIsImdldFJvb3RQcm9wcyIsImlzU2hvd24iLCJyZXN0RG93bnNoaWZ0UHJvcHMiLCJCT1RUT01fTEVGVCIsIkJPVFRPTSIsIm1heCIsImdldFJlZiIsImlzU2hvd25Qb3BvdmVyIiwidG9nZ2xlIiwicHJvcFR5cGVzIiwib25lT2ZUeXBlIiwic3RyaW5nIiwibm9kZSIsImFycmF5IiwiaXNSZXF1aXJlZCIsImFueSIsImZ1bmMiLCJudW1iZXIiLCJvbmVPZiIsIlRPUCIsIlRPUF9MRUZUIiwiVE9QX1JJR0hUIiwiQk9UVE9NX1JJR0hUIiwiTEVGVCIsIlJJR0hUIiwiYm9vbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQSxPQUFPQSxLQUFQLElBQWdCQyxJQUFoQixFQUFzQkMsVUFBdEIsRUFBa0NDLFFBQWxDLEVBQTRDQyxTQUE1QyxFQUF1REMsV0FBdkQsUUFBMEUsT0FBMUU7QUFDQSxPQUFPQyxXQUFQLE1BQXdCLGtDQUF4QjtBQUNBLE9BQU9DLFNBQVAsTUFBc0IsV0FBdEI7QUFDQSxPQUFPQyxVQUFQLE1BQXVCLGlCQUF2QjtBQUNBLE9BQU9DLFNBQVAsTUFBc0IsWUFBdEI7QUFDQSxTQUFTQyxRQUFULFFBQXlCLGlCQUF6QjtBQUNBLFNBQVNDLElBQVQsUUFBcUIsY0FBckI7QUFDQSxTQUFTQyxPQUFULFFBQXdCLGVBQXhCO0FBQ0EsU0FBU0MsSUFBVCxRQUFxQixrQkFBckI7QUFDQSxPQUFPQyxnQkFBUCxNQUE2QixvQkFBN0I7O0FBRUEsSUFBTUMsV0FBVyxHQUFHLFNBQWRBLFdBQWMsQ0FBQUMsWUFBWSxFQUFJO0FBQ2xDLE1BQUlBLFlBQUosRUFBa0I7QUFDaEIsV0FBTyxVQUFDQyxLQUFELEVBQVFDLEtBQVIsRUFBa0I7QUFDdkIsVUFBTUMsWUFBWSxHQUFHRixLQUFLLENBQUNHLEdBQU4sQ0FBVSxVQUFBQyxJQUFJO0FBQUEs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RUFJeEJ0RixRQUFRLENBQUNxRSxNQUplLEVBS3hCckUsUUFBUSxDQUFDb0UsV0FMZSxFQU14QnBFLFFBQVEsQ0FBQ3VGLFlBTmUsRUFPeEJ2RixRQUFRLENBQUN3RixJQVBlLEVBUXhCeEYsUUFBUSxDQUFDeUYsS0FSZSxDQUFoQixDQTFDWjs7QUFxREU7QUFDRjtBQUNBO0FBQ0E7QUFDQTtBQUNFakUsRUFBQUEsV0FBVyxFQUFFekIsU0FBUyxDQUFDa0YsSUExRHpCOztBQTRERTtBQUNGO0FBQ0E7QUFDQTtBQUNBO0FBQ0UzRCxFQUFBQSxnQkFBZ0IsRUFBRXZCLFNBQVMsQ0FBQzJGLElBakU5Qjs7QUFtRUU7QUFDRjtBQUNBO0FBQ0UxQyxFQUFBQSxlQUFlLEVBQUVqRCxTQUFTLENBQUNtRixNQXRFN0I7O0FBd0VFO0FBQ0Y7QUFDQTtBQUNFeEQsRUFBQUEsZ0JBQWdCLEVBQUUzQixTQUFTLENBQUNtRixNQTNFOUI7O0FBNkVFO0FBQ0Y7QUFDQTtBQUNFakMsRUFBQUEsZ0JBQWdCLEVBQUVsRCxTQUFTLENBQUMyRjtBQWhGOUIsR0FrRks3RixTQUFTLENBQUM2RSxTQWxGZjtBQXFGQSxlQUFlL0IsWUFBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBtZW1vLCBmb3J3YXJkUmVmLCB1c2VTdGF0ZSwgdXNlRWZmZWN0LCB1c2VDYWxsYmFjayB9IGZyb20gJ3JlYWN0J1xuaW1wb3J0IFZpcnR1YWxMaXN0IGZyb20gJ0BzZWdtZW50L3JlYWN0LXRpbnktdmlydHVhbC1saXN0J1xuaW1wb3J0IERvd25zaGlmdCBmcm9tICdkb3duc2hpZnQnXG5pbXBvcnQgZnV6emFsZHJpbiBmcm9tICdmdXp6YWxkcmluLXBsdXMnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgeyBQb3NpdGlvbiB9IGZyb20gJy4uLy4uL2NvbnN0YW50cydcbmltcG9ydCB7IFBhbmUgfSBmcm9tICcuLi8uLi9sYXllcnMnXG5pbXBvcnQgeyBQb3BvdmVyIH0gZnJvbSAnLi4vLi4vcG9wb3ZlcidcbmltcG9ydCB7IFRleHQgfSBmcm9tICcuLi8uLi90eXBvZ3JhcGh5J1xuaW1wb3J0IEF1dG9jb21wbGV0ZUl0ZW0gZnJvbSAnLi9BdXRvY29tcGxldGVJdGVtJ1xuXG5jb25zdCBmdXp6eUZpbHRlciA9IGl0ZW1Ub1N0cmluZyA9PiB7XG4gIGlmIChpdGVtVG9TdHJpbmcpIHtcbiAgICByZXR1cm4gKGl0ZW1zLCBpbnB1dCkgPT4ge1xuICAgICAgY29uc3Qgd3JhcHBlZEl0ZW1zID0gaXRlbXMubWFwKGl0ZW0gPT4gKHtcbiAgICAgICAga2V5OiBpdGVtVG9TdHJpbmcoaXRlbSksXG4gICAgICAgIGl0ZW1cbiAgICAgIH0pKVxuXG4gICAgICByZXR1cm4gZnV6emFsZHJpbi5maWx0ZXIod3JhcHBlZEl0ZW1zLCBpbnB1dCwgeyBrZXk6ICdrZXknIH0pLm1hcCgoeyBpdGVtIH0pID0+IGl0ZW0pXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIChpdGVtcywgaW5wdXQpID0+IGZ1enphbGRyaW4uZmlsdGVyKGl0ZW1zLCBpbnB1dClcbn1cblxuY29uc3Qgbm9vcCA9ICgpID0+IHt9XG5cbmNvbnN0IGF1dG9jb21wbGV0ZUl0ZW1SZW5kZXJlciA9IHByb3BzID0+IDxBdXRvY29tcGxldGVJdGVtIHsuLi5wcm9wc30gLz5cblxuLyogZXNsaW50LWRpc2FibGUgcmVhY3QvcHJvcC10eXBlcyAqL1xuY29uc3QgQXV0b2NvbXBsZXRlSXRlbXMgPSAoe1xuICBnZXRJdGVtUHJvcHMsXG4gIGdldE1lbnVQcm9wcyxcbiAgaGlnaGxpZ2h0ZWRJbmRleCxcbiAgaW5wdXRWYWx1ZSxcbiAgaXNGaWx0ZXJEaXNhYmxlZCxcbiAgaXRlbVNpemUsXG4gIGl0ZW1Ub1N0cmluZyxcbiAgaXRlbXNGaWx0ZXIsXG4gIG9yaWdpbmFsSXRlbXMsXG4gIHBvcG92ZXJNYXhIZWlnaHQsXG4gIHJlbmRlckl0ZW0sXG4gIHNlbGVjdGVkSXRlbSxcbiAgdGl0bGUsXG4gIHdpZHRoXG59KSA9PiB7XG4gIGl0ZW1zRmlsdGVyID0gaXRlbXNGaWx0ZXIgfHwgZnV6enlGaWx0ZXIoaXRlbVRvU3RyaW5nKVxuICBjb25zdCBpdGVtcyA9IGlzRmlsdGVyRGlzYWJsZWQgfHwgaW5wdXRWYWx1ZS50cmltKCkgPT09ICcnID8gb3JpZ2luYWxJdGVtcyA6IGl0ZW1zRmlsdGVyKG9yaWdpbmFsSXRlbXMsIGlucHV0VmFsdWUpXG5cbiAgaWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuIG51bGxcblxuICAvLyBQYXNzIHRoZSBhY3R1YWwgRE9NIHJlZiB0byBkb3duc2hpZnQsIHRoaXMgZml4ZXMgdG91Y2ggc3VwcG9ydFxuICBjb25zdCBtZW51UHJvcHMgPSBnZXRNZW51UHJvcHMoKVxuXG4gIHJldHVybiAoXG4gICAgPFBhbmUgd2lkdGg9e3dpZHRofSB7Li4ubWVudVByb3BzfT5cbiAgICAgIHt0aXRsZSAmJiAoXG4gICAgICAgIDxQYW5lIHBhZGRpbmc9ezh9IGJvcmRlckJvdHRvbT1cIm11dGVkXCI+XG4gICAgICAgICAgPFRleHQgc2l6ZT17MzAwfSB0ZXh0VHJhbnNmb3JtPVwidXBwZXJjYXNlXCI+XG4gICAgICAgICAgICB7dGl0bGV9XG4gICAgICAgICAgPC9UZXh0PlxuICAgICAgICA8L1BhbmU+XG4gICAgICApfVxuICAgICAge2l0ZW1zLmxlbmd0aCA+IDAgJiYgKFxuICAgICAgICA8VmlydHVhbExpc3RcbiAgICAgICAgICB3aWR0aD1cIjEwMCVcIlxuICAgICAgICAgIGhlaWdodD17TWF0aC5taW4oaXRlbXMubGVuZ3RoICogaXRlbVNpemUsIHBvcG92ZXJNYXhIZWlnaHQpfVxuICAgICAgICAgIGl0ZW1TaXplPXtpdGVtU2l6ZX1cbiAgICAgICAgICBpdGVtQ291bnQ9e2l0ZW1zLmxlbmd0aH1cbiAgICAgICAgICBzY3JvbGxUb0luZGV4PXtoaWdobGlnaHRlZEluZGV4IHx8IDB9XG4gICAgICAgICAgb3ZlcnNjYW5Db3VudD17M31cbiAgICAgICAgICBzY3JvbGxUb0FsaWdubWVudD1cImF1dG9cIlxuICAgICAgICAgIHJlbmRlckl0ZW09eyh7IGluZGV4LCBzdHlsZSB9KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBpdGVtID0gaXRlbXNbaW5kZXhdXG4gICAgICAgICAgICBjb25zdCBpdGVtU3RyaW5nID0gaXRlbVRvU3RyaW5nKGl0ZW0pXG5cbiAgICAgICAgICAgIHJldHVybiByZW5kZXJJdGVtKFxuICAgICAgICAgICAgICBnZXRJdGVtUHJvcHMoe1xuICAgICAgICAgICAgICAgIGl0ZW0sXG4gICAgICAgICAgICAgICAga2V5OiBpdGVtU3RyaW5nLFxuICAgICAgICAgICAgICAgIGluZGV4LFxuICAgICAgICAgICAgICAgIHN0eWxlLFxuICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBpdGVtU3RyaW5nLFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0ZWQ6IGl0ZW1Ub1N0cmluZyhzZWxlY3RlZEl0ZW0pID09PSBpdGVtU3RyaW5nLFxuICAgICAgICAgICAgICAgIGlzSGlnaGxpZ2h0ZWQ6IGhpZ2hsaWdodGVkSW5kZXggPT09IGluZGV4XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgfX1cbiAgICAgICAgLz5cbiAgICAgICl9XG4gICAgPC9QYW5lPlxuICApXG59XG4vKiBlc2xpbnQtZW5hYmxlIHJlYWN0L3Byb3AtdHlwZXMgKi9cblxuY29uc3QgY29udGFpbmVyU3R5bGUgPSB7IHdpZHRoOiAnMTAwJScgfVxuXG5jb25zdCBBdXRvY29tcGxldGUgPSBtZW1vKFxuICBmb3J3YXJkUmVmKGZ1bmN0aW9uIEF1dG9jb21wbGV0ZShwcm9wcywgcmVmKSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hpbGRyZW4sXG4gICAgICBpdGVtU2l6ZSA9IDMyLFxuICAgICAgcG9zaXRpb24sXG4gICAgICByZW5kZXJJdGVtID0gYXV0b2NvbXBsZXRlSXRlbVJlbmRlcmVyLFxuICAgICAgaXNGaWx0ZXJEaXNhYmxlZCA9IGZhbHNlLFxuICAgICAgaXRlbXNGaWx0ZXIsXG4gICAgICBpdGVtVG9TdHJpbmcgPSBpID0+IChpID8gU3RyaW5nKGkpIDogJycpLFxuICAgICAgcG9wb3Zlck1heEhlaWdodCA9IDI0MCxcbiAgICAgIHBvcG92ZXJNaW5XaWR0aCA9IDI0MCxcbiAgICAgIGFsbG93T3RoZXJWYWx1ZXMsXG4gICAgICAuLi5yZXN0UHJvcHNcbiAgICB9ID0gcHJvcHNcblxuICAgIGNvbnN0IFt0YXJnZXRXaWR0aCwgc2V0VGFyZ2V0V2lkdGhdID0gdXNlU3RhdGUoMClcbiAgICBjb25zdCBbdGFyZ2V0UmVmLCBzZXRUYXJnZXRSZWZdID0gdXNlU3RhdGUoKVxuXG4gICAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICAgIGlmICh0YXJnZXRSZWYpIHtcbiAgICAgICAgc2V0VGFyZ2V0V2lkdGgodGFyZ2V0UmVmLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLndpZHRoKVxuICAgICAgfVxuICAgIH0sIFt0YXJnZXRSZWZdKVxuXG4gICAgY29uc3Qgc3RhdGVSZWR1Y2VyID0gdXNlQ2FsbGJhY2soXG4gICAgICAoc3RhdGUsIGNoYW5nZXMpID0+IHtcbiAgICAgICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChjaGFuZ2VzLCAnaXNPcGVuJykgJiYgY2hhbmdlcy5pc09wZW4pIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uY2hhbmdlcyxcbiAgICAgICAgICAgIGhpZ2hsaWdodGVkSW5kZXg6IHByb3BzLml0ZW1zLmluZGV4T2Yoc3RhdGUuc2VsZWN0ZWRJdGVtKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9wcy5hbGxvd090aGVyVmFsdWVzICYmIHN0YXRlLmlzT3BlbiAmJiAhY2hhbmdlcy5pc09wZW4pIHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uY2hhbmdlcyxcbiAgICAgICAgICAgIHNlbGVjdGVkSXRlbTogY2hhbmdlcy5zZWxlY3RlZEl0ZW0gfHwgc3RhdGUuaW5wdXRWYWx1ZSxcbiAgICAgICAgICAgIGlucHV0VmFsdWU6IHN0YXRlLmlucHV0VmFsdWVcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gY2hhbmdlc1xuICAgICAgfSxcbiAgICAgIFtwcm9wcy5pdGVtcywgcHJvcHMuYWxsb3dPdGhlclZhbHVlc11cbiAgICApXG5cbiAgICByZXR1cm4gKFxuICAgICAgPERvd25zaGlmdCBzdGF0ZVJlZHVjZXI9e3N0YXRlUmVkdWNlcn0gc2Nyb2xsSW50b1ZpZXc9e25vb3B9IGl0ZW1Ub1N0cmluZz17aXRlbVRvU3RyaW5nfSByZWY9e3JlZn0gey4uLnJlc3RQcm9wc30+XG4gICAgICAgIHsoe1xuICAgICAgICAgIGdldEl0ZW1Qcm9wcyxcbiAgICAgICAgICBnZXRNZW51UHJvcHMsXG4gICAgICAgICAgZ2V0Um9vdFByb3BzLFxuICAgICAgICAgIGhpZ2hsaWdodGVkSW5kZXgsXG4gICAgICAgICAgaW5wdXRWYWx1ZSxcbiAgICAgICAgICBpc09wZW46IGlzU2hvd24sXG4gICAgICAgICAgc2VsZWN0ZWRJdGVtLFxuICAgICAgICAgIC4uLnJlc3REb3duc2hpZnRQcm9wc1xuICAgICAgICB9KSA9PiAoXG4gICAgICAgICAgPGRpdiBzdHlsZT17Y29udGFpbmVyU3R5bGV9PlxuICAgICAgICAgICAgPFBvcG92ZXJcbiAgICAgICAgICAgICAgYnJpbmdGb2N1c0luc2lkZT17ZmFsc2V9XG4gICAgICAgICAgICAgIGlzU2hvd249e2lzU2hvd259XG4gICAgICAgICAgICAgIG1pbldpZHRoPXtwb3BvdmVyTWluV2lkdGh9XG4gICAgICAgICAgICAgIHBvc2l0aW9uPXtwb3NpdGlvbiB8fCAodGFyZ2V0V2lkdGggPCBwb3BvdmVyTWluV2lkdGggPyBQb3NpdGlvbi5CT1RUT01fTEVGVCA6IFBvc2l0aW9uLkJPVFRPTSl9XG4gICAgICAgICAgICAgIGNvbnRlbnQ9e1xuICAgICAgICAgICAgICAgIDxBdXRvY29tcGxldGVJdGVtc1xuICAgICAgICAgICAgICAgICAgZ2V0SXRlbVByb3BzPXtnZXRJdGVtUHJvcHN9XG4gICAgICAgICAgICAgICAgICBnZXRNZW51UHJvcHM9e2dldE1lbnVQcm9wc31cbiAgICAgICAgICAgICAgICAgIGhpZ2hsaWdodGVkSW5kZXg9e2hpZ2hsaWdodGVkSW5kZXh9XG4gICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlPXtpbnB1dFZhbHVlfVxuICAgICAgICAgICAgICAgICAgaXNGaWx0ZXJEaXNhYmxlZD17aXNGaWx0ZXJEaXNhYmxlZH1cbiAgICAgICAgICAgICAgICAgIGl0ZW1zRmlsdGVyPXtpdGVtc0ZpbHRlcn1cbiAgICAgICAgICAgICAgICAgIGl0ZW1TaXplPXtpdGVtU2l6ZX1cbiAgICAgICAgICAgICAgICAgIGl0ZW1Ub1N0cmluZz17aXRlbVRvU3RyaW5nfVxuICAgICAgICAgICAgICAgICAgb3JpZ2luYWxJdGVtcz17cHJvcHMuaXRlbXN9XG4gICAgICAgICAgICAgICAgICBwb3BvdmVyTWF4SGVpZ2h0PXtwb3BvdmVyTWF4SGVpZ2h0fVxuICAgICAgICAgICAgICAgICAgcmVuZGVySXRlbT17cmVuZGVySXRlbX1cbiAgICAgICAgICAgICAgICAgIHNlbGVjdGVkSXRlbT17c2VsZWN0ZWRJdGVtfVxuICAgICAgICAgICAgICAgICAgdGl0bGU9e3Byb3BzLnRpdGxlfVxuICAgICAgICAgICAgICAgICAgd2lkdGg9e01hdGgubWF4KHRhcmdldFdpZHRoLCBwb3BvdmVyTWluV2lkdGgpfVxuICAgICAgICAgICAgICAgIC8+XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgbWluSGVpZ2h0PXswfVxuICAgICAgICAgICAgICBhbmltYXRpb25EdXJhdGlvbj17MH1cbiAgICAgICAgICAgID5cbiAgICAgICAgICAgICAgeyh7IGdldFJlZiwgaXNTaG93bjogaXNTaG93blBvcG92ZXIsIHRvZ2dsZSB9KSA9PlxuICAgICAgICAgICAgICAgIGNoaWxkcmVuKHtcbiAgICAgICAgICAgICAgICAgIGlzU2hvd246IGlzU2hvd25Qb3BvdmVyLFxuICAgICAgICAgICAgICAgICAgdG9nZ2xlLFxuICAgICAgICAgICAgICAgICAgZ2V0UmVmOiByZWYgPT4ge1xuICAgICAgICAgICAgICAgICAgICAvLyBVc2UgdGhlIHJlZiBpbnRlcm5hbGx5IHRvIGRldGVybWluZSB0aGUgd2lkdGhcbiAgICAgICAgICAgICAgICAgICAgc2V0VGFyZ2V0UmVmKHJlZilcbiAgICAgICAgICAgICAgICAgICAgZ2V0UmVmKHJlZilcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBpbnB1dFZhbHVlLFxuICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRJdGVtLFxuICAgICAgICAgICAgICAgICAgaGlnaGxpZ2h0ZWRJbmRleCxcbiAgICAgICAgICAgICAgICAgIC4uLnJlc3REb3duc2hpZnRQcm9wc1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIDwvUG9wb3Zlcj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgKX1cbiAgICAgIDwvRG93bnNoaWZ0PlxuICAgIClcbiAgfSlcbilcblxuQXV0b2NvbXBsZXRlLnByb3BUeXBlcyA9IHtcbiAgLyoqXG4gICAqIFRoaXMgcHJvcCBjYW4gYmUgZWl0aGVyIGEgc3RyaW5nIG9yIGEgTm9kZS5cbiAgICogSXQgd2lsbCBwcm92aWRlIGEgdGl0bGUgZm9yIHRoZSBpdGVtc1xuICAgKi9cbiAgdGl0bGU6IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zdHJpbmcsIFByb3BUeXBlcy5ub2RlXSksXG5cbiAgLyoqXG4gICAqIEFuIGFycmF5IG9mIGl0ZW1zIHRvIGJlIHVzZWQgYXMgb3B0aW9ucyBmb3IgdGhlIHNlbGVjdFxuICAgKi9cbiAgaXRlbXM6IFByb3BUeXBlcy5hcnJheS5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBUaGUgc2VsZWN0ZWQgSXRlbSB0byBiZSBzaG93biBvbiB0aGUgYXV0b2NvbXBsZXRlXG4gICAqL1xuICBzZWxlY3RlZEl0ZW06IFByb3BUeXBlcy5hbnksXG5cbiAgLyoqXG4gICAqIEluIGNhc2UgdGhlIGFycmF5IG9mIGl0ZW1zIGlzIG5vdCBhbiBhcnJheSBvZiBzdHJpbmdzLFxuICAgKiB0aGlzIGZ1bmN0aW9uIGlzIHVzZWQgb24gZWFjaCBpdGVtIHRvIHJldHVybiB0aGUgc3RyaW5nIHRoYXQgd2lsbCBiZSBzaG93biBvbiB0aGUgZmlsdGVyXG4gICAqL1xuICBpdGVtVG9TdHJpbmc6IFByb3BUeXBlcy5mdW5jLFxuXG4gIC8qKlxuICAgKiBGdW5jdGlvbiB0aGF0IHdpbGwgcmVuZGVyIHRoZSAnZmlsdGVyJyBjb21wb25lbnQuXG4gICAqL1xuICBjaGlsZHJlbjogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogVGhlIGhlaWdodCBvZiBlYWNoIGl0ZW0gaW4gdGhlIGxpc3RcbiAgICogQmVjYXVzZSB0aGUgbGlzdCBpcyB2aXJ0dWFsaXplZCB0aGlzIGlzIHJlcXVpcmVkIGJlZm9yZWhhbmQuXG4gICAqL1xuICBpdGVtU2l6ZTogUHJvcFR5cGVzLm51bWJlcixcblxuICAvKipcbiAgICogRnVuY3Rpb24gdGhhdCByZXR1cm5zIGEgY29tcG9uZW50IHRvIHJlbmRlciB0aGUgaXRlbVxuICAgKi9cbiAgcmVuZGVySXRlbTogUHJvcFR5cGVzLmZ1bmMsXG5cbiAgLyoqXG4gICAqIFRoZSBwb3NpdGlvbiBvZiB0aGUgUG9wb3ZlciB0aGUgQXV0b2NvbXBsZXRlIGlzIHJlbmRlcmVkIGluLlxuICAgKi9cbiAgcG9zaXRpb246IFByb3BUeXBlcy5vbmVPZihbXG4gICAgUG9zaXRpb24uVE9QLFxuICAgIFBvc2l0aW9uLlRPUF9MRUZULFxuICAgIFBvc2l0aW9uLlRPUF9SSUdIVCxcbiAgICBQb3NpdGlvbi5CT1RUT00sXG4gICAgUG9zaXRpb24uQk9UVE9NX0xFRlQsXG4gICAgUG9zaXRpb24uQk9UVE9NX1JJR0hULFxuICAgIFBvc2l0aW9uLkxFRlQsXG4gICAgUG9zaXRpb24uUklHSFRcbiAgXSksXG5cbiAgLyoqXG4gICAqIEEgZnVuY3Rpb24gdGhhdCBpcyB1c2VkIHRvIGZpbHRlciB0aGUgaXRlbXMuXG4gICAqIEl0IHNob3VsZCByZXR1cm4gYSBzdWJzZXQgb2YgdGhlIGluaXRpYWwgaXRlbXMuXG4gICAqIEJ5IGRlZmF1bHQgdGhlIFwiZnV6emFsZHJpbi1wbHVzXCIgcGFja2FnZSBpcyB1c2VkLlxuICAgKi9cbiAgaXRlbXNGaWx0ZXI6IFByb3BUeXBlcy5mdW5jLFxuXG4gIC8qKlxuICAgKiBQcm9wIHRoYXQgZW5hYmxlcyBhbmQgZGlzYWJsZXMgZmlsdGVyaW5nXG4gICAqIFRydWU6IEVuYWJsZXMgRmlsdGVyaW5nXG4gICAqIEZhbHNlOiBEaXNhYmxlcyBGaWx0ZXJpbmdcbiAgICovXG4gIGlzRmlsdGVyRGlzYWJsZWQ6IFByb3BUeXBlcy5ib29sLFxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIHRoZSBtaW5pbXVtIGhlaWdodCB0aGUgcmVzdWx0cyBjb250YWluZXIgd2lsbCBiZVxuICAgKi9cbiAgcG9wb3Zlck1pbldpZHRoOiBQcm9wVHlwZXMubnVtYmVyLFxuXG4gIC8qKlxuICAgKiBEZWZpbmVzIHRoZSBtYXhpbXVtIGhlaWdodCB0aGUgcmVzdWx0cyBjb250YWluZXIgd2lsbCBiZVxuICAgKi9cbiAgcG9wb3Zlck1heEhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGhlIGlucHV0IGFjY2VwdHMgYXJiaXRyYXJ5IHVzZXIgaW5wdXQgYmV5b25kIHRoZSBwcm92aWRlZCBpdGVtc1xuICAgKi9cbiAgYWxsb3dPdGhlclZhbHVlczogUHJvcFR5cGVzLmJvb2wsXG5cbiAgLi4uRG93bnNoaWZ0LnByb3BUeXBlc1xufVxuXG5leHBvcnQgZGVmYXVsdCBBdXRvY29tcGxldGVcbiJdfQ==