import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import React, { memo, useRef, useState, useMemo, useCallback, useLayoutEffect } from 'react';
import PropTypes from 'prop-types';
import { useLatest } from '../../hooks';
import { Textarea } from '../../textarea';

function getTableBodyRef(currentRef) {
  var ref = currentRef;
  if (!ref) return;

  while (ref) {
    var isTableBody = ref.hasAttribute('data-evergreen-table-body');

    if (isTableBody) {
      return ref;
    }

    if (ref.parentElement) {
      ref = ref.parentElement;
    } else {
      return null;
    }
  }

  return ref;
}

var EditableCellField = /*#__PURE__*/memo(function EditableCellField(props) {
  var _props$minHeight = props.minHeight,
      minHeight = _props$minHeight === void 0 ? 40 : _props$minHeight,
      _props$minWidth = props.minWidth,
      minWidth = _props$minWidth === void 0 ? 80 : _props$minWidth,
      size = props.size,
      value = props.value,
      zIndex = props.zIndex;
  var latestAnimationFrame = useRef();
  var textareaRef = useRef();
  var tableBodyRef = useRef();
  var onCancelRef = useLatest(props.onCancel);
  var onChangeCompleteRef = useLatest(props.onChangeComplete);
  var getTargetRef = useLatest(props.getTargetRef);

  var _useState = useState(0),
      _useState2 = _slicedToArray(_useState, 2),
      height = _useState2[0],
      setHeight = _useState2[1];

  var _useState3 = useState(0),
      _useState4 = _slicedToArray(_useState3, 2),
      width = _useState4[0],
      setWidth = _useState4[1];

  var _useState5 = useState(0),
      _useState6 = _slicedToArray(_useState5, 2),
      left = _useState6[0],
      setLeft = _useState6[1];

  var _useState7 = useState(0),
      _useState8 = _slicedToArray(_useState7, 2),
      top = _useState8[0],
      setTop = _useState8[1];

  var update = useCallback(function () {
    function updater() {
      var targetRef = getTargetRef.current();
      if (!targetRef) return;
      tableBodyRef.current = getTableBodyRef(targetRef);

      var _targetRef$getBoundin = targetRef.getBoundingClientRect(),
          targetHeight = _targetRef$getBoundin.height,
          targetLeft = _targetRef$getBoundin.left,
          targetTop = _targetRef$getBoundin.top,
          targetWidth = _targetRef$getBoundin.width;

      var calculatedTop;

      if (tableBodyRef.current) {
        var bounds = tableBodyRef.current.getBoundingClientRect();
        calculatedTop = Math.min(Math.max(targetTop, bounds.top), bounds.bottom - targetHeight);
      } else {
        calculatedTop = targetTop;
      }

      setHeight(targetHeight);
      setWidth(targetWidth);
      setLeft(targetLeft);
      setTop(calculatedTop); // recursively run the updater

      latestAnimationFrame.current = requestAnimationFrame(function () {
        return updater();
      });
    } // kick off the updater


    updater(); // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []); // Mirrors functionality of componentDidMount and componentWillUnmount.
  // Focus on mount

  useLayoutEffect(function () {
    update();
    var requestId = requestAnimationFrame(function () {
      if (textareaRef.current) {
        textareaRef.current.focus();
      }
    });
    return function () {
      cancelAnimationFrame(requestId);

      if (latestAnimationFrame.current) {
        cancelAnimationFrame(latestAnimationFrame.current);
      } // eslint-disable-next-line react-hooks/exhaustive-deps


      onCancelRef.current();
    }; // we only want `update` to run once, and `onCancelRef` is a ref
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);
  var handleFocus = useCallback(function (e) {
    e.target.selectionStart = e.target.value.length;
  }, []);
  var handleBlur = useCallback(function () {
    if (textareaRef.current) {
      onChangeCompleteRef.current(textareaRef.current.value);
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var handleKeyDown = useCallback(function (e) {
    switch (e.key) {
      case 'Escape':
        onCancelRef.current();
        if (textareaRef.current) textareaRef.current.blur();
        break;

      case 'Enter':
        if (textareaRef.current) textareaRef.current.blur();
        e.preventDefault();
        break;

      case 'Tab':
        if (textareaRef.current) textareaRef.current.blur();
        break;

      default:
        break;
    } // eslint-disable-next-line react-hooks/exhaustive-deps

  }, []);
  var style = useMemo(function () {
    return {
      left: left,
      top: top,
      height: height,
      minHeight: Math.max(height, minHeight),
      width: width,
      minWidth: Math.max(width, minWidth),
      zIndex: zIndex
    };
  }, [left, top, height, width, minHeight, minWidth, zIndex]);
  return /*#__PURE__*/React.createElement(Textarea, {
    ref: textareaRef,
    onKeyDown: handleKeyDown,
    onBlur: handleBlur,
    onFocus: handleFocus,
    appearance: "editable-cell",
    size: size,
    style: style,
    height: null,
    width: null,
    minHeight: null,
    position: "fixed",
    defaultValue: value
  });
});
EditableCellField.propTypes = {
  /**
   * Used as the defaultValue of the textarea.
   */
  value: PropTypes.string.isRequired,

  /**
   * The z-index placed on the element.
   */
  zIndex: PropTypes.number.isRequired,

  /**
   * Function to get the target ref of the parent.
   * Used to mirror the position.
   */
  getTargetRef: PropTypes.func.isRequired,

  /**
   * Min width of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minWidth: PropTypes.number,

  /**
   * Min height of the textarea.
   * The textarea can never be smaller than the cell.
   */
  minHeight: PropTypes.number,

  /**
   * Called when the textarea is blurred, pass the value back to the cell.
   */
  onChangeComplete: PropTypes.func.isRequired,

  /**
   * Called when Escape is hit or componentWillUnmount.
   */
  onCancel: PropTypes.func.isRequired,

  /**
   * Text size of the textarea.
   */
  size: PropTypes.number
};
export default EditableCellField;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvRWRpdGFibGVDZWxsRmllbGQuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJtZW1vIiwidXNlUmVmIiwidXNlU3RhdGUiLCJ1c2VNZW1vIiwidXNlQ2FsbGJhY2siLCJ1c2VMYXlvdXRFZmZlY3QiLCJQcm9wVHlwZXMiLCJ1c2VMYXRlc3QiLCJUZXh0YXJlYSIsImdldFRhYmxlQm9keVJlZiIsImN1cnJlbnRSZWYiLCJyZWYiLCJpc1RhYmxlQm9keSIsImhhc0F0dHJpYnV0ZSIsInBhcmVudEVsZW1lbnQiLCJFZGl0YWJsZUNlbGxGaWVsZCIsInByb3BzIiwibWluSGVpZ2h0IiwibWluV2lkdGgiLCJzaXplIiwidmFsdWUiLCJ6SW5kZXgiLCJsYXRlc3RBbmltYXRpb25GcmFtZSIsInRleHRhcmVhUmVmIiwidGFibGVCb2R5UmVmIiwib25DYW5jZWxSZWYiLCJvbkNhbmNlbCIsIm9uQ2hhbmdlQ29tcGxldGVSZWYiLCJvbkNoYW5nZUNvbXBsZXRlIiwiZ2V0VGFyZ2V0UmVmIiwiaGVpZ2h0Iiwic2V0SGVpZ2h0Iiwid2lkdGgiLCJzZXRXaWR0aCIsImxlZnQiLCJzZXRMZWZ0IiwidG9wIiwic2V0VG9wIiwidXBkYXRlIiwidXBkYXRlciIsInRhcmdldFJlZiIsImN1cnJlbnQiLCJnZXRCb3VuZGluZ0NsaWVudFJlY3QiLCJ0YXJnZXRIZWlnaHQiLCJ0YXJnZXRMZWZ0IiwidGFyZ2V0VG9wIiwidGFyZ2V0V2lkdGgiLCJjYWxjdWxhdGVkVG9wIiwiYm91bmRzIiwiTWF0aCIsIm1pbiIsIm1heCIsImJvdHRvbSIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInJlcXVlc3RJZCIsImZvY3VzIiwiY2FuY2VsQW5pbWF0aW9uRnJhbWUiLCJoYW5kbGVGb2N1cyIsImUiLCJ0YXJnZXQiLCJzZWxlY3Rpb25TdGFydCIsImxlbmd0aCIsImhhbmRsZUJsdXIiLCJoYW5kbGVLZXlEb3duIiwia2V5IiwiYmx1ciIsInByZXZlbnREZWZh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V0UsSUFBQSxRQUFRLEVBQUMsT0FYWDtBQVlFLElBQUEsWUFBWSxFQUFFL0M7QUFaaEIsSUFERjtBQWdCRCxDQXJJNkIsQ0FBOUI7QUF1SUFMLGlCQUFpQixDQUFDcUQsU0FBbEIsR0FBOEI7QUFDNUI7QUFDRjtBQUNBO0FBQ0VoRCxFQUFBQSxLQUFLLEVBQUVkLFNBQVMsQ0FBQytELE1BQVYsQ0FBaUJDLFVBSkk7O0FBTTVCO0FBQ0Y7QUFDQTtBQUNFakQsRUFBQUEsTUFBTSxFQUFFZixTQUFTLENBQUNpRSxNQUFWLENBQWlCRCxVQVRHOztBQVc1QjtBQUNGO0FBQ0E7QUFDQTtBQUNFekMsRUFBQUEsWUFBWSxFQUFFdkIsU0FBUyxDQUFDa0UsSUFBVixDQUFlRixVQWZEOztBQWlCNUI7QUFDRjtBQUNBO0FBQ0E7QUFDRXBELEVBQUFBLFFBQVEsRUFBRVosU0FBUyxDQUFDaUUsTUFyQlE7O0FBdUI1QjtBQUNGO0FBQ0E7QUFDQTtBQUNFdEQsRUFBQUEsU0FBUyxFQUFFWCxTQUFTLENBQUNpRSxNQTNCTzs7QUE2QjVCO0FBQ0Y7QUFDQTtBQUNFM0MsRUFBQUEsZ0JBQWdCLEVBQUV0QixTQUFTLENBQUNrRSxJQUFWLENBQWVGLFVBaENMOztBQWtDNUI7QUFDRjtBQUNBO0FBQ0U1QyxFQUFBQSxRQUFRLEVBQUVwQixTQUFTLENBQUNrRSxJQUFWLENBQWVGLFVBckNHOztBQXVDNUI7QUFDRjtBQUNBO0FBQ0VuRCxFQUFBQSxJQUFJLEVBQUViLFNBQVMsQ0FBQ2lFO0FBMUNZLENBQTlCO0FBNkNBLGVBQWV4RCxpQkFBZiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyBtZW1vLCB1c2VSZWYsIHVzZVN0YXRlLCB1c2VNZW1vLCB1c2VDYWxsYmFjaywgdXNlTGF5b3V0RWZmZWN0IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgeyB1c2VMYXRlc3QgfSBmcm9tICcuLi8uLi9ob29rcydcbmltcG9ydCB7IFRleHRhcmVhIH0gZnJvbSAnLi4vLi4vdGV4dGFyZWEnXG5cbmZ1bmN0aW9uIGdldFRhYmxlQm9keVJlZihjdXJyZW50UmVmKSB7XG4gIGxldCByZWYgPSBjdXJyZW50UmVmXG5cbiAgaWYgKCFyZWYpIHJldHVyblxuXG4gIHdoaWxlIChyZWYpIHtcbiAgICBjb25zdCBpc1RhYmxlQm9keSA9IHJlZi5oYXNBdHRyaWJ1dGUoJ2RhdGEtZXZlcmdyZWVuLXRhYmxlLWJvZHknKVxuICAgIGlmIChpc1RhYmxlQm9keSkge1xuICAgICAgcmV0dXJuIHJlZlxuICAgIH1cblxuICAgIGlmIChyZWYucGFyZW50RWxlbWVudCkge1xuICAgICAgcmVmID0gcmVmLnBhcmVudEVsZW1lbnRcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG51bGxcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVmXG59XG5cbmNvbnN0IEVkaXRhYmxlQ2VsbEZpZWxkID0gbWVtbyhmdW5jdGlvbiBFZGl0YWJsZUNlbGxGaWVsZChwcm9wcykge1xuICBjb25zdCB7IG1pbkhlaWdodCA9IDQwLCBtaW5XaWR0aCA9IDgwLCBzaXplLCB2YWx1ZSwgekluZGV4IH0gPSBwcm9wc1xuXG4gIGNvbnN0IGxhdGVzdEFuaW1hdGlvbkZyYW1lID0gdXNlUmVmKClcbiAgY29uc3QgdGV4dGFyZWFSZWYgPSB1c2VSZWYoKVxuICBjb25zdCB0YWJsZUJvZHlSZWYgPSB1c2VSZWYoKVxuICBjb25zdCBvbkNhbmNlbFJlZiA9IHVzZUxhdGVzdChwcm9wcy5vbkNhbmNlbClcbiAgY29uc3Qgb25DaGFuZ2VDb21wbGV0ZVJlZiA9IHVzZUxhdGVzdChwcm9wcy5vbkNoYW5nZUNvbXBsZXRlKVxuICBjb25zdCBnZXRUYXJnZXRSZWYgPSB1c2VMYXRlc3QocHJvcHMuZ2V0VGFyZ2V0UmVmKVxuICBjb25zdCBbaGVpZ2h0LCBzZXRIZWlnaHRdID0gdXNlU3RhdGUoMClcbiAgY29uc3QgW3dpZHRoLCBzZXRXaWR0aF0gPSB1c2VTdGF0ZSgwKVxuICBjb25zdCBbbGVmdCwgc2V0TGVmdF0gPSB1c2VTdGF0ZSgwKVxuICBjb25zdCBbdG9wLCBzZXRUb3BdID0gdXNlU3RhdGUoMClcblxuICBjb25zdCB1cGRhdGUgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgZnVuY3Rpb24gdXBkYXRlcigpIHtcbiAgICAgIGNvbnN0IHRhcmdldFJlZiA9IGdldFRhcmdldFJlZi5jdXJyZW50KClcbiAgICAgIGlmICghdGFyZ2V0UmVmKSByZXR1cm5cbiAgICAgIHRhYmxlQm9keVJlZi5jdXJyZW50ID0gZ2V0VGFibGVCb2R5UmVmKHRhcmdldFJlZilcblxuICAgICAgY29uc3Qge1xuICAgICAgICBoZWlnaHQ6IHRhcmdldEhlaWdodCxcbiAgICAgICAgbGVmdDogdGFyZ2V0TGVmdCxcbiAgICAgICAgdG9wOiB0YXJnZXRUb3AsXG4gICAgICAgIHdpZHRoOiB0YXJnZXRXaWR0aFxuICAgICAgfSA9IHRhcmdldFJlZi5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gICAgICBsZXQgY2FsY3VsYXRlZFRvcFxuICAgICAgaWYgKHRhYmxlQm9keVJlZi5jdXJyZW50KSB7XG4gICAgICAgIGNvbnN0IGJvdW5kcyA9IHRhYmxlQm9keVJlZi5jdXJyZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpXG4gICAgICAgIGNhbGN1bGF0ZWRUb3AgPSBNYXRoLm1pbihNYXRoLm1heCh0YXJnZXRUb3AsIGJvdW5kcy50b3ApLCBib3VuZHMuYm90dG9tIC0gdGFyZ2V0SGVpZ2h0KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FsY3VsYXRlZFRvcCA9IHRhcmdldFRvcFxuICAgICAgfVxuXG4gICAgICBzZXRIZWlnaHQodGFyZ2V0SGVpZ2h0KVxuICAgICAgc2V0V2lkdGgodGFyZ2V0V2lkdGgpXG4gICAgICBzZXRMZWZ0KHRhcmdldExlZnQpXG4gICAgICBzZXRUb3AoY2FsY3VsYXRlZFRvcClcblxuICAgICAgLy8gcmVjdXJzaXZlbHkgcnVuIHRoZSB1cGRhdGVyXG4gICAgICBsYXRlc3RBbmltYXRpb25GcmFtZS5jdXJyZW50ID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHVwZGF0ZXIoKSlcbiAgICB9XG5cbiAgICAvLyBraWNrIG9mZiB0aGUgdXBkYXRlclxuICAgIHVwZGF0ZXIoKVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgfSwgW10pXG5cbiAgLy8gTWlycm9ycyBmdW5jdGlvbmFsaXR5IG9mIGNvbXBvbmVudERpZE1vdW50IGFuZCBjb21wb25lbnRXaWxsVW5tb3VudC5cbiAgLy8gRm9jdXMgb24gbW91bnRcbiAgdXNlTGF5b3V0RWZmZWN0KCgpID0+IHtcbiAgICB1cGRhdGUoKVxuXG4gICAgY29uc3QgcmVxdWVzdElkID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIGlmICh0ZXh0YXJlYVJlZi5jdXJyZW50KSB7XG4gICAgICAgIHRleHRhcmVhUmVmLmN1cnJlbnQuZm9jdXMoKVxuICAgICAgfVxuICAgIH0pXG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkKVxuXG4gICAgICBpZiAobGF0ZXN0QW5pbWF0aW9uRnJhbWUuY3VycmVudCkge1xuICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZShsYXRlc3RBbmltYXRpb25GcmFtZS5jdXJyZW50KVxuICAgICAgfVxuXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgcmVhY3QtaG9va3MvZXhoYXVzdGl2ZS1kZXBzXG4gICAgICBvbkNhbmNlbFJlZi5jdXJyZW50KClcbiAgICB9XG4gICAgLy8gd2Ugb25seSB3YW50IGB1cGRhdGVgIHRvIHJ1biBvbmNlLCBhbmQgYG9uQ2FuY2VsUmVmYCBpcyBhIHJlZlxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgfSwgW10pXG5cbiAgY29uc3QgaGFuZGxlRm9jdXMgPSB1c2VDYWxsYmFjayhlID0+IHtcbiAgICBlLnRhcmdldC5zZWxlY3Rpb25TdGFydCA9IGUudGFyZ2V0LnZhbHVlLmxlbmd0aFxuICB9LCBbXSlcblxuICBjb25zdCBoYW5kbGVCbHVyID0gdXNlQ2FsbGJhY2soKCkgPT4ge1xuICAgIGlmICh0ZXh0YXJlYVJlZi5jdXJyZW50KSB7XG4gICAgICBvbkNoYW5nZUNvbXBsZXRlUmVmLmN1cnJlbnQodGV4dGFyZWFSZWYuY3VycmVudC52YWx1ZSlcbiAgICB9XG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIHJlYWN0LWhvb2tzL2V4aGF1c3RpdmUtZGVwc1xuICB9LCBbXSlcblxuICBjb25zdCBoYW5kbGVLZXlEb3duID0gdXNlQ2FsbGJhY2soZSA9PiB7XG4gICAgc3dpdGNoIChlLmtleSkge1xuICAgICAgY2FzZSAnRXNjYXBlJzpcbiAgICAgICAgb25DYW5jZWxSZWYuY3VycmVudCgpXG4gICAgICAgIGlmICh0ZXh0YXJlYVJlZi5jdXJyZW50KSB0ZXh0YXJlYVJlZi5jdXJyZW50LmJsdXIoKVxuICAgICAgICBicmVha1xuICAgICAgY2FzZSAnRW50ZXInOlxuICAgICAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkgdGV4dGFyZWFSZWYuY3VycmVudC5ibHVyKClcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpXG4gICAgICAgIGJyZWFrXG4gICAgICBjYXNlICdUYWInOlxuICAgICAgICBpZiAodGV4dGFyZWFSZWYuY3VycmVudCkgdGV4dGFyZWFSZWYuY3VycmVudC5ibHVyKClcbiAgICAgICAgYnJlYWtcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGJyZWFrXG4gICAgfVxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSByZWFjdC1ob29rcy9leGhhdXN0aXZlLWRlcHNcbiAgfSwgW10pXG5cbiAgY29uc3Qgc3R5bGUgPSB1c2VNZW1vKFxuICAgICgpID0+ICh7XG4gICAgICBsZWZ0LFxuICAgICAgdG9wLFxuICAgICAgaGVpZ2h0LFxuICAgICAgbWluSGVpZ2h0OiBNYXRoLm1heChoZWlnaHQsIG1pbkhlaWdodCksXG4gICAgICB3aWR0aCxcbiAgICAgIG1pbldpZHRoOiBNYXRoLm1heCh3aWR0aCwgbWluV2lkdGgpLFxuICAgICAgekluZGV4XG4gICAgfSksXG4gICAgW2xlZnQsIHRvcCwgaGVpZ2h0LCB3aWR0aCwgbWluSGVpZ2h0LCBtaW5XaWR0aCwgekluZGV4XVxuICApXG5cbiAgcmV0dXJuIChcbiAgICA8VGV4dGFyZWFcbiAgICAgIHJlZj17dGV4dGFyZWFSZWZ9XG4gICAgICBvbktleURvd249e2hhbmRsZUtleURvd259XG4gICAgICBvbkJsdXI9e2hhbmRsZUJsdXJ9XG4gICAgICBvbkZvY3VzPXtoYW5kbGVGb2N1c31cbiAgICAgIGFwcGVhcmFuY2U9XCJlZGl0YWJsZS1jZWxsXCJcbiAgICAgIHNpemU9e3NpemV9XG4gICAgICBzdHlsZT17c3R5bGV9XG4gICAgICBoZWlnaHQ9e251bGx9XG4gICAgICB3aWR0aD17bnVsbH1cbiAgICAgIG1pbkhlaWdodD17bnVsbH1cbiAgICAgIHBvc2l0aW9uPVwiZml4ZWRcIlxuICAgICAgZGVmYXVsdFZhbHVlPXt2YWx1ZX1cbiAgICAvPlxuICApXG59KVxuXG5FZGl0YWJsZUNlbGxGaWVsZC5wcm9wVHlwZXMgPSB7XG4gIC8qKlxuICAgKiBVc2VkIGFzIHRoZSBkZWZhdWx0VmFsdWUgb2YgdGhlIHRleHRhcmVhLlxuICAgKi9cbiAgdmFsdWU6IFByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcblxuICAvKipcbiAgICogVGhlIHotaW5kZXggcGxhY2VkIG9uIHRoZSBlbGVtZW50LlxuICAgKi9cbiAgekluZGV4OiBQcm9wVHlwZXMubnVtYmVyLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIEZ1bmN0aW9uIHRvIGdldCB0aGUgdGFyZ2V0IHJlZiBvZiB0aGUgcGFyZW50LlxuICAgKiBVc2VkIHRvIG1pcnJvciB0aGUgcG9zaXRpb24uXG4gICAqL1xuICBnZXRUYXJnZXRSZWY6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIE1pbiB3aWR0aCBvZiB0aGUgdGV4dGFyZWEuXG4gICAqIFRoZSB0ZXh0YXJlYSBjYW4gbmV2ZXIgYmUgc21hbGxlciB0aGFuIHRoZSBjZWxsLlxuICAgKi9cbiAgbWluV2lkdGg6IFByb3BUeXBlcy5udW1iZXIsXG5cbiAgLyoqXG4gICAqIE1pbiBoZWlnaHQgb2YgdGhlIHRleHRhcmVhLlxuICAgKiBUaGUgdGV4dGFyZWEgY2FuIG5ldmVyIGJlIHNtYWxsZXIgdGhhbiB0aGUgY2VsbC5cbiAgICovXG4gIG1pbkhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcblxuICAvKipcbiAgICogQ2FsbGVkIHdoZW4gdGhlIHRleHRhcmVhIGlzIGJsdXJyZWQsIHBhc3MgdGhlIHZhbHVlIGJhY2sgdG8gdGhlIGNlbGwuXG4gICAqL1xuICBvbkNoYW5nZUNvbXBsZXRlOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuXG4gIC8qKlxuICAgKiBDYWxsZWQgd2hlbiBFc2NhcGUgaXMgaGl0IG9yIGNvbXBvbmVudFdpbGxVbm1vdW50LlxuICAgKi9cbiAgb25DYW5jZWw6IFByb3BUeXBlcy5mdW5jLmlzUmVxdWlyZWQsXG5cbiAgLyoqXG4gICAqIFRleHQgc2l6ZSBvZiB0aGUgdGV4dGFyZWEuXG4gICAqL1xuICBzaXplOiBQcm9wVHlwZXMubnVtYmVyXG59XG5cbmV4cG9ydCBkZWZhdWx0IEVkaXRhYmxlQ2VsbEZpZWxkXG4iXX0=