import _extends from "@babel/runtime/helpers/esm/extends";
import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
var _excluded = ["options", "optionSize", "close", "closeOnSelect", "onSelect", "onDeselect", "onFilterChange", "hasFilter", "selected", "optionsFilter", "isMultiSelect", "height", "width", "renderItem", "filterPlaceholder", "filterIcon", "defaultSearchValue"];
import React, { memo, useCallback, useEffect, useMemo, useRef, useState } from 'react';
import VirtualList from '@segment/react-tiny-virtual-list';
import fuzzaldrin from 'fuzzaldrin-plus';
import PropTypes from 'prop-types';
import { SearchIcon } from '../../icons';
import { Image } from '../../image';
import { Pane } from '../../layers';
import SearchTableHeaderCell from '../../table/src/SearchTableHeaderCell';
import TableHead from '../../table/src/TableHead';
import { useTheme } from '../../theme';
import Option from './Option';
import OptionShapePropType from './OptionShapePropType';
/**
 * Fuzzaldrin-plus is the default filter, but you can use your own
 * as long as they follow the following signature:
 * @param options <Array[String]> - ['label', 'label2', ...]
 * @param input <String>
 */

var fuzzyFilter = function fuzzyFilter(options, input, _ref) {
  var key = _ref.key;
  return fuzzaldrin.filter(options, input, {
    key: key
  });
};

var noop = function noop() {};

var defaultRenderItem = function defaultRenderItem(props) {
  return /*#__PURE__*/React.createElement(Option, props, props.icon && /*#__PURE__*/React.createElement(Image, {
    src: props.icon,
    width: 24,
    marginRight: 8
  }), props.label);
};

defaultRenderItem.displayName = "defaultRenderItem";
var OptionsList = /*#__PURE__*/memo(function OptionsList(props) {
  var _props$options = props.options,
      originalOptions = _props$options === void 0 ? [] : _props$options,
      _props$optionSize = props.optionSize,
      optionSize = _props$optionSize === void 0 ? 33 : _props$optionSize,
      close = props.close,
      closeOnSelect = props.closeOnSelect,
      _props$onSelect = props.onSelect,
      onSelect = _props$onSelect === void 0 ? noop : _props$onSelect,
      _props$onDeselect = props.onDeselect,
      onDeselect = _props$onDeselect === void 0 ? noop : _props$onDeselect,
      _props$onFilterChange = props.onFilterChange,
      onFilterChange = _props$onFilterChange === void 0 ? noop : _props$onFilterChange,
      hasFilter = props.hasFilter,
      _props$selected = props.selected,
      selected = _props$selected === void 0 ? [] : _props$selected,
      optionsFilter = props.optionsFilter,
      isMultiSelect = props.isMultiSelect,
      height = props.height,
      width = props.width,
      _props$renderItem = props.renderItem,
      _renderItem = _props$renderItem === void 0 ? defaultRenderItem : _props$renderItem,
      _props$filterPlacehol = props.filterPlaceholder,
      filterPlaceholder = _props$filterPlacehol === void 0 ? 'Filter...' : _props$filterPlacehol,
      _props$filterIcon = props.filterIcon,
      filterIcon = _props$filterIcon === void 0 ? SearchIcon : _props$filterIcon,
      _props$defaultSearchV = props.defaultSearchValue,
      defaultSearchValue = _props$defaultSearchV === void 0 ? '' : _props$defaultSearchV,
      rest = _objectWithoutProperties(props, _excluded);

  var _useState = useState(defaultSearchValue),
      _useState2 = _slicedToArray(_useState, 2),
      searchValue = _useState2[0],
      setSearchValue = _useState2[1];

  var _useState3 = useState(null),
      _useState4 = _slicedToArray(_useState3, 2),
      searchRef = _useState4[0],
      setSearchRef = _useState4[1];

  var requestId = useRef();
  var theme = useTheme();
  var tokens = theme.tokens;
  var isSelected = useCallback(function (item) {
    return Boolean(selected.find(function (selectedItem) {
      return selectedItem === item.value;
    }));
  }, [selected]);
  var optionLabels = useMemo(function () {
    return originalOptions.map(function (item) {
      return item.label;
    });
  }, [originalOptions]); // Gets filtered options any time the filter fn, value, or options change

  var options = useMemo(function () {
    if (searchValue.trim() === '') {
      return originalOptions;
    } // Preserve backwards compatibility with allowing custom filters, which accept array of strings


    if (typeof optionsFilter === 'function') {
      return optionsFilter(optionLabels, searchValue).map(function (name) {
        return originalOptions.find(function (item) {
          return item.label === name;
        });
      });
    }

    return fuzzyFilter(originalOptions, searchValue, {
      key: 'label'
    });
  }, [originalOptions, optionLabels, optionsFilter, searchValue]);
  var getCurrentIndex = useCallback(function () {
    return options.findIndex(function (option) {
      return option.value === selected[selected.length - 1];
    });
  }, [selected, options]);
  var handleArrowUp = useCallback(function () {
    var nextIndex = getCurrentIndex() - 1;

    if (nextIndex < 0) {
      nextIndex = options.length - 1;
    }

    if (isSelected(options[nextIndex])) {
      return;
    }

    onSelect(options[nextIndex]);
  }, [onSelect, options, getCurrentIndex, isSelected]);
  var handleArrowDown = useCallback(function () {
    var nextIndex = getCurrentIndex() + 1;

    if (nextIndex === options.length) {
      nextIndex = 0;
    }

    if (!isSelected(options[nextIndex])) {
      onSelect(options[nextIndex]);
    }
  }, [onSelect, options, getCurrentIndex, isSelected]);
  var handleChange = useCallback(function (searchValue) {
    setSearchValue(searchValue);
    onFilterChange(searchValue);
  }, [onFilterChange]);
  var handleSelect = useCallback(function (item) {
    if (isSelected(item) && isMultiSelect) {
      onDeselect(item);
    } else {
      onSelect(item);
    }

    if (!isMultiSelect && closeOnSelect) {
      close();
    }
  }, [onDeselect, isMultiSelect, closeOnSelect, onSelect, isSelected, close]);
  var handleEnter = useCallback(function () {
    var isSelected = getCurrentIndex() !== -1;

    if (isSelected) {
      if (!isMultiSelect && closeOnSelect) {
        close();
      }
    }
  }, [isMultiSelect, close, closeOnSelect, getCurrentIndex]);
  var handleDeselect = useCallback(function (item) {
    onDeselect(item);
  }, [onDeselect]);
  var handleKeyDown = useCallback(function (e) {
    if (e.key === 'ArrowUp') {
      handleArrowUp();
    }

    if (e.key === 'ArrowDown') {
      handleArrowDown();
    }

    if (e.key === 'Enter') {
      handleEnter();
    }

    if (e.key === 'Escape') {
      close();
    }
  }, [close, handleArrowUp, handleArrowDown, handleEnter]);
  useEffect(function () {
    if (hasFilter) {
      requestId.current = requestAnimationFrame(function () {
        if (searchRef) {
          searchRef.focus();
        }
      });
      window.addEventListener('keydown', handleKeyDown);
      return function () {
        cancelAnimationFrame(requestId.current);
        window.removeEventListener('keydown', handleKeyDown);
      };
    }
  }, [hasFilter, searchRef, handleKeyDown]);
  var listHeight = height - (hasFilter ? 32 : 0);
  var currentIndex = getCurrentIndex();
  var scrollToIndex = currentIndex === -1 ? 0 : currentIndex;
  return /*#__PURE__*/React.createElement(Pane, _extends({
    height: height,
    width: width,
    display: "flex",
    flexDirection: "column"
  }, rest), hasFilter && /*#__PURE__*/React.createElement(TableHead, {
    height: 32,
    backgroundColor: tokens.colors.gray50
  }, /*#__PURE__*/React.createElement(SearchTableHeaderCell, {
    onChange: handleChange,
    ref: setSearchRef,
    borderRight: null,
    placeholder: filterPlaceholder,
    icon: filterIcon
  })), /*#__PURE__*/React.createElement(Pane, {
    flex: 1
  }, options.length > 0 && /*#__PURE__*/React.createElement(VirtualList, {
    height: listHeight,
    width: "100%",
    itemSize: optionSize,
    itemCount: options.length,
    overscanCount: 20,
    scrollToAlignment: "auto",
    scrollToIndex: scrollToIndex || undefined,
    renderItem: function renderItem(_ref2) {
      var index = _ref2.index,
          style = _ref2.style;
      var item = options[index];
      var isItemSelected = isSelected(item);
      var itemProps = {
        key: item.value,
        label: item.label,
        icon: item.icon,
        item: item,
        style: style,
        height: optionSize,
        onSelect: function onSelect() {
          return handleSelect(item);
        },
        onDeselect: function onDeselect() {
          return handleDeselect(item);
        },
        isSelectable: !isItemSelected || isMultiSelect,
        isSelected: isItemSelected,
        disabled: item.disabled,
        tabIndex: 0
      };
      return _renderItem(itemProps);
    }
  })));
});
OptionsList.propTypes = {
  options: PropTypes.arrayOf(OptionShapePropType),
  close: PropTypes.func,
  height: PropTypes.number,
  width: PropTypes.number,

  /**
   * When true, multi select is accounted for.
   */
  isMultiSelect: PropTypes.bool,

  /**
   * When true, menu closes on option selection.
   */
  closeOnSelect: PropTypes.bool,

  /**
   * This holds the values of the options
   */
  selected: PropTypes.arrayOf(PropTypes.oneOfType([PropTypes.string, PropTypes.number])),
  onSelect: PropTypes.func,
  onDeselect: PropTypes.func,
  onFilterChange: PropTypes.func,
  hasFilter: PropTypes.bool,
  optionSize: PropTypes.number,
  renderItem: PropTypes.func,
  filterPlaceholder: PropTypes.string,
  filterIcon: PropTypes.oneOfType([PropTypes.elementType, PropTypes.element]),
  optionsFilter: PropTypes.func,
  defaultSearchValue: PropTypes.string
};
export default OptionsList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZWxlY3QtbWVudS9zcmMvT3B0aW9uc0xpc3QuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJtZW1vIiwidXNlQ2FsbGJhY2siLCJ1c2VFZmZlY3QiLCJ1c2VNZW1vIiwidXNlUmVmIiwidXNlU3RhdGUiLCJWaXJ0dWFsTGlzdCIsImZ1enphbGRyaW4iLCJQcm9wVHlwZXMiLCJTZWFyY2hJY29uIiwiSW1hZ2UiLCJQYW5lIiwiU2VhcmNoVGFibGVIZWFkZXJDZWxsIiwiVGFibGVIZWFkIiwidXNlVGhlbWUiLCJPcHRpb24iLCJPcHRpb25TaGFwZVByb3BUeXBlIiwiZnV6enlGaWx0ZXIiLCJvcHRpb25zIiwiaW5wdXQiLCJrZXkiLCJmaWx0ZXIiLCJub29wIiwiZGVmYXVsdFJlbmRlckl0ZW0iLCJwcm9wcyIsImljb24iLCJsYWJlbCIsIk9wdGlvbnNMaXN0Iiwib3JpZ2luYWxPcHRpb25zIiwib3B0aW9uU2l6ZSIsImNsb3NlIiwiY2xvc2VPblNlbGVjdCIsIm9uU2VsZWN0Iiwib25EZXNlbGVjdCIsIm9uRmlsdGVyQ2hhbmdlIiwiaGFzRmlsdGVyIiwic2VsZWN0ZWQiLCJvcHRpb25zRmlsdGVyIiwiaXNNdWx0aVNlbGVjdCIsImhlaWdodCIsIndpZHRoIiwicmVuZGVySXRlbSIsImZpbHRlclBsYWNlaG9sZGVyIiwiZmlsdGVySWNvbiIsImRlZmF1bHRTZWFyY2hWYWx1ZSIsInJlc3QiLCJzZWFyY2hWYWx1ZSIsInNldFNlYXJjaFZhbHVlIiwic2VhcmNoUmVmIiwic2V0U2VhcmNoUmVmIiwicmVxdWVzdElkIiwidGhlbWUiLCJ0b2tlbnMiLCJpc1NlbGVjdGVkIiwiaXRlbSIsIkJvb2xlYW4iLCJmaW5kIiwic2VsZWN0ZWRJdGVtIiwidmFsdWUiLCJvcHRpb25MYWJlbHMiLCJtYXAiLCJ0cmltIiwibmFtZSIsImdldEN1cnJlbnRJbmRleCIsImZpbmRJbmRleCIsIm9wdGlvbiIsImxlbmd0aCIsImhhbmRsZUFycm93VXAiLCJuZXh0SW5kZXgiLCJoYW5kbGVBcnJvd0Rvd24iLCJoYW5kbGVDaGFuZ2UiLCJoYW5kbGVTZWxlY3QiLCJoYW5kbGVFbnRlciIsImhhbmRsZURlc2VsZWN0IiwiaGFuZGxlS2V5RG93biIsImUiLCJjdXJyZW50IiwicmVxdWVzdEFuaW1hdGlvbkZyYW1lIiwiZm9jdXMiLCJ3aW5kb3ciLCJhZGRFdmVudExpc3RlbmVyIiwiY2FuY2VsQW5pbWF0aW9uRnJhbWUiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwibGlzdEhlaWdodCIsImN1cnJlbnRJbmRleCIsInNjcm9sbFRvSW5kZXgiLCJjb2xvcnMiLCJncmF5NTAiLCJ1bmRlZmluZWQiLCJpbmRleCIsInN0eWxlIiwiaXNJdGVtU2VsZWN0ZWQiLCJpdGVtUHJvcHMiLCJpc1NlbGVjdGFibGUiLCJkaXNhYmxlZCIsInRhYkluZGV4IiwicHJvcFR5cGVzIiwiYXJyYXlPZiIsImZ1bmMiLCJudW1iZXIiLCJib29sIiwib25lT2ZUeXBlIiwic3RyaW5nIiwiZWxlbWVudFR5cGUiLCJlbGVtZW50Il0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsT0FBT0EsS0FBUCxJQUFnQkMsSUFBaEIsRUFBc0JDLFdBQXRCLEVBQW1DQyxTQUFuQyxFQUE4Q0MsT0FBOUMsRUFBdURDLE1BQXZELEVBQStEQyxRQUEvRCxRQUErRSxPQUEvRTtBQUNBLE9BQU9DLFdBQVAsTUFBd0Isa0NBQXhCO0FBQ0EsT0FBT0MsVUFBUCxNQUF1QixpQkFBdkI7QUFDQSxPQUFPQyxTQUFQLE1BQXNCLFlBQXRCO0FBQ0EsU0FBU0MsVUFBVCxRQUEyQixhQUEzQjtBQUNBLFNBQVNDLEtBQVQsUUFBc0IsYUFBdEI7QUFDQSxTQUFTQyxJQUFULFFBQXFCLGNBQXJCO0FBQ0EsT0FBT0MscUJBQVAsTUFBa0MsdUNBQWxDO0FBQ0EsT0FBT0MsU0FBUCxNQUFzQiwyQkFBdEI7QUFDQSxTQUFTQyxRQUFULFFBQXlCLGFBQXpCO0FBQ0EsT0FBT0MsTUFBUCxNQUFtQixVQUFuQjtBQUNBLE9BQU9DLG1CQUFQLE1BQWdDLHVC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RCxFQUFBQSxrQkFBa0IsRUFBRXBDLFNBQVMsQ0FBQzhGO0FBN0JSLENBQXhCO0FBZ0NBLGVBQWUzRSxXQUFmIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IG1lbW8sIHVzZUNhbGxiYWNrLCB1c2VFZmZlY3QsIHVzZU1lbW8sIHVzZVJlZiwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBWaXJ0dWFsTGlzdCBmcm9tICdAc2VnbWVudC9yZWFjdC10aW55LXZpcnR1YWwtbGlzdCdcbmltcG9ydCBmdXp6YWxkcmluIGZyb20gJ2Z1enphbGRyaW4tcGx1cydcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCB7IFNlYXJjaEljb24gfSBmcm9tICcuLi8uLi9pY29ucydcbmltcG9ydCB7IEltYWdlIH0gZnJvbSAnLi4vLi4vaW1hZ2UnXG5pbXBvcnQgeyBQYW5lIH0gZnJvbSAnLi4vLi4vbGF5ZXJzJ1xuaW1wb3J0IFNlYXJjaFRhYmxlSGVhZGVyQ2VsbCBmcm9tICcuLi8uLi90YWJsZS9zcmMvU2VhcmNoVGFibGVIZWFkZXJDZWxsJ1xuaW1wb3J0IFRhYmxlSGVhZCBmcm9tICcuLi8uLi90YWJsZS9zcmMvVGFibGVIZWFkJ1xuaW1wb3J0IHsgdXNlVGhlbWUgfSBmcm9tICcuLi8uLi90aGVtZSdcbmltcG9ydCBPcHRpb24gZnJvbSAnLi9PcHRpb24nXG5pbXBvcnQgT3B0aW9uU2hhcGVQcm9wVHlwZSBmcm9tICcuL09wdGlvblNoYXBlUHJvcFR5cGUnXG5cbi8qKlxuICogRnV6emFsZHJpbi1wbHVzIGlzIHRoZSBkZWZhdWx0IGZpbHRlciwgYnV0IHlvdSBjYW4gdXNlIHlvdXIgb3duXG4gKiBhcyBsb25nIGFzIHRoZXkgZm9sbG93IHRoZSBmb2xsb3dpbmcgc2lnbmF0dXJlOlxuICogQHBhcmFtIG9wdGlvbnMgPEFycmF5W1N0cmluZ10+IC0gWydsYWJlbCcsICdsYWJlbDInLCAuLi5dXG4gKiBAcGFyYW0gaW5wdXQgPFN0cmluZz5cbiAqL1xuY29uc3QgZnV6enlGaWx0ZXIgPSAob3B0aW9ucywgaW5wdXQsIHsga2V5IH0pID0+IHtcbiAgcmV0dXJuIGZ1enphbGRyaW4uZmlsdGVyKG9wdGlvbnMsIGlucHV0LCB7IGtleSB9KVxufVxuXG5jb25zdCBub29wID0gKCkgPT4ge31cblxuY29uc3QgZGVmYXVsdFJlbmRlckl0ZW0gPSBwcm9wcyA9PiB7XG4gIHJldHVybiAoXG4gICAgPE9wdGlvbiB7Li4ucHJvcHN9PlxuICAgICAge3Byb3BzLmljb24gJiYgPEltYWdlIHNyYz17cHJvcHMuaWNvbn0gd2lkdGg9ezI0fSBtYXJnaW5SaWdodD17OH0gLz59XG4gICAgICB7cHJvcHMubGFiZWx9XG4gICAgPC9PcHRpb24+XG4gIClcbn1cblxuY29uc3QgT3B0aW9uc0xpc3QgPSBtZW1vKGZ1bmN0aW9uIE9wdGlvbnNMaXN0KHByb3BzKSB7XG4gIGNvbnN0IHtcbiAgICBvcHRpb25zOiBvcmlnaW5hbE9wdGlvbnMgPSBbXSxcbiAgICBvcHRpb25TaXplID0gMzMsXG4gICAgY2xvc2UsXG4gICAgY2xvc2VPblNlbGVjdCxcbiAgICBvblNlbGVjdCA9IG5vb3AsXG4gICAgb25EZXNlbGVjdCA9IG5vb3AsXG4gICAgb25GaWx0ZXJDaGFuZ2UgPSBub29wLFxuICAgIGhhc0ZpbHRlcixcbiAgICBzZWxlY3RlZCA9IFtdLFxuICAgIG9wdGlvbnNGaWx0ZXIsXG4gICAgaXNNdWx0aVNlbGVjdCxcbiAgICBoZWlnaHQsXG4gICAgd2lkdGgsXG4gICAgcmVuZGVySXRlbSA9IGRlZmF1bHRSZW5kZXJJdGVtLFxuICAgIGZpbHRlclBsYWNlaG9sZGVyID0gJ0ZpbHRlci4uLicsXG4gICAgZmlsdGVySWNvbiA9IFNlYXJjaEljb24sXG4gICAgZGVmYXVsdFNlYXJjaFZhbHVlID0gJycsXG4gICAgLi4ucmVzdFxuICB9ID0gcHJvcHNcblxuICBjb25zdCBbc2VhcmNoVmFsdWUsIHNldFNlYXJjaFZhbHVlXSA9IHVzZVN0YXRlKGRlZmF1bHRTZWFyY2hWYWx1ZSlcbiAgY29uc3QgW3NlYXJjaFJlZiwgc2V0U2VhcmNoUmVmXSA9IHVzZVN0YXRlKG51bGwpXG4gIGNvbnN0IHJlcXVlc3RJZCA9IHVzZVJlZigpXG4gIGNvbnN0IHRoZW1lID0gdXNlVGhlbWUoKVxuICBjb25zdCB7IHRva2VucyB9ID0gdGhlbWVcblxuICBjb25zdCBpc1NlbGVjdGVkID0gdXNlQ2FsbGJhY2soXG4gICAgaXRlbSA9PiB7XG4gICAgICByZXR1cm4gQm9vbGVhbihzZWxlY3RlZC5maW5kKHNlbGVjdGVkSXRlbSA9PiBzZWxlY3RlZEl0ZW0gPT09IGl0ZW0udmFsdWUpKVxuICAgIH0sXG4gICAgW3NlbGVjdGVkXVxuICApXG5cbiAgY29uc3Qgb3B0aW9uTGFiZWxzID0gdXNlTWVtbygoKSA9PiB7XG4gICAgcmV0dXJuIG9yaWdpbmFsT3B0aW9ucy5tYXAoaXRlbSA9PiBpdGVtLmxhYmVsKVxuICB9LCBbb3JpZ2luYWxPcHRpb25zXSlcblxuICAvLyBHZXRzIGZpbHRlcmVkIG9wdGlvbnMgYW55IHRpbWUgdGhlIGZpbHRlciBmbiwgdmFsdWUsIG9yIG9wdGlvbnMgY2hhbmdlXG4gIGNvbnN0IG9wdGlvbnMgPSB1c2VNZW1vKCgpID0+IHtcbiAgICBpZiAoc2VhcmNoVmFsdWUudHJpbSgpID09PSAnJykge1xuICAgICAgcmV0dXJuIG9yaWdpbmFsT3B0aW9uc1xuICAgIH1cblxuICAgIC8vIFByZXNlcnZlIGJhY2t3YXJkcyBjb21wYXRpYmlsaXR5IHdpdGggYWxsb3dpbmcgY3VzdG9tIGZpbHRlcnMsIHdoaWNoIGFjY2VwdCBhcnJheSBvZiBzdHJpbmdzXG4gICAgaWYgKHR5cGVvZiBvcHRpb25zRmlsdGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gb3B0aW9uc0ZpbHRlcihvcHRpb25MYWJlbHMsIHNlYXJjaFZhbHVlKS5tYXAobmFtZSA9PiB7XG4gICAgICAgIHJldHVybiBvcmlnaW5hbE9wdGlvbnMuZmluZChpdGVtID0+IGl0ZW0ubGFiZWwgPT09IG5hbWUpXG4gICAgICB9KVxuICAgIH1cblxuICAgIHJldHVybiBmdXp6eUZpbHRlcihvcmlnaW5hbE9wdGlvbnMsIHNlYXJjaFZhbHVlLCB7IGtleTogJ2xhYmVsJyB9KVxuICB9LCBbb3JpZ2luYWxPcHRpb25zLCBvcHRpb25MYWJlbHMsIG9wdGlvbnNGaWx0ZXIsIHNlYXJjaFZhbHVlXSlcblxuICBjb25zdCBnZXRDdXJyZW50SW5kZXggPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgcmV0dXJuIG9wdGlvbnMuZmluZEluZGV4KG9wdGlvbiA9PiBvcHRpb24udmFsdWUgPT09IHNlbGVjdGVkW3NlbGVjdGVkLmxlbmd0aCAtIDFdKVxuICB9LCBbc2VsZWN0ZWQsIG9wdGlvbnNdKVxuXG4gIGNvbnN0IGhhbmRsZUFycm93VXAgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgbGV0IG5leHRJbmRleCA9IGdldEN1cnJlbnRJbmRleCgpIC0gMVxuXG4gICAgaWYgKG5leHRJbmRleCA8IDApIHtcbiAgICAgIG5leHRJbmRleCA9IG9wdGlvbnMubGVuZ3RoIC0gMVxuICAgIH1cblxuICAgIGlmIChpc1NlbGVjdGVkKG9wdGlvbnNbbmV4dEluZGV4XSkpIHtcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIG9uU2VsZWN0KG9wdGlvbnNbbmV4dEluZGV4XSlcbiAgfSwgW29uU2VsZWN0LCBvcHRpb25zLCBnZXRDdXJyZW50SW5kZXgsIGlzU2VsZWN0ZWRdKVxuXG4gIGNvbnN0IGhhbmRsZUFycm93RG93biA9IHVzZUNhbGxiYWNrKCgpID0+IHtcbiAgICBsZXQgbmV4dEluZGV4ID0gZ2V0Q3VycmVudEluZGV4KCkgKyAxXG5cbiAgICBpZiAobmV4dEluZGV4ID09PSBvcHRpb25zLmxlbmd0aCkge1xuICAgICAgbmV4dEluZGV4ID0gMFxuICAgIH1cblxuICAgIGlmICghaXNTZWxlY3RlZChvcHRpb25zW25leHRJbmRleF0pKSB7XG4gICAgICBvblNlbGVjdChvcHRpb25zW25leHRJbmRleF0pXG4gICAgfVxuICB9LCBbb25TZWxlY3QsIG9wdGlvbnMsIGdldEN1cnJlbnRJbmRleCwgaXNTZWxlY3RlZF0pXG5cbiAgY29uc3QgaGFuZGxlQ2hhbmdlID0gdXNlQ2FsbGJhY2soXG4gICAgc2VhcmNoVmFsdWUgPT4ge1xuICAgICAgc2V0U2VhcmNoVmFsdWUoc2VhcmNoVmFsdWUpXG4gICAgICBvbkZpbHRlckNoYW5nZShzZWFyY2hWYWx1ZSlcbiAgICB9LFxuICAgIFtvbkZpbHRlckNoYW5nZV1cbiAgKVxuXG4gIGNvbnN0IGhhbmRsZVNlbGVjdCA9IHVzZUNhbGxiYWNrKFxuICAgIGl0ZW0gPT4ge1xuICAgICAgaWYgKGlzU2VsZWN0ZWQoaXRlbSkgJiYgaXNNdWx0aVNlbGVjdCkge1xuICAgICAgICBvbkRlc2VsZWN0KGl0ZW0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvblNlbGVjdChpdGVtKVxuICAgICAgfVxuXG4gICAgICBpZiAoIWlzTXVsdGlTZWxlY3QgJiYgY2xvc2VPblNlbGVjdCkge1xuICAgICAgICBjbG9zZSgpXG4gICAgICB9XG4gICAgfSxcbiAgICBbb25EZXNlbGVjdCwgaXNNdWx0aVNlbGVjdCwgY2xvc2VPblNlbGVjdCwgb25TZWxlY3QsIGlzU2VsZWN0ZWQsIGNsb3NlXVxuICApXG5cbiAgY29uc3QgaGFuZGxlRW50ZXIgPSB1c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgY29uc3QgaXNTZWxlY3RlZCA9IGdldEN1cnJlbnRJbmRleCgpICE9PSAtMVxuXG4gICAgaWYgKGlzU2VsZWN0ZWQpIHtcbiAgICAgIGlmICghaXNNdWx0aVNlbGVjdCAmJiBjbG9zZU9uU2VsZWN0KSB7XG4gICAgICAgIGNsb3NlKClcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtpc011bHRpU2VsZWN0LCBjbG9zZSwgY2xvc2VPblNlbGVjdCwgZ2V0Q3VycmVudEluZGV4XSlcblxuICBjb25zdCBoYW5kbGVEZXNlbGVjdCA9IHVzZUNhbGxiYWNrKFxuICAgIGl0ZW0gPT4ge1xuICAgICAgb25EZXNlbGVjdChpdGVtKVxuICAgIH0sXG4gICAgW29uRGVzZWxlY3RdXG4gIClcblxuICBjb25zdCBoYW5kbGVLZXlEb3duID0gdXNlQ2FsbGJhY2soXG4gICAgZSA9PiB7XG4gICAgICBpZiAoZS5rZXkgPT09ICdBcnJvd1VwJykge1xuICAgICAgICBoYW5kbGVBcnJvd1VwKClcbiAgICAgIH1cblxuICAgICAgaWYgKGUua2V5ID09PSAnQXJyb3dEb3duJykge1xuICAgICAgICBoYW5kbGVBcnJvd0Rvd24oKVxuICAgICAgfVxuXG4gICAgICBpZiAoZS5rZXkgPT09ICdFbnRlcicpIHtcbiAgICAgICAgaGFuZGxlRW50ZXIoKVxuICAgICAgfVxuXG4gICAgICBpZiAoZS5rZXkgPT09ICdFc2NhcGUnKSB7XG4gICAgICAgIGNsb3NlKClcbiAgICAgIH1cbiAgICB9LFxuICAgIFtjbG9zZSwgaGFuZGxlQXJyb3dVcCwgaGFuZGxlQXJyb3dEb3duLCBoYW5kbGVFbnRlcl1cbiAgKVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGhhc0ZpbHRlcikge1xuICAgICAgcmVxdWVzdElkLmN1cnJlbnQgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICBpZiAoc2VhcmNoUmVmKSB7XG4gICAgICAgICAgc2VhcmNoUmVmLmZvY3VzKClcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBoYW5kbGVLZXlEb3duKVxuICAgICAgcmV0dXJuICgpID0+IHtcbiAgICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWUocmVxdWVzdElkLmN1cnJlbnQpXG4gICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgaGFuZGxlS2V5RG93bilcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtoYXNGaWx0ZXIsIHNlYXJjaFJlZiwgaGFuZGxlS2V5RG93bl0pXG5cbiAgY29uc3QgbGlzdEhlaWdodCA9IGhlaWdodCAtIChoYXNGaWx0ZXIgPyAzMiA6IDApXG4gIGNvbnN0IGN1cnJlbnRJbmRleCA9IGdldEN1cnJlbnRJbmRleCgpXG4gIGNvbnN0IHNjcm9sbFRvSW5kZXggPSBjdXJyZW50SW5kZXggPT09IC0xID8gMCA6IGN1cnJlbnRJbmRleFxuXG4gIHJldHVybiAoXG4gICAgPFBhbmUgaGVpZ2h0PXtoZWlnaHR9IHdpZHRoPXt3aWR0aH0gZGlzcGxheT1cImZsZXhcIiBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCIgey4uLnJlc3R9PlxuICAgICAge2hhc0ZpbHRlciAmJiAoXG4gICAgICAgIDxUYWJsZUhlYWQgaGVpZ2h0PXszMn0gYmFja2dyb3VuZENvbG9yPXt0b2tlbnMuY29sb3JzLmdyYXk1MH0+XG4gICAgICAgICAgPFNlYXJjaFRhYmxlSGVhZGVyQ2VsbFxuICAgICAgICAgICAgb25DaGFuZ2U9e2hhbmRsZUNoYW5nZX1cbiAgICAgICAgICAgIHJlZj17c2V0U2VhcmNoUmVmfVxuICAgICAgICAgICAgYm9yZGVyUmlnaHQ9e251bGx9XG4gICAgICAgICAgICBwbGFjZWhvbGRlcj17ZmlsdGVyUGxhY2Vob2xkZXJ9XG4gICAgICAgICAgICBpY29uPXtmaWx0ZXJJY29ufVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvVGFibGVIZWFkPlxuICAgICAgKX1cbiAgICAgIDxQYW5lIGZsZXg9ezF9PlxuICAgICAgICB7b3B0aW9ucy5sZW5ndGggPiAwICYmIChcbiAgICAgICAgICA8VmlydHVhbExpc3RcbiAgICAgICAgICAgIGhlaWdodD17bGlzdEhlaWdodH1cbiAgICAgICAgICAgIHdpZHRoPVwiMTAwJVwiXG4gICAgICAgICAgICBpdGVtU2l6ZT17b3B0aW9uU2l6ZX1cbiAgICAgICAgICAgIGl0ZW1Db3VudD17b3B0aW9ucy5sZW5ndGh9XG4gICAgICAgICAgICBvdmVyc2NhbkNvdW50PXsyMH1cbiAgICAgICAgICAgIHNjcm9sbFRvQWxpZ25tZW50PVwiYXV0b1wiXG4gICAgICAgICAgICBzY3JvbGxUb0luZGV4PXtzY3JvbGxUb0luZGV4IHx8IHVuZGVmaW5lZH1cbiAgICAgICAgICAgIHJlbmRlckl0ZW09eyh7IGluZGV4LCBzdHlsZSB9KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBvcHRpb25zW2luZGV4XVxuICAgICAgICAgICAgICBjb25zdCBpc0l0ZW1TZWxlY3RlZCA9IGlzU2VsZWN0ZWQoaXRlbSlcblxuICAgICAgICAgICAgICBjb25zdCBpdGVtUHJvcHMgPSB7XG4gICAgICAgICAgICAgICAga2V5OiBpdGVtLnZhbHVlLFxuICAgICAgICAgICAgICAgIGxhYmVsOiBpdGVtLmxhYmVsLFxuICAgICAgICAgICAgICAgIGljb246IGl0ZW0uaWNvbixcbiAgICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICAgIHN0eWxlLFxuICAgICAgICAgICAgICAgIGhlaWdodDogb3B0aW9uU2l6ZSxcbiAgICAgICAgICAgICAgICBvblNlbGVjdDogKCkgPT4gaGFuZGxlU2VsZWN0KGl0ZW0pLFxuICAgICAgICAgICAgICAgIG9uRGVzZWxlY3Q6ICgpID0+IGhhbmRsZURlc2VsZWN0KGl0ZW0pLFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0YWJsZTogIWlzSXRlbVNlbGVjdGVkIHx8IGlzTXVsdGlTZWxlY3QsXG4gICAgICAgICAgICAgICAgaXNTZWxlY3RlZDogaXNJdGVtU2VsZWN0ZWQsXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6IGl0ZW0uZGlzYWJsZWQsXG4gICAgICAgICAgICAgICAgdGFiSW5kZXg6IDBcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHJldHVybiByZW5kZXJJdGVtKGl0ZW1Qcm9wcylcbiAgICAgICAgICAgIH19XG4gICAgICAgICAgLz5cbiAgICAgICAgKX1cbiAgICAgIDwvUGFuZT5cbiAgICA8L1BhbmU+XG4gIClcbn0pXG5cbk9wdGlvbnNMaXN0LnByb3BUeXBlcyA9IHtcbiAgb3B0aW9uczogUHJvcFR5cGVzLmFycmF5T2YoT3B0aW9uU2hhcGVQcm9wVHlwZSksXG4gIGNsb3NlOiBQcm9wVHlwZXMuZnVuYyxcbiAgaGVpZ2h0OiBQcm9wVHlwZXMubnVtYmVyLFxuICB3aWR0aDogUHJvcFR5cGVzLm51bWJlcixcblxuICAvKipcbiAgICogV2hlbiB0cnVlLCBtdWx0aSBzZWxlY3QgaXMgYWNjb3VudGVkIGZvci5cbiAgICovXG4gIGlzTXVsdGlTZWxlY3Q6IFByb3BUeXBlcy5ib29sLFxuXG4gIC8qKlxuICAgKiBXaGVuIHRydWUsIG1lbnUgY2xvc2VzIG9uIG9wdGlvbiBzZWxlY3Rpb24uXG4gICAqL1xuICBjbG9zZU9uU2VsZWN0OiBQcm9wVHlwZXMuYm9vbCxcblxuICAvKipcbiAgICogVGhpcyBob2xkcyB0aGUgdmFsdWVzIG9mIHRoZSBvcHRpb25zXG4gICAqL1xuICBzZWxlY3RlZDogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLnN0cmluZywgUHJvcFR5cGVzLm51bWJlcl0pKSxcbiAgb25TZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxuICBvbkRlc2VsZWN0OiBQcm9wVHlwZXMuZnVuYyxcbiAgb25GaWx0ZXJDaGFuZ2U6IFByb3BUeXBlcy5mdW5jLFxuICBoYXNGaWx0ZXI6IFByb3BUeXBlcy5ib29sLFxuICBvcHRpb25TaXplOiBQcm9wVHlwZXMubnVtYmVyLFxuICByZW5kZXJJdGVtOiBQcm9wVHlwZXMuZnVuYyxcbiAgZmlsdGVyUGxhY2Vob2xkZXI6IFByb3BUeXBlcy5zdHJpbmcsXG4gIGZpbHRlckljb246IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5lbGVtZW50VHlwZSwgUHJvcFR5cGVzLmVsZW1lbnRdKSxcbiAgb3B0aW9uc0ZpbHRlcjogUHJvcFR5cGVzLmZ1bmMsXG4gIGRlZmF1bHRTZWFyY2hWYWx1ZTogUHJvcFR5cGVzLnN0cmluZ1xufVxuXG5leHBvcnQgZGVmYXVsdCBPcHRpb25zTGlzdFxuIl19